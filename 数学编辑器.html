%<!DOCTYPE html>
<html lang="zh-CN">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, minimum-scale=0.3, user-scalable=yes">
	<!-- åœ¨headæ ‡ç­¾å†…æ·»åŠ  -->
 	<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
	<title>æ•°å­¦å…¬å¼ç¼–è¾‘å™¨</title>
	<style>
		/* ==================== åŸºç¡€æ ·å¼ ==================== */
		* {
			margin: 0;
			padding: 0;
			box-sizing: border-box;
			-webkit-tap-highlight-color: transparent;
			touch-action: manipulation;
		}
		
		body {
			font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
			background: #f0f0f0;
			height: 100vh;
			overflow: hidden;
			position: fixed;
			width: 100%;
		}
		
		/* ==================== é¡¶éƒ¨å·¥å…·æ  ==================== */
		.header-toolbar {
			display: flex;
			justify-content: space-between;
			align-items: center;
			padding: 8px 12px;
			background: #2196F3;
			color: white;
			height: 56px;
			position: fixed;
			top: 0;
			left: 0;
			right: 0;
			z-index: 1000;
			box-shadow: 0 2px 5px rgba(0,0,0,0.2);
		}
		
		.header-left {
			display: flex;
			gap: 10px;
		}
		
		.header-center {
			font-weight: bold;
			font-size: 16px;
		}
		
		.header-right {
			display: flex;
			gap: 10px;
		}
		
		.tool-btn {
			background: rgba(255,255,255,0.2);
			border: none;
			color: white;
			border-radius: 4px;
			padding: 6px 12px;
			font-size: 14px;
			cursor: pointer;
			display: flex;
			align-items: center;
			gap: 4px;
		}
		
		.tool-btn:active {
			background: rgba(255,255,255,0.3);
		}
		
		.tool-btn.active {
			background: rgba(255,255,255,0.4);
		}
		
		/* ==================== ä¸‹æ‹‰èœå• ==================== */
		.dropdown-menu {
			position: relative;
			display: inline-block;
		}
		
		.dropdown-content {
			display: none;
			position: absolute;
			top: 100%;
			left: 0;
			background-color: white;
			min-width: 160px;
			box-shadow: 0 8px 16px rgba(0,0,0,0.2);
			border-radius: 8px;
			z-index: 1100;
			margin-top: 5px;
			padding: 8px 0;
			border: 1px solid #ddd;
		}
		
		.dropdown-content.show {
			display: block;
		}
		
		.menu-item {
			width: 100%;
			padding: 10px 15px;
			text-align: left;
			border: none;
			background: none;
			cursor: pointer;
			font-size: 14px;
			color: #333;
			display: flex;
			align-items: center;
			gap: 8px;
		}
		
		.menu-item:hover {
			background-color: #f5f5f5;
		}
		
		.dropdown-content hr {
			margin: 5px 0;
			border: none;
			border-top: 1px solid #eee;
		}
		
		/* ==================== ç‰¹æ®Šç¬¦å·æ»‘åŠ¨æ  ==================== */
		.symbols-scroll {
			position: fixed;
			top: 56px;
			left: 0;
			right: 0;
			background: white;
			padding: 8px;
			overflow-x: auto;
			white-space: nowrap;
			border-bottom: 1px solid #ddd;
			height: 50px;
			z-index: 999;
			-webkit-overflow-scrolling: touch;
			display: flex;
			transition: transform 0.3s ease, opacity 0.3s ease;
		}
		
		.symbols-scroll.hidden {
			transform: translateY(-100%);
			opacity: 0;
			pointer-events: none;
		}
		
		.symbol-scroll-container {
			display: inline-flex;
			gap: 8px;
		}
		
		.symbol-btn {
			padding: 8px 12px;
			border: 1px solid #ddd;
			background: white;
			border-radius: 6px;
			font-size: 16px;
			cursor: pointer;
			min-width: 44px;
			text-align: center;
		}
		
		.symbol-btn:active {
			background: #f0f0f0;
		}
		
		/* ==================== é”®ç›˜è¾“å…¥åŒºåŸŸ ==================== */
/* ==================== é”®ç›˜è¾“å…¥åŒºåŸŸï¼ˆè¶…ç´§å‡‘ç‰ˆï¼‰ ==================== */
.keyboard-input-display {
	position: fixed;
	top: 56px;
	left: 0;
	right: 0;
	background: linear-gradient(to right, #2196F3, #1976D2);
	padding: 3px 10px; /* æå°çš„å†…è¾¹è· */
	border-bottom: 1px solid #0D47A1;
	height: auto;
	z-index: 1000;
	display: none;
	flex-direction: column;
	box-shadow: 0 2px 5px rgba(0,0,0,0.2);
}

.keyboard-input-display.show {
	display: flex;
}

.input-textbox {
	flex: 1;
	font-size: 13px; /* è¿›ä¸€æ­¥ç¼©å°å­—ä½“ */
	font-family: "Cambria Math", "Times New Roman", serif;
	background: white;
	padding: 2px 8px; /* æå°çš„å†…è¾¹è·ï¼Œå‚ç›´æ–¹å‘åªå‰©2px */
	border-radius: 3px;
	border: 1px solid #4CAF50; /* è¾¹æ¡†ä¹Ÿç¨å¾®å˜ç»†ä¸€ç‚¹ */
	min-height: 24px; /* é«˜åº¦å‡åŠ */
	color: #000;
	outline: none;
	line-height: 1.2; /* ç´§å‡‘è¡Œé«˜ */
	resize: none;
	width: 100%;
}

.input-controls {
	display: flex;
	gap: 6px;
	margin-top: 3px; /* è¾“å…¥æ¡†å’ŒæŒ‰é’®çš„é—´è·æå° */
	justify-content: flex-end;
}

.input-btn {
	padding: 1px 8px; /* æŒ‰é’®é«˜åº¦æä½ */
	border: none;
	border-radius: 2px; /* åœ†è§’æå° */
	font-size: 11px; /* å­—ä½“æ›´å° */
	font-weight: normal; /* ä¸åŠ ç²—ä»¥èŠ‚çœè§†è§‰ç©ºé—´ */
	cursor: pointer;
	min-width: 40px;
	transition: all 0.1s;
}

.input-btn:active {
	transform: scale(0.95);
	background: rgba(0,0,0,0.1);
}

.input-btn.confirm {
	background: #4CAF50;
	color: white;
}

.input-btn.cancel {
	background: #f44336;
	color: white;
}
		
		/* ==================== å­—ä½“æ§åˆ¶é¢æ¿ ==================== */
		.font-controls {
			position: fixed;
			top: 56px;
			right: 10px;
			background: white;
			border-radius: 10px;
			padding: 15px;
			box-shadow: 0 2px 15px rgba(0,0,0,0.2);
			display: none;
			flex-direction: column;
			gap: 12px;
			z-index: 1001;
			width: 200px;
		}
		
		.font-controls.show {
			display: flex;
		}
		
		.font-slider {
			width: 100%;
			height: 5px;
			background: #ddd;
			border-radius: 3px;
			outline: none;
		}
		
		.font-preset-container {
			display: flex;
			gap: 8px;
			margin-top: 10px;
		}
		
		.font-preset-btn {
			flex: 1;
			padding: 8px 10px;
			border: 1px solid #ddd;
			background: #f8f9fa;
			border-radius: 4px;
			font-size: 12px;
			cursor: pointer;
			text-align: center;
			transition: all 0.2s;
			position: relative;
		}
		
		.font-preset-btn:hover {
			background: #e9ecef;
			border-color: #2196F3;
		}
		
		.font-preset-btn.active {
			background: #2196F3;
			color: white;
			border-color: #2196F3;
		}
		
		.font-preset-badge {
			position: absolute;
			top: -5px;
			right: -5px;
			background: #FF9800;
			color: white;
			font-size: 10px;
			padding: 2px 5px;
			border-radius: 10px;
			min-width: 20px;
			text-align: center;
		}
		
		/* æ·»åŠ åˆ°ç°æœ‰CSSä¸­ */
		.status-tip.brief {
			bottom: 150px;
			background: rgba(33, 150, 243, 0.9);
			font-size: 12px;
			padding: 6px 12px;
		}
		
		
		
		/* ==================== å¯¹é½æ§åˆ¶é¢æ¿ ==================== */
		.align-controls {
			position: fixed;
			top: 56px;
			right: 10px;
			background: white;
			border-radius: 10px;
			padding: 15px;
			box-shadow: 0 2px 15px rgba(0,0,0,0.2);
			display: none;
			flex-direction: column;
			gap: 12px;
			z-index: 1001;
			width: 220px;
		}
		
		.align-controls.show {
			display: flex;
		}
		
		.align-option {
			display: flex;
			align-items: center;
			gap: 8px;
		}
		
		.checkbox-label {
			display: flex;
			align-items: center;
			gap: 8px;
			cursor: pointer;
			font-size: 14px;
			color: #333;
		}
		
		.checkbox-label input[type="checkbox"] {
			width: 16px;
			height: 16px;
			cursor: pointer;
		}
		
		.align-slider {
			width: 100%;
			height: 5px;
			background: #ddd;
			border-radius: 3px;
			outline: none;
		}
		
		.precision-preset-container {
			display: flex;
			gap: 8px;
			margin-top: 5px;
		}
		
		.precision-preset-btn {
			flex: 1;
			padding: 6px 8px;
			border: 1px solid #ddd;
			background: #f8f9fa;
			border-radius: 4px;
			font-size: 12px;
			cursor: pointer;
			text-align: center;
			transition: all 0.2s;
		}
		
		.precision-preset-btn:hover {
			background: #e9ecef;
			border-color: #2196F3;
		}
		
		.precision-preset-btn.active {
			background: #2196F3;
			color: white;
			border-color: #2196F3;
		}
		
		/* ==================== å¾®è°ƒæ§åˆ¶é¢æ¿ï¼ˆå·¦ä¸‹è§’ï¼‰ ==================== */
		.nudge-panel {
			position: fixed;
			left: 10px;
			bottom: 70px;
			background: white;
			border-radius: 10px;
			padding: 15px;
			box-shadow: 0 2px 15px rgba(0,0,0,0.2);
			display: none;
			z-index: 1001;
			width: 220px;
		}
		
		.nudge-panel.show {
			display: block;
		}
		
		.nudge-controls {
			display: flex;
			flex-direction: column;
			gap: 12px;
		}
		
		.nudge-slider {
			width: 100%;
			height: 5px;
			background: #ddd;
			border-radius: 3px;
			outline: none;
		}
		
		.nudge-preset-container {
			display: flex;
			gap: 8px;
			margin-top: 5px;
			margin-bottom: 15px;
		}
		
		.nudge-preset-btn {
			flex: 1;
			padding: 6px 8px;
			border: 1px solid #ddd;
			background: #f8f9fa;
			border-radius: 4px;
			font-size: 12px;
			cursor: pointer;
			text-align: center;
			transition: all 0.2s;
		}
		
		.nudge-preset-btn:hover {
			background: #e9ecef;
			border-color: #4CAF50;
		}
		
		.nudge-preset-btn.active {
			background: #4CAF50;
			color: white;
			border-color: #4CAF50;
		}
		
		.nudge-direction-grid {
			display: grid;
			grid-template-columns: repeat(3, 50px);
			grid-template-rows: repeat(3, 50px);
			gap: 8px;
			margin: 0 auto;
		}
		
		.nudge-direction-btn {
			border: 2px solid #4CAF50;
			background: white;
			border-radius: 8px;
			font-size: 24px;
			color: #4CAF50;
			cursor: pointer;
			display: flex;
			align-items: center;
			justify-content: center;
			transition: all 0.2s;
		}
		
		.nudge-direction-btn:hover {
			background: #4CAF50;
			color: white;
		}
		
		.nudge-center {
			grid-column: 2;
			grid-row: 2;
			display: flex;
			align-items: center;
			justify-content: center;
			color: #666;
			font-size: 28px;
		}
		
		/* ==================== ä¸»ç¼–è¾‘åŒºåŸŸ ==================== */
		/* ç¡®ä¿ç¼–è¾‘å®¹å™¨å¯ä»¥æ­£ç¡®æ»šåŠ¨ */
		.editor-container {
			position: fixed;
			top: 126px;
			bottom: 60px;
			left: 0;
			right: 0;
			overflow: auto;
			-webkit-overflow-scrolling: touch;
			background: white;
		}
		
		#editor-area {
			position: relative;
			width: 2000px;
			height: 2000px;
			background-image: 
				linear-gradient(rgba(0,0,0,0.05) 1px, transparent 1px),
				linear-gradient(90deg, rgba(0,0,0,0.05) 1px, transparent 1px);
			background-size: 20px 20px;
		}
		
		/* ==================== æ•°å­¦å…ƒç´  ==================== */
		.math-element {
			position: absolute;
			font-family: "Cambria Math", "Times New Roman", serif;
			color: #000;
			cursor: move;
			white-space: nowrap;
			line-height: 1.2;
			user-select: none;
			transition: transform 0.1s;
			padding: 2px;
			background: transparent;
			border: none;
			outline: none;
			transform-origin: center center;
		}
		
		.math-element.selected {
			background: rgba(33, 150, 243, 0.1);
			border-radius: 3px;
			outline: 2px solid #2196F3;
		}
		
		.math-element.dragging {
			opacity: 0.9;
			z-index: 1000;
			cursor: grabbing;
		}
		
		.math-element.editing {
			outline: 2px solid #4CAF50;
			background: rgba(76, 175, 80, 0.1);
		}
		
		.math-element.click-selected {
			background: rgba(76, 175, 80, 0.2) !important;
			border: 2px solid #4CAF50 !important;
			border-radius: 4px;
		}
		
		.math-element.drag-selected {
			background: rgba(255, 152, 0, 0.2) !important;
			border: 2px solid #FF9800 !important;
			border-radius: 4px;
		}
		
		/* ==================== åº•éƒ¨æ§åˆ¶æ  ==================== */
		.bottom-controls {
			position: fixed;
			bottom: 0;
			left: 0;
			right: 0;
			background: white;
			border-top: 1px solid #ddd;
			padding: 4px 6px;
			height: 50px;
			display: flex;
			gap: 5px; /* å‡å°é—´è· */
			align-items: center;
			z-index: 1000;
			box-shadow: 0 -1px 3px rgba(0,0,0,0.1);
		}
		
		.control-btn {
			flex: 1;
			padding: 6px 2px; /* å‡å°å†…è¾¹è· */
			border: 1px solid #ddd;
			background: white;
			border-radius: 4px;
			font-size: 14px; /* å­—ä½“å¤§å° */
			cursor: pointer;
			text-align: center;
			min-height: 36px;
			display: flex;
			align-items: center;
			justify-content: center;
			transition: all 0.2s;
			font-weight: 500;
			position: relative;
		}
		
		.control-btn:active {
			background: #f0f0f0;
			transform: scale(0.98);
		}
		
		.control-btn.primary {
			background: #2196F3;
			color: white;
			border-color: #2196F3;
		}
		
		.control-btn.danger {
			background: #f44336;
			color: white;
			border-color: #f44336;
		}
		
		/* ç§»åŠ¨ç¼–è¾‘åŒºæŒ‰é’®çš„æ¿€æ´»çŠ¶æ€ */

		.control-btn.active-editor-pan {
			background: #FF9800;
			color: white;
			border-color: #FF9800;
		} 
		
		
		
		/* ==================== é”®ç›˜æ§åˆ¶æŒ‰é’® ==================== */
		.keyboard-toggle {
			position: fixed;
			right: 10px;
			bottom: 70px;
			background: #4CAF50;
			color: white;
			border: none;
			border-radius: 50%;
			width: 50px;
			height: 50px;
			font-size: 24px;
			cursor: pointer;
			box-shadow: 0 2px 10px rgba(0,0,0,0.3);
			z-index: 1001;
			display: flex;
			align-items: center;
			justify-content: center;
		}
		
		.keyboard-toggle:active {
			transform: scale(0.95);
		}
		
		/* ==================== å¯¹è¯æ¡†å’Œè¦†ç›–å±‚ ==================== */
		.loading-overlay {
			position: fixed;
			top: 0;
			left: 0;
			right: 0;
			bottom: 0;
			background: rgba(0, 0, 0, 0.7);
			display: none;
			justify-content: center;
			align-items: center;
			z-index: 2000;
		}
		
		.loading-spinner {
			width: 50px;
			height: 50px;
			border: 5px solid #f3f3f3;
			border-top: 5px solid #2196F3;
			border-radius: 50%;
			animation: spin 1s linear infinite;
		}
		
		@keyframes spin {
			0% { transform: rotate(0deg); }
			100% { transform: rotate(360deg); }
		}
		
		.confirm-dialog {
			position: fixed;
			top: 50%;
			left: 50%;
			transform: translate(-50%, -50%);
			background: white;
			border-radius: 10px;
			padding: 20px;
			box-shadow: 0 5px 20px rgba(0,0,0,0.3);
			z-index: 2001;
			display: none;
			flex-direction: column;
			gap: 15px;
			min-width: 300px;
		}
		
		.confirm-dialog h3 {
			margin: 0;
			color: #333;
		}
		
		.confirm-dialog p {
			margin: 0;
			color: #666;
			font-size: 14px;
		}
		
		.confirm-dialog-buttons {
			display: flex;
			gap: 10px;
			justify-content: flex-end;
			margin-top: 10px;
		}
		
		.confirm-dialog-btn {
			padding: 8px 16px;
			border: none;
			border-radius: 6px;
			font-size: 14px;
			cursor: pointer;
			min-width: 80px;
		}
		
		.confirm-dialog-btn.cancel {
			background: #f5f5f5;
			color: #333;
		}
		
		.confirm-dialog-btn.confirm {
			background: #2196F3;
			color: white;
		}
		
		.confirm-dialog-btn.danger {
			background: #f44336;
			color: white;
		}
		
		.filename-input {
			width: 100%;
			padding: 8px 12px;
			border: 1px solid #ddd;
			border-radius: 4px;
			font-size: 14px;
			margin-bottom: 5px;
		}
		
		.file-list-dialog {
			position: fixed;
			top: 50%;
			left: 50%;
			transform: translate(-50%, -50%);
			background: white;
			border-radius: 10px;
			padding: 20px;
			box-shadow: 0 5px 20px rgba(0,0,0,0.3);
			z-index: 2001;
			display: none;
			flex-direction: column;
			gap: 15px;
			width: 400px;
			max-height: 500px;
		}
		
		.file-list {
			max-height: 300px;
			overflow-y: auto;
			border: 1px solid #ddd;
			border-radius: 4px;
		}
		
		.file-item {
			padding: 10px;
			border-bottom: 1px solid #eee;
			cursor: pointer;
			display: flex;
			justify-content: space-between;
			align-items: center;
		}
		
		.file-item:hover {
			background: #f5f5f5;
		}
		
		.file-item:last-child {
			border-bottom: none;
		}
		
		.file-name {
			font-weight: bold;
		}
		
		.file-date {
			font-size: 12px;
			color: #666;
		}
		
		.file-actions {
			display: flex;
			gap: 5px;
		}
		
		.file-action-btn {
			padding: 4px 8px;
			font-size: 12px;
			border: none;
			border-radius: 3px;
			cursor: pointer;
			background: #f0f0f0;
		}
		
		.file-action-btn.delete {
			background: #ffebee;
			color: #f44336;
		}
		
		/* ==================== æ‰¹é‡æ“ä½œ ==================== */
		.batch-action-bar {
			position: fixed;
			bottom: 70px;
			left: 50%;
			transform: translateX(-50%);
			background: white;
			border-radius: 10px;
			padding: 10px 15px;
			box-shadow: 0 3px 15px rgba(0,0,0,0.2);
			display: none;
			flex-direction: row;
			gap: 10px;
			z-index: 1001;
			align-items: center;
		}
		
		.batch-action-btn {
			padding: 8px 15px;
			border: none;
			border-radius: 6px;
			font-size: 14px;
			cursor: pointer;
			display: flex;
			align-items: center;
			gap: 5px;
			transition: all 0.2s;
		}
		
		.batch-action-btn.move {
			background: #2196F3;
			color: white;
		}
		
		.batch-action-btn.copy {
			background: #4CAF50;
			color: white;
		}
		
		.batch-action-btn.delete {
			background: #f44336;
			color: white;
		}
		
		.batch-action-btn.cancel {
			background: #9E9E9E;
			color: white;
		}
		
		.batch-action-btn:active {
			opacity: 0.8;
			transform: scale(0.95);
		}
		
		/* ==================== è¾…åŠ©å…ƒç´  ==================== */
		.selection-box {
			position: absolute;
			border: 2px dashed #2196F3;
			background: rgba(33, 150, 243, 0.1);
			pointer-events: none;
			z-index: 500;
			display: none;
		}
		
		.drag-selection-box {
			position: absolute;
			border: 2px dashed #FF9800;
			background: rgba(255, 152, 0, 0.1);
			pointer-events: none;
			z-index: 501;
			display: none;
		}
		
		.guide-line {
			position: absolute;
			background: #2196F3;
			opacity: 0.6;
			pointer-events: none;
			z-index: 600;
			display: none;
		}
		
		.guide-line.vertical {
			width: 1px;
			height: 100%;
		}
		
		.guide-line.horizontal {
			height: 1px;
			width: 100%;
		}
		
		.guide-line.center {
			background: #FF9800;
		}
		
		.file-info {
			font-size: 12px;
			opacity: 0.8;
			margin-top: 2px;
		}
		
		.selection-count {
			position: fixed;
			top: 110px;
			left: 50%;
			transform: translateX(-50%);
			background: rgba(0,0,0,0.8);
			color: white;
			padding: 6px 12px;
			border-radius: 20px;
			font-size: 12px;
			z-index: 999;
			display: none;
		}
		
		.mode-indicator {
			position: fixed;
			top: 110px;
			right: 10px;
			background: rgba(33, 150, 243, 0.9);
			color: white;
			padding: 4px 8px;
			border-radius: 4px;
			font-size: 12px;
			z-index: 1000;
			display: none;
		}
		
		.zoom-indicator {
			position: fixed;
			top: 70px;
			right: 10px;
			background: rgba(0,0,0,0.7);
			color: white;
			padding: 4px 8px;
			border-radius: 4px;
			font-size: 12px;
			z-index: 1000;
		}
		
		.status-tip {
			position: fixed;
			bottom: 120px;
			left: 50%;
			transform: translateX(-50%);
			background: rgba(0,0,0,0.8);
			color: white;
			padding: 8px 16px;
			border-radius: 20px;
			font-size: 14px;
			z-index: 1001;
			display: none;
			white-space: nowrap;
		}
		
		.autosave-indicator {
			position: fixed;
			bottom: 65px;
			left: 10px;
			background: rgba(76, 175, 80, 0.9);
			color: white;
			padding: 4px 8px;
			border-radius: 4px;
			font-size: 11px;
			z-index: 1000;
			display: none;
		}
		
		/* ==================== ç¼–è¾‘åŒºç§»åŠ¨æ¨¡å¼ ==================== */
		body.pan-mode {
			cursor: grab !important;
		}
		
		body.pan-mode .editor-container {
			cursor: grab !important;
		}
		
		body.pan-mode .editor-container:active {
			cursor: grabbing !important;
		}
		
		.tool-btn.active-pan {
			background: #FF9800 !important;
			color: white !important;
		}
		
		.tool-btn.active-grid {
			background: rgba(255,255,255,0.4) !important;
		}
		
		.tool-btn.active-align {
			background: rgba(255,255,255,0.4) !important;
		}
		
		/* ==================== å¾®è°ƒæ§åˆ¶é¢æ¿ï¼ˆç¼©å°ç‰ˆï¼‰ ==================== */

		/* ==================== å¾®è°ƒæ§åˆ¶é¢æ¿ï¼ˆç´§å‡‘ç‰ˆï¼‰ ==================== */
		.nudge-panel {
			position: fixed;
			left: 10px;
			bottom: 70px;
			background: white;
			border-radius: 8px;
			padding: 0; /* ä¿®æ”¹ï¼šç§»é™¤å†…è¾¹è·ï¼Œç”±å†…éƒ¨å…ƒç´ æ§åˆ¶ */
			box-shadow: 0 2px 8px rgba(0,0,0,0.2);
			display: none;
			z-index: 1001; /* æé«˜å±‚çº§ */
			width: 160px;
			cursor: default; /* é»˜è®¤å…‰æ ‡ */
		}
		.nudge-panel.show {
			display: block;
		}

		.nudge-controls {
			display: flex;
			flex-direction: column;
			gap: 6px;
		}

		.nudge-direction-row {
			display: flex;
			justify-content: space-between;
			align-items: center;
			margin-top: 8px;
			gap: 4px;
		}

		.nudge-direction-btn {
			flex: 1;
			padding: 6px 0;
			border: 1px solid #4CAF50;
			background: white;
			border-radius: 4px;
			font-size: 14px;
			color: #4CAF50;
			cursor: pointer;
			display: flex;
			align-items: center;
			justify-content: center;
			transition: all 0.2s;
			min-height: 32px;
		}

		.nudge-direction-btn:hover {
			background: #4CAF50;
			color: white;
		}

		.nudge-direction-btn:active {
			transform: scale(0.95);
		}

		.nudge-preset-container {
			display: flex;
			gap: 4px;
			margin: 5px 0 8px 0;
		}

		.nudge-preset-btn {
			flex: 1;
			padding: 3px 5px;
			border: 1px solid #ddd;
			background: #f8f9fa;
			border-radius: 3px;
			font-size: 10px;
			cursor: pointer;
			text-align: center;
			transition: all 0.2s;
		}

		.nudge-preset-btn.active {
			background: #4CAF50;
			color: white;
			border-color: #4CAF50;
		}

		.nudge-preset-btn:hover:not(.active) {
			background: #e9ecef;
			border-color: #4CAF50;
		}
		
		/* é¢æ¿æ ‡é¢˜æ  */
		.panel-header {
			background: #4CAF50;
			color: white;
			padding: 8px 10px;
			border-radius: 8px 8px 0 0;
			cursor: move; /* å¯ç§»åŠ¨å…‰æ ‡ */
			display: flex;
			justify-content: space-between;
			align-items: center;
			user-select: none; /* é˜²æ­¢æ–‡å­—è¢«é€‰ä¸­ */
		}
		
		.panel-title {
			font-size: 13px;
			font-weight: bold;
		}
		
		.panel-close {
			background: rgba(255,255,255,0.2);
			border: none;
			color: white;
			width: 20px;
			height: 20px;
			border-radius: 50%;
			cursor: pointer;
			display: flex;
			align-items: center;
			justify-content: center;
			font-size: 16px;
			line-height: 1;
		}
		
		.panel-close:hover {
			background: rgba(255,255,255,0.3);
		}
		
		/* é¢æ¿å†…å®¹åŒºåŸŸ */
		.nudge-controls {
			padding: 8px 10px;
		}
		
		/* æ‹–åŠ¨æ—¶çš„æ ·å¼ */
		.panel-header.dragging {
			opacity: 0.9;
			cursor: grabbing;
		}
		
		/* é˜²æ­¢æ‹–åŠ¨æ—¶é€‰ä¸­æ–‡æœ¬ */
		.panel-header.dragging * {
			user-select: none;
			-webkit-user-select: none;
		}
				
				
				
				
				
	</style>
</head>
<body>
	<!-- é¡¶éƒ¨å·¥å…·æ  -->
	<div class="header-toolbar">
		<div class="header-left">
			<div class="dropdown-menu">
				<button class="tool-btn" onclick="toggleMenu()" title="èœå•">
					<span>â‹®</span>
				</button>
				<div class="dropdown-content" id="dropdown-menu">
					<button onclick="handleMenuItemClick(); newFile()" class="menu-item">ğŸ“„ æ–°å»º</button>
					<button onclick="handleMenuItemClick(); showFileList()" class="menu-item">ğŸ“‚ æ‰“å¼€</button>
					<button onclick="handleMenuItemClick(); saveFile()" class="menu-item">ğŸ’¾ ä¿å­˜</button>
					<hr>
					<button onclick="handleMenuItemClick(); copySelected()" class="menu-item">ğŸ“‹ å¤åˆ¶</button>
					<button onclick="handleMenuItemClick(); pasteElements()" class="menu-item">ğŸ“ ç²˜è´´</button>
					<hr>
					<button onclick="handleMenuItemClick(); downloadCurrentFile()" class="menu-item">â¬‡ï¸ ä¸‹è½½å½“å‰æ–‡ä»¶</button>
					<button onclick="handleMenuItemClick(); uploadAndOpenFile()" class="menu-item">â¬†ï¸ ä¸Šä¼ å¹¶æ‰“å¼€</button>
 					<!--æ–‡ä»¶åˆ—è¡¨å¯¹è¯æ¡†ç›¸å…³çš„æŒ‰é’®åé¢æ·»åŠ  -->
 					<button onclick="handleMenuItemClick(); exportToPNG()" class="menu-item">ğŸ–¼ï¸ å¯¼å‡ºPNGå›¾ç‰‡</button>
					<button onclick="handleMenuItemClick(); toggleEditorPanMode()" class="menu-item" id="editor-pan-menu-item">
						<span id="editor-pan-menu-icon">âœ‹</span> ç§»åŠ¨ç¼–è¾‘åŒº
					</button>
					<hr>
					<button onclick="handleMenuItemClick(); toggleGrid()" class="menu-item">
						<span id="grid-menu-icon">â¬œ</span> <span id="grid-menu-text">ç½‘æ ¼</span>
					</button>
				</div>
			</div>
		</div>
		
		<div class="header-center" id="current-file-info">
			<div>æ•°å­¦å…¬å¼ç¼–è¾‘å™¨</div>
			<div class="file-info" id="file-info-text">å½“å‰æ–‡ä»¶: æœªå‘½å</div>
		</div>
		
		<div class="header-right">
			<button class="tool-btn" onclick="toggleGrid()" id="grid-toggle-btn" title="ç½‘æ ¼å¼€å…³">
				<span id="grid-icon">â¬œ</span>
			</button>
			<button class="tool-btn" onclick="toggleAlignPanel()" id="align-toggle-btn" title="å¯¹é½è®¾ç½®">
				<span id="align-icon">â§‰</span>
			</button>
			<button class="tool-btn" onclick="toggleNudgePanel()">å¾®è°ƒ</button>
			<button class="tool-btn" onclick="toggleFontPanel()">å­—ä½“</button>
			<button class="tool-btn" onclick="clearAll()" style="color: #ff5252;" title="æ¸…ç©ºæ‰€æœ‰å†…å®¹">æ¸…ç©º</button>
		</div>
	</div>
	
	<!-- ç‰¹æ®Šç¬¦å·æ»‘åŠ¨æ  -->
	<div class="symbols-scroll" id="symbols-scroll">
		<div class="symbol-scroll-container">
			<button class="symbol-btn" onclick="insertSymbol('âˆ«')">âˆ«</button>
			<button class="symbol-btn" onclick="insertSymbol('âˆ¬')">âˆ¬</button>
			<button class="symbol-btn" onclick="insertSymbol('âˆ‚')">âˆ‚</button>
			<button class="symbol-btn" onclick="insertSymbol('âˆ‡')">âˆ‡</button>
			<button class="symbol-btn" onclick="insertSymbol('âˆ‘')">âˆ‘</button>
			<button class="symbol-btn" onclick="insertSymbol('âˆ')">âˆ</button>
			<button class="symbol-btn" onclick="insertSymbol('âˆ')">âˆ</button>
			<button class="symbol-btn" onclick="insertSymbol('â‰ ')">â‰ </button>
			<button class="symbol-btn" onclick="insertSymbol('â‰ˆ')">â‰ˆ</button>
			<button class="symbol-btn" onclick="insertSymbol('â‰¤')">â‰¤</button>
			<button class="symbol-btn" onclick="insertSymbol('â‰¥')">â‰¥</button>
			<button class="symbol-btn" onclick="insertSymbol('Â±')">Â±</button>
			<button class="symbol-btn" onclick="insertSymbol('â†’')">â†’</button>
			<button class="symbol-btn" onclick="insertSymbol('â‡’')">â‡’</button>
			<button class="symbol-btn" onclick="insertSymbol('Î±')">Î±</button>
			<button class="symbol-btn" onclick="insertSymbol('Î²')">Î²</button>
			<button class="symbol-btn" onclick="insertSymbol('Î³')">Î³</button>
			<button class="symbol-btn" onclick="insertSymbol('Î´')">Î´</button>
			<button class="symbol-btn" onclick="insertSymbol('Îµ')">Îµ</button>
		</div>
	</div>
	
	<!-- é”®ç›˜è¾“å…¥åŒºåŸŸ -->
	<div class="keyboard-input-display" id="keyboard-input-display">
		<textarea class="input-textbox" id="input-textbox" 
				  placeholder="è¾“å…¥æ•°å­¦è¡¨è¾¾å¼"
				  rows="2"></textarea>
		<div class="input-controls">
			<button class="input-btn cancel" onclick="cancelInput()">å–æ¶ˆ</button>
			<button class="input-btn confirm" onclick="confirmInput()">ç¡®å®š</button>
		</div>
	</div>
	
	<!-- åŠ è½½è¦†ç›–å±‚ -->
	<div class="loading-overlay" id="loading-overlay">
		<div class="loading-spinner"></div>
	</div>
	
	<!-- ç¡®è®¤å¯¹è¯æ¡† -->
	<div class="confirm-dialog" id="confirm-dialog">
		<h3 id="confirm-title">ç¡®è®¤</h3>
		<p id="confirm-message">ç¡®å®šè¦æ‰§è¡Œæ­¤æ“ä½œå—ï¼Ÿ</p>
		<div id="confirm-extra-content" style="display: none;"></div>
		<div class="confirm-dialog-buttons">
			<button class="confirm-dialog-btn cancel" onclick="hideConfirmDialog()">å–æ¶ˆ</button>
			<button class="confirm-dialog-btn confirm" id="confirm-action-btn" onclick="confirmDialogAction()">ç¡®å®š</button>
		</div>
	</div>
	
	<!-- æ–‡ä»¶åˆ—è¡¨å¯¹è¯æ¡† -->
	<div class="file-list-dialog" id="file-list-dialog">
		<h3>é€‰æ‹©è¦æ‰“å¼€çš„æ–‡ä»¶</h3>
		<div class="file-list" id="file-list">
			<!-- æ–‡ä»¶åˆ—è¡¨å°†åŠ¨æ€ç”Ÿæˆ -->
		</div>
		<div style="margin-top: 10px;">
			<input type="text" id="new-filename" class="filename-input" placeholder="è¾“å…¥æ–°æ–‡ä»¶å">
			<button class="confirm-dialog-btn confirm" onclick="createNewNamedFile()">æ–°å»ºæ–‡ä»¶</button>
		</div>
		<div class="confirm-dialog-buttons">
			<button class="confirm-dialog-btn cancel" onclick="hideFileList()">å…³é—­</button>
		</div>
	</div>
	
	<!-- å­—ä½“æ§åˆ¶é¢æ¿ -->
	<div class="font-controls" id="font-controls">
		<div style="font-size: 14px; font-weight: bold; color: #4CAF50;">å­—ä½“è®¾ç½®</div>
		
		<div style="margin: 10px 0 5px 0; font-size: 13px; color: #666;">
			å­—ä½“å¤§å°ï¼š
			<span id="font-size-display">24px</span>
		</div>
		<input type="range" class="font-slider" id="font-slider" min="5" max="120" value="24" 
			   oninput="updateFontSize(this.value)">
		
		<div style="font-size: 13px; color: #666; margin-top: 10px;">å¸¸ç”¨å¤§å°ï¼š</div>
		<div class="font-preset-container" id="font-preset-container">
			<!-- å­—ä½“é¢„è®¾æŒ‰é’®å°†åŠ¨æ€ç”Ÿæˆ -->
		</div>
		
		<div style="display: flex; gap: 10px; margin-top: 10px;">
			<button class="font-preset-btn" onclick="applyFontToSelected()" style="flex: 2;">åº”ç”¨åˆ°é€‰ä¸­</button>
			<button class="font-preset-btn" onclick="applyFontToAll()" style="flex: 1;">å…¨éƒ¨åº”ç”¨</button>
		</div>
	</div>
	
	<!-- å¯¹é½æ§åˆ¶é¢æ¿ -->
	<div class="align-controls" id="align-controls">
		<div style="font-size: 14px; font-weight: bold; color: #2196F3;">å¯¹é½è®¾ç½®</div>
		
		<div class="align-option">
			<label class="checkbox-label">
				<input type="checkbox" id="grid-align-checkbox" checked onchange="toggleAlignOption('grid')">
				<span>ç½‘æ ¼å¯¹é½</span>
			</label>
		</div>
		<div class="align-option">
			<label class="checkbox-label">
				<input type="checkbox" id="edge-align-checkbox" checked onchange="toggleAlignOption('edge')">
				<span>å…ƒç´ è¾¹ç¼˜å¯¹é½</span>
			</label>
		</div>
		<div class="align-option">
			<label class="checkbox-label">
				<input type="checkbox" id="center-align-checkbox" onchange="toggleAlignOption('center')">
				<span>ä¸­å¿ƒçº¿å¯¹é½</span>
			</label>
		</div>
		
		<div style="margin: 15px 0 5px 0; font-size: 13px; color: #666;">
			å¯¹é½ç²¾åº¦ï¼š
			<span id="align-precision-display">14px</span>
		</div>
		<input type="range" class="align-slider" id="align-slider" 
			   min="1" max="30" value="14" step="1"
			   oninput="updateAlignPrecision(this.value)">
		
		<div style="font-size: 13px; color: #666; margin-top: 10px;">é¢„è®¾ç²¾åº¦ï¼š</div>
		<div class="precision-preset-container" id="precision-preset-container">
			<button class="precision-preset-btn" onclick="setAlignPrecision(5)">5px</button>
			<button class="precision-preset-btn" onclick="setAlignPrecision(10)">10px</button>
			<button class="precision-preset-btn active" onclick="setAlignPrecision(14)">14px</button>
			<button class="precision-preset-btn" onclick="setAlignPrecision(20)">20px</button>
		</div>
	</div>
	
	<!-- å¾®è°ƒæ§åˆ¶é¢æ¿ï¼ˆå·¦ä¸‹è§’ï¼‰ -->
	<div class="nudge-panel" id="nudge-panel">
	     	<!-- æ·»åŠ å¯æ‹–åŠ¨çš„æ ‡é¢˜æ  -->
		<div class="panel-header" id="nudge-panel-header">
			<span class="panel-title">å¾®è°ƒè®¾ç½®</span>
			<button class="panel-close" onclick="toggleNudgePanel()">Ã—</button>
		</div> 
	
	
		<div class="nudge-controls">
			<div style="font-size: 13px; font-weight: bold; color: #4CAF50; margin-bottom: 5px;">å¾®è°ƒè®¾ç½®</div>
			
			<div style="font-size: 11px; color: #666; margin-bottom: 3px;">
				ç²¾åº¦: <span id="nudge-precision-display">5px</span>
			</div>
			<input type="range" class="nudge-slider" id="nudge-slider" 
				   min="1" max="20" value="5" step="1"
				   oninput="updateNudgePrecision(this.value)">
			
			<div style="font-size: 11px; color: #666; margin-top: 5px;">é¢„è®¾:</div>
			<div class="nudge-preset-container" id="nudge-preset-container">
				<button class="nudge-preset-btn" onclick="setNudgePrecision(1)">1px</button>
				<button class="nudge-preset-btn active" onclick="setNudgePrecision(5)">5px</button>
				<button class="nudge-preset-btn" onclick="setNudgePrecision(10)">10px</button>
				<button class="nudge-preset-btn" onclick="setNudgePrecision(20)">20px</button>
			</div>
			
			<div class="nudge-direction-row">
				<button class="nudge-direction-btn" onclick="nudgeSelected(0, -Config.nudgePrecision)">â†‘</button>
				<button class="nudge-direction-btn" onclick="nudgeSelected(-Config.nudgePrecision, 0)">â†</button>
				<button class="nudge-direction-btn" onclick="nudgeSelected(Config.nudgePrecision, 0)">â†’</button>
				<button class="nudge-direction-btn" onclick="nudgeSelected(0, Config.nudgePrecision)">â†“</button>
			</div>
		</div>
	</div>
	
	<!-- ä¸»ç¼–è¾‘åŒºåŸŸ -->
	<div class="editor-container" id="editor-container">
		<div id="editor-area">
			<!-- å¯¹é½è¾…åŠ©çº¿ -->
			<div class="guide-line vertical" id="guide-vertical"></div>
			<div class="guide-line horizontal" id="guide-horizontal"></div>
			<div class="guide-line vertical center" id="guide-vertical-center"></div>
			<div class="guide-line horizontal center" id="guide-horizontal-center"></div>
			
			<!-- æ¡†é€‰æ¡† -->
			<div class="selection-box" id="selection-box"></div>
			
			<!-- æ‹–æ‹½é€‰æ‹©æ¡† -->
			<div class="drag-selection-box" id="drag-selection-box"></div>
			
			<!-- æ•°å­¦å…ƒç´ å°†åŠ¨æ€æ·»åŠ åˆ°è¿™é‡Œ -->
		</div>
	</div>
	
	<!-- åº•éƒ¨æ§åˆ¶æ  -->
	<div class="bottom-controls">
		<button class="control-btn" onclick="addNewElement()" title="æ–°å»º">+</button>
		<button class="control-btn" onclick="editSelectedElement()" title="ç¼–è¾‘">âœï¸</button>
		<button class="control-btn primary" onclick="toggleClickSelectionMode()" id="click-select-btn" title="ç‚¹å‡»æ¡†é€‰">âœ“</button>
		<button class="control-btn" onclick="toggleEditorPanMode()" id="editor-pan-bottom-btn" title="ç§»åŠ¨ç¼–è¾‘åŒº">âœ‹</button>
		<button class="control-btn" onclick="toggleNudgePanel()" title="å¾®è°ƒ">â†•ï¸</button>
		<button class="control-btn danger" onclick="deleteSelected()" title="åˆ é™¤">ğŸ—‘ï¸</button>
	</div>
	
	<!-- é”®ç›˜æ§åˆ¶æŒ‰é’® -->
	<button class="keyboard-toggle" id="keyboard-toggle" onclick="toggleKeyboard()">âŒ¨ï¸</button>
	
	<!-- æ‰¹é‡æ“ä½œæŒ‰é’®æ  -->
	<div class="batch-action-bar" id="batch-action-bar">
		<button class="batch-action-btn move" onclick="startBatchMove()">ç§»åŠ¨</button>
		<button class="batch-action-btn copy" onclick="batchCopy()">å¤åˆ¶</button>
		<button class="batch-action-btn delete" onclick="batchDelete()">åˆ é™¤</button>
		<button class="batch-action-btn cancel" onclick="exitBatchMoveMode()">å–æ¶ˆ</button>
	</div>
	
	<!-- å„ç§æŒ‡ç¤ºå™¨ -->
	<div class="selection-count" id="selection-count"></div>
	<div class="mode-indicator" id="mode-indicator"></div>
	<div class="zoom-indicator" id="zoom-indicator">100%</div>
	<div class="status-tip" id="status-tip"></div>
	<div class="autosave-indicator" id="autosave-indicator">è‡ªåŠ¨ä¿å­˜</div>
	

	

	<script>
	
	
	
		// ==================== å…¨å±€é…ç½® ====================
		const Config = {
			// åŸæœ‰é…ç½®
			snapEnabled: true,
			gridEnabled: true,
			zoom: 1,
			minZoom: 0.3,
			maxZoom: 3,
			keyboardActive: false,
			isDragging: false,
			isSelecting: false,
			isPanning: false,
			editMode: false,
			selectionMode: false,
			clickSelectionMode: false,
			dragSelectionMode: false,
			batchMoveMode: false,
			editorPanMode: false,
			hasUnsavedChanges: false,
			currentFileName: "æœªå‘½å",
			lastSaveTime: null,
			autosaveEnabled: true,
			autosaveInterval: 30000,
			menuOpen: false,
			
			// æ–°å¢å¯¹é½é…ç½®
			alignOptions: {
				grid: true,
				edge: true,
				center: false,
				precision: 14
			},
			
			// å¾®è°ƒé…ç½®
			nudgePrecision: 5,
			nudgePresets: [1, 5, 10, 20],
			
			// å­—ä½“å†å²è®°å½•
			fontSizeHistory: [16, 24, 32, 40],
			maxFontHistory: 4,
			
			// é¢æ¿çŠ¶æ€
			fontPanelOpen: false,
			alignPanelOpen: false,
			nudgePanelOpen: false,
			
			// å­—ä½“ç›¸å…³
			lastFontSize: 24,
			recentFontSizes: []
		};

		// ==================== åæ ‡è½¬æ¢å·¥å…· ====================
		const CoordinateSystem = {
			// å±å¹•åæ ‡ -> é€»è¾‘åæ ‡
			screenToLogic: function(screenX, screenY) {
				const rect = editorArea.getBoundingClientRect();
				return {
					x: (screenX - rect.left + editorContainer.scrollLeft) / Config.zoom,
					y: (screenY - rect.top + editorContainer.scrollTop) / Config.zoom
				};
			},
			
			// é€»è¾‘åæ ‡ -> å±å¹•åæ ‡
			logicToScreen: function(logicX, logicY) {
				return {
					x: logicX * Config.zoom,
					y: logicY * Config.zoom
				};
			},
			
			// å±å¹•è·ç¦» -> é€»è¾‘è·ç¦»
			screenDistanceToLogic: function(screenDistance) {
				return screenDistance / Config.zoom;
			},
			
			// é€»è¾‘è·ç¦» -> å±å¹•è·ç¦»
			logicDistanceToScreen: function(logicDistance) {
				return logicDistance * Config.zoom;
			},
			
			// é€»è¾‘å­—ä½“å¤§å° -> å±å¹•å­—ä½“å¤§å°
			logicFontSizeToScreen: function(logicFontSize) {
				return logicFontSize * Config.zoom;
			},
			
			// å±å¹•å­—ä½“å¤§å° -> é€»è¾‘å­—ä½“å¤§å°
			screenFontSizeToLogic: function(screenFontSize) {
				return screenFontSize / Config.zoom;
			},
			
			// å±å¹•åŒºåŸŸ -> é€»è¾‘åŒºåŸŸ
			screenRectToLogic: function(screenX, screenY, screenWidth, screenHeight) {
				const logicStart = this.screenToLogic(screenX, screenY);
				const logicEnd = this.screenToLogic(screenX + screenWidth, screenY + screenHeight);
				
				return {
					x: Math.min(logicStart.x, logicEnd.x),
					y: Math.min(logicStart.y, logicEnd.y),
					width: Math.abs(logicEnd.x - logicStart.x),
					height: Math.abs(logicEnd.y - logicStart.y)
				};
			},
			
			// é€»è¾‘åŒºåŸŸ -> å±å¹•åŒºåŸŸ
			logicRectToScreen: function(logicX, logicY, logicWidth, logicHeight) {
				const screenStart = this.logicToScreen(logicX, logicY);
				const screenEnd = this.logicToScreen(logicX + logicWidth, logicY + logicHeight);
				
				return {
					x: Math.min(screenStart.x, screenEnd.x),
					y: Math.min(screenStart.y, screenEnd.y),
					width: Math.abs(screenEnd.x - screenStart.x),
					height: Math.abs(screenEnd.y - screenStart.y)
				};
			}
		};

		// ==================== çŠ¶æ€ç®¡ç† ====================
		const State = {
			elements: [],
			selectedIds: new Set(),
			clickSelectedIds: new Set(),
			dragSelectedIds: new Set(),
			dragStart: { x: 0, y: 0 },
			selectionStart: { x: 0, y: 0 },
			clipboard: [],
			dragOffset: { x: 0, y: 0 },
			originalPositions: [],
			pinchStartDistance: 0,
			pinchStartZoom: 1,
			editingElement: null,
			currentZoom: 1,
			dragSelectionStart: { x: 0, y: 0 },
			batchMoveOffset: { x: 0, y: 0 },
			panStart: { x: 0, y: 0 },
			panScrollStart: { x: 0, y: 0 },
			autosaveTimer: null,
			pendingAction: null,
			
			// å­—ä½“ä½¿ç”¨è®°å½•
			fontUsageHistory: {}
		};

		// ==================== DOMå…ƒç´ å¼•ç”¨ ====================
		const editorArea = document.getElementById('editor-area');
		const editorContainer = document.getElementById('editor-container');
		const selectionBox = document.getElementById('selection-box');
		const dragSelectionBox = document.getElementById('drag-selection-box');
		const guideVertical = document.getElementById('guide-vertical');
		const guideHorizontal = document.getElementById('guide-horizontal');
		const guideVerticalCenter = document.getElementById('guide-vertical-center');
		const guideHorizontalCenter = document.getElementById('guide-horizontal-center');
		const zoomIndicator = document.getElementById('zoom-indicator');
		const statusTip = document.getElementById('status-tip');
		const keyboardToggle = document.getElementById('keyboard-toggle');
		const fontControls = document.getElementById('font-controls');
		const alignControls = document.getElementById('align-controls');
		const nudgePanel = document.getElementById('nudge-panel');
		const fontSlider = document.getElementById('font-slider');
		const fontSizeDisplay = document.getElementById('font-size-display');
		const alignSlider = document.getElementById('align-slider');
		const alignPrecisionDisplay = document.getElementById('align-precision-display');
		const nudgeSlider = document.getElementById('nudge-slider');
		const nudgePrecisionDisplay = document.getElementById('nudge-precision-display');
		const fontPresetContainer = document.getElementById('font-preset-container');
		const batchActionBar = document.getElementById('batch-action-bar');
		const selectionCount = document.getElementById('selection-count');
		const modeIndicator = document.getElementById('mode-indicator');
		const clickSelectBtn = document.getElementById('click-select-btn');
		const symbolsScroll = document.getElementById('symbols-scroll');
		const keyboardInputDisplay = document.getElementById('keyboard-input-display');
		const inputTextbox = document.getElementById('input-textbox');
		const fileInfoText = document.getElementById('file-info-text');
		const loadingOverlay = document.getElementById('loading-overlay');
		const confirmDialog = document.getElementById('confirm-dialog');
		const confirmTitle = document.getElementById('confirm-title');
		const confirmMessage = document.getElementById('confirm-message');
		const confirmExtraContent = document.getElementById('confirm-extra-content');
		const confirmActionBtn = document.getElementById('confirm-action-btn');
		const autosaveIndicator = document.getElementById('autosave-indicator');
		const fileListDialog = document.getElementById('file-list-dialog');
		const fileList = document.getElementById('file-list');
		const newFilenameInput = document.getElementById('new-filename');
		const gridToggleBtn = document.getElementById('grid-toggle-btn');
		const alignToggleBtn = document.getElementById('align-toggle-btn');
		const gridIcon = document.getElementById('grid-icon');
		const alignIcon = document.getElementById('align-icon');

		// ==================== æ··åˆå­˜å‚¨æ–¹æ¡ˆ ====================
		const StorageManager = {
			// å­˜å‚¨é”®
			FILES_STORAGE_KEY: 'math_editor_files',
			CURRENT_FILE_KEY: 'math_editor_current_file',
			SETTINGS_KEY: 'math_editor_settings',
			
			// æ£€æŸ¥å­˜å‚¨æ–¹å¼
			getStorageType() {
				if (window.cordova && cordova.file) {
					return 'cordova';
				} else if (window.Capacitor && Capacitor.Plugins.Filesystem) {
					return 'capacitor';
				} else {
					return 'browser';
				}
			},
			
			// è·å–æ‰€æœ‰æ–‡ä»¶
			getAllFiles() {
				try {
					const filesJson = localStorage.getItem(this.FILES_STORAGE_KEY);
					if (filesJson) {
						return JSON.parse(filesJson);
					}
				} catch (e) {
					console.error('è¯»å–æ–‡ä»¶åˆ—è¡¨å¤±è´¥:', e);
				}
				return {};
			},
			
			// ä¿å­˜æ–‡ä»¶åˆ—è¡¨
			saveFileList(files) {
				try {
					localStorage.setItem(this.FILES_STORAGE_KEY, JSON.stringify(files));
					return true;
				} catch (e) {
					console.error('ä¿å­˜æ–‡ä»¶åˆ—è¡¨å¤±è´¥:', e);
					showStatusTip('ä¿å­˜æ–‡ä»¶åˆ—è¡¨å¤±è´¥: ' + e.message);
					return false;
				}
			},
			
			// è·å–è®¾ç½®
			getSettings() {
				try {
					const settingsJson = localStorage.getItem(this.SETTINGS_KEY);
					if (settingsJson) {
						return JSON.parse(settingsJson);
					}
				} catch (e) {
					console.error('è¯»å–è®¾ç½®å¤±è´¥:', e);
				}
				return {};
			},
			
			// ä¿å­˜è®¾ç½®
			saveSettings(settings) {
				try {
					localStorage.setItem(this.SETTINGS_KEY, JSON.stringify(settings));
					return true;
				} catch (e) {
					console.error('ä¿å­˜è®¾ç½®å¤±è´¥:', e);
					return false;
				}
			},
			
			// è·å–å½“å‰æ–‡ä»¶æ•°æ®
			getCurrentFileData() {
				return {
					version: '1.0',
					created: new Date().toISOString(),
					updated: new Date().toISOString(),
					config: {
						zoom: Config.zoom,
						gridEnabled: Config.gridEnabled,
						snapEnabled: Config.snapEnabled,
						alignOptions: Config.alignOptions,
						nudgePrecision: Config.nudgePrecision,
						fontSizeHistory: Config.fontSizeHistory,
						fontUsageHistory: State.fontUsageHistory,
						lastFontSize: Config.lastFontSize || 24
					},
					viewport: {
						scrollLeft: editorContainer.scrollLeft,
						scrollTop: editorContainer.scrollTop
					},
					elements: State.elements.map(el => ({
						content: el.content,
						x: el.x,                    // é€»è¾‘Xåæ ‡
						y: el.y,                    // é€»è¾‘Yåæ ‡
						width: el.width,            // é€»è¾‘å®½åº¦
						height: el.height,          // é€»è¾‘é«˜åº¦
						fontSize: el.fontSize,      // é€»è¾‘å­—ä½“å¤§å°
						color: el.color,
						type: el.type
					}))
				};
			},
			
			// ä¿å­˜æ–‡ä»¶
			async saveFile(fileName, data) {
				const type = this.getStorageType();
				
				try {
					switch(type) {
						case 'cordova':
							return await this.saveCordova(fileName, data);
						case 'capacitor':
							return await this.saveCapacitor(fileName, data);
						default:
							const files = this.getAllFiles();
							files[fileName] = data;
							
							if (!this.saveFileList(files)) {
								showStatusTip('ä¿å­˜å¤±è´¥');
								return false;
							}
							
							this.downloadFile(fileName, data);
							return true;
					}
				} catch (error) {
					console.error('ä¿å­˜å¤±è´¥:', error);
					showStatusTip('ä¿å­˜å¤±è´¥: ' + error.message);
					return false;
				}
			},
			
			// ä¸‹è½½æ–‡ä»¶
			downloadFile(fileName, data) {
				try {
					const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
					const url = URL.createObjectURL(blob);
					const a = document.createElement('a');
					a.href = url;
					a.download = fileName + '.math.json';
					document.body.appendChild(a);
					a.click();
					setTimeout(() => {
						document.body.removeChild(a);
						URL.revokeObjectURL(url);
					}, 100);
				} catch (error) {
					console.error('ä¸‹è½½æ–‡ä»¶å¤±è´¥:', error);
				}
			},
			
			// åŠ è½½æ–‡ä»¶
			async loadFile(fileName) {
				const type = this.getStorageType();
				
				try {
					switch(type) {
						case 'cordova':
							return await this.loadCordova(fileName);
						case 'capacitor':
							return await this.loadCapacitor(fileName);
						default:
							const files = this.getAllFiles();
							return files[fileName] || null;
					}
				} catch (error) {
					console.error('åŠ è½½å¤±è´¥:', error);
					showStatusTip('åŠ è½½å¤±è´¥: ' + error.message);
					return null;
				}
			},
			
			// åˆ é™¤æ–‡ä»¶
			async deleteFile(fileName) {
				const type = this.getStorageType();
				
				try {
					switch(type) {
						case 'cordova':
							return await this.deleteCordova(fileName);
						case 'capacitor':
							return await this.deleteCapacitor(fileName);
						default:
							const files = this.getAllFiles();
							if (files[fileName]) {
								delete files[fileName];
								return this.saveFileList(files);
							}
							return true;
					}
				} catch (error) {
					console.error('åˆ é™¤å¤±è´¥:', error);
					showStatusTip('åˆ é™¤å¤±è´¥: ' + error.message);
					return false;
				}
			},
			
			// ä¸Šä¼ æ–‡ä»¶
			uploadFile() {
				return new Promise((resolve) => {
					const input = document.createElement('input');
					input.type = 'file';
					input.accept = '.json,.math.json';
					input.style.display = 'none';
					
					input.onchange = (e) => {
						const file = e.target.files[0];
						if (!file) {
							resolve(null);
							return;
						}
						
						const reader = new FileReader();
						reader.onload = (event) => {
							try {
								const data = JSON.parse(event.target.result);
								const fileName = file.name.replace('.math.json', '').replace('.json', '');
								resolve({ fileName, data });
							} catch (error) {
								showStatusTip('æ–‡ä»¶æ ¼å¼é”™è¯¯');
								resolve(null);
							}
						};
						reader.readAsText(file);
					};
					
					document.body.appendChild(input);
					input.click();
					setTimeout(() => {
						document.body.removeChild(input);
					}, 1000);
				});
			},
			
			// å¾…å®ç°åŠŸèƒ½
			async saveCordova(fileName, data) {
				showStatusTip('Cordovaä¿å­˜åŠŸèƒ½å°†åœ¨åç»­ç‰ˆæœ¬ä¸­æ·»åŠ ');
				return false;
			},
			
			async loadCordova(fileName) {
				showStatusTip('CordovaåŠ è½½åŠŸèƒ½å°†åœ¨åç»­ç‰ˆæœ¬ä¸­æ·»åŠ ');
				return null;
			},
			
			async saveCapacitor(fileName, data) {
				showStatusTip('Capacitorä¿å­˜åŠŸèƒ½å°†åœ¨åç»­ç‰ˆæœ¬ä¸­æ·»åŠ ');
				return false;
			},
			
			async loadCapacitor(fileName) {
				showStatusTip('CapacitoråŠ è½½åŠŸèƒ½å°†åœ¨åç»­ç‰ˆæœ¬ä¸­æ·»åŠ ');
				return null;
			}
		};

		// ==================== èœå•ç®¡ç† ====================
		function toggleMenu() {
			Config.menuOpen = !Config.menuOpen;
			const menu = document.getElementById('dropdown-menu');
			
			if (menu) {
				if (Config.menuOpen) {
					menu.classList.add('show');
					setTimeout(() => {
						document.addEventListener('click', closeMenuOnClickOutside);
					}, 10);
				} else {
					menu.classList.remove('show');
					document.removeEventListener('click', closeMenuOnClickOutside);
				}
			}
		}

		function closeMenuOnClickOutside(event) {
			const menu = document.getElementById('dropdown-menu');
			const menuButton = document.querySelector('.dropdown-menu .tool-btn');
			
			if (menu && !menu.contains(event.target) && !menuButton.contains(event.target)) {
				menu.classList.remove('show');
				Config.menuOpen = false;
				document.removeEventListener('click', closeMenuOnClickOutside);
			}
		}

		function handleMenuItemClick() {
			const menu = document.getElementById('dropdown-menu');
			if (menu) {
				menu.classList.remove('show');
				Config.menuOpen = false;
				document.removeEventListener('click', closeMenuOnClickOutside);
			}
		}
		
		
/**
 * è·å–æ¯æ—¥æ¿€æ´»å¯†ç  (åŸºäº Date + å¯†é’¥'ncj' + é•¿åº¦20)
 * å¿…é¡»ä¸ç”Ÿæˆå™¨é€»è¾‘ä¸€è‡´
 */
function getDailyPassword() {
	// --- 1. æ ¸å¿ƒç®—æ³•å®šä¹‰ ---
	function stringToHash(str) {
		let hash = 5381;
		for (let i = 0; i < str.length; i++) {
			hash = ((hash << 5) + hash) + str.charCodeAt(i);
		}
		return hash;
	}

	class SeededRandom {
		constructor(seed) { this.seed = seed; }
		next() {
			const x = Math.sin(this.seed++) * 10000;
			return x - Math.floor(x);
		}
		nextInt(max) { return Math.floor(this.next() * max); }
	}

	// --- 2. é…ç½®å‚æ•° (è‡ªåŠ¨è·å–æ—¥æœŸ) ---
	const now = new Date();
	const year = now.getFullYear();
	const month = String(now.getMonth() + 1).padStart(2, '0');
	const day = String(now.getDate()).padStart(2, '0');
	const dateStr = `${year}-${month}-${day}`;

	const saltStr = "ncj";   // å›ºå®šå¯†é’¥
	const length = 20;       // å›ºå®šé•¿åº¦

	const chars = {
		upper: 'ABCDEFGHIJKLMNOPQRSTUVWXYZ',
		lower: 'abcdefghijklmnopqrstuvwxyz',
		numbers: '0123456789',
		symbols: '!@#$%^&*()_+~`|}{[]:;?><,./-='
	};
	
	let fullCharset = chars.upper + chars.lower + chars.numbers + chars.symbols;

	// --- 3. ç”Ÿæˆå¯†ç  ---
	const seedString = dateStr + saltStr;
	const seedHash = stringToHash(seedString);
	const rng = new SeededRandom(seedHash);

	let password = '';
	let requiredChars = [
		chars.upper[rng.nextInt(chars.upper.length)],
		chars.lower[rng.nextInt(chars.lower.length)],
		chars.numbers[rng.nextInt(chars.numbers.length)],
		chars.symbols[rng.nextInt(chars.symbols.length)]
	];

	for (let i = 0; i < length - requiredChars.length; i++) {
		password += fullCharset[rng.nextInt(fullCharset.length)];
	}
	password += requiredChars.join('');
	return password.split('').sort(() => rng.next() - 0.5).join('');
}		
		
		
// ==================== ä½¿ç”¨æ¬¡æ•°é™åˆ¶ç³»ç»Ÿ ====================
// ==================== å®Œæ•´çš„ä½¿ç”¨é™åˆ¶ç³»ç»Ÿ ====================
const UsageLimit = {
	// æµ‹è¯•ç”¨ï¼šè®¾ä¸ºå¾ˆå°çš„å€¼æ–¹ä¾¿æµ‹è¯•
	MAX_SAVES: 3,           // æœ€å¤§ä¿å­˜æ¬¡æ•°
	MAX_EXPORTS: 2,         // æœ€å¤§å¯¼å‡ºæ¬¡æ•°
	MAX_MINUTES: 2,        // æœ€å¤§ä½¿ç”¨åˆ†é’Ÿæ•°ï¼ˆæµ‹è¯•ç”¨ï¼‰
	
	// è·å–ä½¿ç”¨è®°å½•
	getUsageRecord() {
		const today = new Date().toISOString().split('T')[0]; // åªå–æ—¥æœŸ
		const defaultRecord = {
			date: today,
			saveCount: 0,
			exportCount: 0,
			startTime: Date.now(),
			totalMinutes: 0
		};
		
		const stored = localStorage.getItem('editor_usage');
		if (!stored) {
			localStorage.setItem('editor_usage', JSON.stringify(defaultRecord));
			return defaultRecord;
		}
		
		const record = JSON.parse(stored);
		
		// å¦‚æœæ˜¯æ–°çš„ä¸€å¤©ï¼Œé‡ç½®è®¡æ•°ä½†ä¿ç•™æ€»ä½¿ç”¨æ—¶é—´
		if (record.date !== today) {
			const newRecord = {
				date: today,
				saveCount: 0,
				exportCount: 0,
				startTime: Date.now(),
				totalMinutes: record.totalMinutes || 0
			};
			localStorage.setItem('editor_usage', JSON.stringify(newRecord));
			return newRecord;
		}
		
		return record;
	},
	
	// è®°å½•ä¿å­˜
	recordSave() {
		const record = this.getUsageRecord();
		record.saveCount++;
		localStorage.setItem('editor_usage', JSON.stringify(record));
		
		// æ£€æŸ¥æ˜¯å¦è¶…é™
		if (record.saveCount >= this.MAX_SAVES) {
			this.showLimitPopup('save');
			return false;
		}
		return true;
	},
	
	// è®°å½•å¯¼å‡º
	recordExport() {
		const record = this.getUsageRecord();
		record.exportCount++;
		localStorage.setItem('editor_usage', JSON.stringify(record));
		
		if (record.exportCount >= this.MAX_EXPORTS) {
			this.showLimitPopup('export');
			return false;
		}
		return true;
	},
	
	// æ£€æŸ¥ä½¿ç”¨æ—¶é—´ï¼ˆå®šæ—¶æ£€æŸ¥ï¼‰
	checkTimeLimit() {
		const record = this.getUsageRecord();
		const now = Date.now();
		const minutesUsed = ((now - record.startTime) / 60000) + (record.totalMinutes || 0);
		
		// æ›´æ–°æ€»ä½¿ç”¨æ—¶é—´
		record.totalMinutes = minutesUsed;
		record.startTime = now;
		localStorage.setItem('editor_usage', JSON.stringify(record));
		
		if (minutesUsed >= this.MAX_MINUTES) {
			this.showLimitPopup('time');
			return false;
		}
		return true;
	},
	
	// è·å–å‰©ä½™ä¿¡æ¯
	getRemainingInfo() {
		const record = this.getUsageRecord();
		const now = Date.now();
		const minutesUsed = ((now - record.startTime) / 60000) + (record.totalMinutes || 0);
		
		return {
			saves: Math.max(0, this.MAX_SAVES - record.saveCount),
			exports: Math.max(0, this.MAX_EXPORTS - record.exportCount),
			minutes: Math.max(0, this.MAX_MINUTES - minutesUsed),
			totalMinutes: minutesUsed
		};
	},
	
	// æ˜¾ç¤ºé™åˆ¶å¼¹çª—
	showLimitPopup(type) {
		// é˜²æ­¢é‡å¤å¼¹çª—
		if (document.getElementById('limit-popup')) return;
		
		let title, message;
		
		switch(type) {
			case 'save':
				title = 'ğŸ’¾ ä¿å­˜æ¬¡æ•°å·²ç”¨å®Œ';
				message = `æ‚¨ä»Šå¤©å·²ç»ä¿å­˜äº† ${this.MAX_SAVES} æ¬¡æ–‡ä»¶ã€‚<br>
						  å…è´¹ç‰ˆæ¯å¤©æœ€å¤šä¿å­˜ ${this.MAX_SAVES} æ¬¡ã€‚`;
				break;
			case 'export':
				title = 'ğŸ“¤ å¯¼å‡ºæ¬¡æ•°å·²ç”¨å®Œ';
				message = `æ‚¨ä»Šå¤©å·²ç»å¯¼å‡ºäº† ${this.MAX_EXPORTS} æ¬¡ã€‚<br>
						  å…è´¹ç‰ˆæ¯å¤©æœ€å¤šå¯¼å‡º ${this.MAX_EXPORTS} æ¬¡ã€‚`;
				break;
			case 'time':
				title = 'â° ä½¿ç”¨æ—¶é—´å·²ç”¨å®Œ';
				message = `æ‚¨ä»Šå¤©å·²ç»ä½¿ç”¨äº† ${Math.round(this.getRemainingInfo().totalMinutes)} åˆ†é’Ÿã€‚<br>
						  å…è´¹ç‰ˆæ¯å¤©æœ€å¤šä½¿ç”¨ ${this.MAX_MINUTES} åˆ†é’Ÿã€‚`;
				break;
		}
		
		this.createPopupWithWeChat(title, message);
	},
	
		// åˆ›å»ºå¸¦å¾®ä¿¡å·å’Œå¯†ç è§£é”çš„å¼¹çª—
		// ä¿®æ”¹åçš„åˆ›å»ºå¼¹çª—å‡½æ•°ï¼ˆæ·»åŠ æ»šåŠ¨ï¼‰
// ä¿®æ”¹åçš„åˆ›å»ºå¼¹çª—å‡½æ•°ï¼ˆæ·»åŠ æ»šåŠ¨ï¼‰
createPopupWithWeChat(title, message) {
	const popup = document.createElement('div');
	popup.id = 'limit-popup';
	popup.style.cssText = `
		position: fixed;
		top: 0;
		left: 0;
		width: 100%;
		height: 100%;
		background: rgba(0,0,0,0.8);
		z-index: 9999;
		overflow-y: auto;
		-webkit-overflow-scrolling: touch;
		animation: fadeIn 0.3s ease;
	`;
	
	popup.innerHTML = `
		<div style="
			background: white;
			border-radius: 12px;
			width: 90%;
			max-width: 500px;
			margin: 20px auto 50px auto;
			box-shadow: 0 10px 30px rgba(0,0,0,0.3);
			animation: slideUp 0.3s ease;
		">
			<!-- æ ‡é¢˜åŒºåŸŸ -->
			<div style="padding: 20px;">
				<h3 style="margin: 0 0 15px 0; color: #333;">${title}</h3>
				<div style="color: #666; line-height: 1.6; margin-bottom: 20px;">
					${message}
					<div style="margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px; font-size: 14px;">
						<strong>å…è´¹ç‰ˆé™åˆ¶ï¼š</strong><br>
						â€¢ æ¯å¤©ä¿å­˜: ${this.MAX_SAVES} æ¬¡<br>
						â€¢ æ¯å¤©å¯¼å‡º: ${this.MAX_EXPORTS} æ¬¡<br>
						â€¢ æ¯å¤©ä½¿ç”¨: ${this.MAX_MINUTES} åˆ†é’Ÿ
					</div>
				</div>
			</div>
			
			<!-- ä¸“ä¸šç‰ˆä»‹ç» -->
			<div style="padding: 20px;">
				<h4 style="margin: 0 0 15px 0; color: #333;">ğŸ å‡çº§ä¸“ä¸šç‰ˆè§£é”æ‰€æœ‰é™åˆ¶</h4>
				
				<div style="display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap;">
					<div style="flex: 1; min-width: 200px;">
						<div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
									color: white; padding: 20px; border-radius: 8px; text-align: center;">
							<div style="font-size: 24px; font-weight: bold;">ä¸“ä¸šç‰ˆ</div>
							<div style="font-size: 32px; font-weight: bold; margin: 10px 0;">Â¥29.9</div>
							<div style="font-size: 14px; opacity: 0.9;">ä¸€æ¬¡æ€§ä¹°æ–­ï¼Œæ°¸ä¹…ä½¿ç”¨</div>
						</div>
					</div>
					
					<div style="flex: 1; min-width: 200px;">
						<div style="background: #f0f9ff; padding: 20px; border-radius: 8px;">
							<div style="font-weight: bold; margin-bottom: 10px;">ä¸“ä¸šç‰ˆåŠŸèƒ½ï¼š</div>
							<div style="font-size: 14px; color: #666;">
								âœ“ æ— é™åˆ¶ä¿å­˜å’Œå¯¼å‡º<br>
								âœ“ æ— ä½¿ç”¨æ—¶é—´é™åˆ¶<br>
								âœ“ æ›´å¤§å­—å·å’Œæ›´å¤šå…ƒç´ <br>
								âœ“ å»é™¤æ‰€æœ‰å¹¿å‘Š<br>
								âœ“ é«˜çº§å¯¹é½å·¥å…·<br>
								âœ“ ä¼˜å…ˆæŠ€æœ¯æ”¯æŒ
							</div>
						</div>
					</div>
				</div>
				
				<div style="border-top: 1px solid #eee; padding-top: 20px;">
					<div style="margin-bottom: 15px; font-weight: bold; color: #333;">ğŸ“ è”ç³»ä½œè€…è´­ä¹°ï¼š</div>
					
					<div style="background: #e8f5e9; padding: 20px; border-radius: 8px; margin-bottom: 20px; text-align: center;">
						<div style="font-size: 24px; margin-bottom: 10px;">ğŸ’¬ å¾®ä¿¡æ”¯ä»˜</div>
						
						<div style="display: flex; align-items: center; justify-content: center; gap: 15px; margin-bottom: 15px; flex-wrap: wrap;">
							<div style="
								width: 100px;
								height: 100px;
								background: white;
								border-radius: 8px;
								display: flex;
								align-items: center;
								justify-content: center;
								font-size: 36px;
								flex-shrink: 0;
							">
								ğŸ“±
							</div>
							<div style="text-align: left; flex: 1; min-width: 200px;">
								<div style="font-weight: bold; margin-bottom: 5px;">æˆ‘çš„å¾®ä¿¡å·ï¼š</div>
								<div style="
									font-family: monospace;
									font-size: 18px;
									background: white;
									padding: 10px 15px;
									border-radius: 6px;
									border: 2px solid #4CAF50;
									margin-bottom: 10px;
									word-break: break-all;
								" id="wechat-id">Ncj13450098946</div>
								<button onclick="UsageLimit.copyWeChatId()" style="
									padding: 8px 15px;
									background: #4CAF50;
									color: white;
									border: none;
									border-radius: 4px;
									font-size: 14px;
									cursor: pointer;
								">
									ğŸ“‹ å¤åˆ¶å¾®ä¿¡å·
								</button>
							</div>
						</div>
						
						<div style="background: #fff8e1; padding: 10px; border-radius: 6px; margin-top: 10px; font-size: 14px; text-align: left;">
							<strong>è´­ä¹°æµç¨‹ï¼š</strong><br>
							1. æ·»åŠ å¾®ä¿¡å¥½å‹<br>
							2. è½¬è´¦ Â¥29.9 å¹¶å¤‡æ³¨"ä¸“ä¸šç‰ˆ"<br>
							3. æˆ‘ä¼šå‘é€æ¿€æ´»å¯†ç ç»™æ‚¨<br>
							4. åœ¨ä¸‹æ–¹è¾“å…¥å¯†ç è§£é”
						</div>
					</div>
				</div>
			</div>
			
			<!-- å¯†ç è§£é”åŒºåŸŸï¼ˆç§»è‡³åº•éƒ¨ï¼‰ -->
			<div style="background: #e3f2fd; padding: 20px; border-top: 1px solid #eee;">
				<div style="font-weight: bold; margin-bottom: 10px; color: #333;">ğŸ”‘ å·²æœ‰å¯†ç ï¼Ÿç›´æ¥è§£é”</div>
				
				<div style="display: flex; gap: 10px; margin-bottom: 10px; flex-wrap: wrap;">
					<input type="password" id="unlock-password" placeholder="è¯·è¾“å…¥æ¿€æ´»å¯†ç " style="
						flex: 1;
						min-width: 200px;
						padding: 12px 15px;
						border: 2px solid #2196F3;
						border-radius: 6px;
						font-size: 16px;
						outline: none;
					">
					<button onclick="UsageLimit.activateWithPassword()" style="
						padding: 12px 25px;
						background: #2196F3;
						color: white;
						border: none;
						border-radius: 6px;
						font-size: 16px;
						font-weight: bold;
						cursor: pointer;
						white-space: nowrap;
					">
						æ¿€æ´»ä¸“ä¸šç‰ˆ
					</button>
				</div>
				
				<div style="font-size: 12px; color: #666;">
					ğŸ’¡ å¯†ç ä¼šåœ¨æ‚¨ä»˜æ¬¾åé€šè¿‡å¾®ä¿¡å‘é€ï¼Œæœ‰æ•ˆæœŸæ°¸ä¹…
				</div>
				<div id="password-error" style="
					margin-top: 10px;
					color: #f44336;
					font-size: 14px;
					display: none;
				"></div>
			</div>
			
			<!-- åº•éƒ¨æŒ‰é’®åŒºåŸŸ -->
			<div style="padding: 20px; border-top: 1px solid #eee; background: #f8f9fa; border-radius: 0 0 12px 12px;">
				<div style="text-align: center;">
					<button onclick="UsageLimit.copyUserId()" style="
						padding: 12px 25px;
						background: #4CAF50;
						color: white;
						border: none;
						border-radius: 6px;
						font-size: 16px;
						font-weight: bold;
						cursor: pointer;
						margin-right: 10px;
						margin-bottom: 10px;
					">
						ğŸ“‹ å¤åˆ¶æˆ‘çš„ç”¨æˆ·ID
					</button>
					
					<button onclick="UsageLimit.closePopup()" style="
						padding: 12px 25px;
						background: #f5f5f5;
						color: #666;
						border: none;
						border-radius: 6px;
						font-size: 16px;
						cursor: pointer;
						margin-bottom: 10px;
					">
						ç¨åå†è¯´
					</button>
				</div>
			</div>
		</div>
	`;
	
	// æ·»åŠ CSSåŠ¨ç”»
	const style = document.createElement('style');
	style.textContent = `
		@keyframes fadeIn {
			from { opacity: 0; }
			to { opacity: 1; }
		}
		@keyframes slideUp {
			from { 
				opacity: 0;
				transform: translateY(30px);
			}
			to { 
				opacity: 1;
				transform: translateY(0);
			}
		}
		@keyframes shake {
			0%, 100% { transform: translateX(0); }
			10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
			20%, 40%, 60%, 80% { transform: translateX(5px); }
		}
	`;
	document.head.appendChild(style);
	
	document.body.appendChild(popup);
	
	// ç‚¹å‡»èƒŒæ™¯å…³é—­
	popup.onclick = (e) => {
		if (e.target === popup) {
			this.closePopup();
		}
	};
	
	// æŒ‰å›è½¦é”®è¾“å…¥å¯†ç 
	const passwordInput = popup.querySelector('#unlock-password');
	if (passwordInput) {
		passwordInput.addEventListener('keypress', (e) => {
			if (e.key === 'Enter') {
				this.activateWithPassword();
			}
		});
	}
	
	// ç”¨æˆ·ç‚¹å‡»å¯†ç æ¡†æ—¶æ‰å¤„ç†
	passwordInput.addEventListener('focus', function() {
		setTimeout(() => {
			this.scrollIntoView({ block: 'center', behavior: 'smooth' });
		}, 300);
	});
},



	
	// å¤åˆ¶å¾®ä¿¡å·
	copyWeChatId() {
		const wechatId = 'Ncj13450098946';
		navigator.clipboard.writeText(wechatId).then(() => {
			const button = document.querySelector('#limit-popup button[onclick="UsageLimit.copyWeChatId()"]');
			if (button) {
				const originalText = button.textContent;
				button.textContent = 'âœ… å·²å¤åˆ¶ï¼';
				button.style.background = '#4CAF50';
				
				setTimeout(() => {
					button.textContent = originalText;
					button.style.background = '';
				}, 2000);
			}
			showStatusTip(`å¾®ä¿¡å·å·²å¤åˆ¶: ${wechatId}`);
		}).catch(err => {
			// é™çº§æ–¹æ¡ˆ
			const textArea = document.createElement('textarea');
			textArea.value = wechatId;
			document.body.appendChild(textArea);
			textArea.select();
			document.execCommand('copy');
			document.body.removeChild(textArea);
			
			showStatusTip(`å¾®ä¿¡å·å·²å¤åˆ¶: ${wechatId}`);
		});
	},
	
	// ä½¿ç”¨å¯†ç æ¿€æ´»ä¸“ä¸šç‰ˆ
	activateWithPassword() {
		const passwordInput = document.getElementById('unlock-password');
		const errorDiv = document.getElementById('password-error');
		
		if (!passwordInput) return;
		
		const inputPassword = passwordInput.value.trim();
		
		// --- ä¿®æ”¹å¼€å§‹ ---
		// 1. è·å–ä»Šå¤©æ­£ç¡®çš„å¯†ç 
		const correctPassword = getDailyPassword();

		// 2. è¿›è¡ŒéªŒè¯
		if (inputPassword === correctPassword) {
			// å¯†ç æ­£ç¡®ï¼Œæ¿€æ´»ä¸“ä¸šç‰ˆ
			this.activateProVersion();
			this.closePopup();
			showStatusTip('ğŸ‰ æ¿€æ´»æˆåŠŸï¼ä¸“ä¸šç‰ˆå·²è§£é”ï¼');
		} else if (inputPassword === '') {
			// å¯†ç ä¸ºç©º
			errorDiv.textContent = 'è¯·è¾“å…¥æ¿€æ´»å¯†ç ';
			errorDiv.style.display = 'block';
			passwordInput.focus();
		} else {
			// å¯†ç é”™è¯¯
			errorDiv.textContent = 'å¯†ç é”™è¯¯ï¼Œè¯·ç¡®è®¤å¯†ç æˆ–è”ç³»ä½œè€…';
			errorDiv.style.display = 'block';
			passwordInput.select();
			
			// æ·»åŠ æŠ–åŠ¨åŠ¨ç”»
			passwordInput.style.animation = 'shake 0.5s';
			setTimeout(() => {
				passwordInput.style.animation = '';
			}, 500);
		}
	},
	
	// æ¿€æ´»ä¸“ä¸šç‰ˆå‡½æ•°
	activateProVersion() {
		// è®¾ç½®ä¸“ä¸šç‰ˆæ ‡è®°
		const proData = {
			activated: true,
			activationDate: new Date().toISOString(),
			expiryDate: '2099-12-31', // æ°¸ä¹…æœ‰æ•ˆ
			licenseType: 'permanent',
			wechatId: 'Ncj13450098946'
		};
		
		localStorage.setItem('pro_version', JSON.stringify(proData));
		
		// æ¸…é™¤ä½¿ç”¨é™åˆ¶è®°å½•
		localStorage.removeItem('editor_usage');
		
		// æ˜¾ç¤ºæ¿€æ´»æˆåŠŸæ¶ˆæ¯
		this.showActivationSuccess();
		
		// é‡æ–°åŠ è½½é¡µé¢åº”ç”¨ä¸“ä¸šç‰ˆ
		setTimeout(() => {
			location.reload();
		}, 2000);
	},
	
	// æ˜¾ç¤ºæ¿€æ´»æˆåŠŸæ¶ˆæ¯
	showActivationSuccess() {
		const successMsg = document.createElement('div');
		successMsg.style.cssText = `
			position: fixed;
			top: 50%;
			left: 50%;
			transform: translate(-50%, -50%);
			background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
			color: white;
			padding: 30px 50px;
			border-radius: 15px;
			z-index: 10000;
			text-align: center;
			box-shadow: 0 10px 30px rgba(0,0,0,0.3);
			animation: popIn 0.5s ease;
		`;
		
		successMsg.innerHTML = `
			<div style="font-size: 48px; margin-bottom: 20px;">ğŸ‰</div>
			<div style="font-size: 24px; font-weight: bold; margin-bottom: 10px;">æ¿€æ´»æˆåŠŸï¼</div>
			<div style="font-size: 16px; opacity: 0.9;">æ•°å­¦å…¬å¼ç¼–è¾‘å™¨ä¸“ä¸šç‰ˆå·²è§£é”</div>
			<div style="margin-top: 20px; font-size: 14px;">é¡µé¢å°†åœ¨2ç§’ååˆ·æ–°...</div>
		`;
		
		// æ·»åŠ åŠ¨ç”»æ ·å¼
		const style = document.createElement('style');
		style.textContent = `
			@keyframes popIn {
				0% {
					opacity: 0;
					transform: translate(-50%, -50%) scale(0.5);
				}
				70% {
					opacity: 1;
					transform: translate(-50%, -50%) scale(1.1);
				}
				100% {
					opacity: 1;
					transform: translate(-50%, -50%) scale(1);
				}
			}
		`;
		document.head.appendChild(style);
		
		document.body.appendChild(successMsg);
		
		// 3ç§’åç§»é™¤æ¶ˆæ¯
		setTimeout(() => {
			if (successMsg.parentNode) {
				document.body.removeChild(successMsg);
			}
		}, 3000);
	},
	
	// æ£€æŸ¥ä¸“ä¸šç‰ˆçŠ¶æ€
	isProVersion() {
		try {
			const proData = JSON.parse(localStorage.getItem('pro_version') || '{}');
			return proData.activated === true;
		} catch {
			return false;
		}
	},
	
	// ä¸“ä¸šç‰ˆåŠŸèƒ½è§£é”
	applyProFeatures() {
		if (this.isProVersion()) {
			// ç§»é™¤æ‰€æœ‰é™åˆ¶
			this.MAX_SAVES = 99999;
			this.MAX_EXPORTS = 99999;
			this.MAX_MINUTES = 99999;
			
			// éšè—å¹¿å‘Š
			if (typeof SimpleAdSystem !== 'undefined') {
				SimpleAdSystem.removeBannerAd();
			}
			
			// æ·»åŠ ä¸“ä¸šç‰ˆæ ‡è¯†
			this.addProBadge();
			
			// æ›´æ–°æ–‡ä»¶ä¿¡æ¯æ˜¾ç¤º
			this.updateProFileInfo();
			
			console.log('ä¸“ä¸šç‰ˆåŠŸèƒ½å·²åº”ç”¨');
		}
	},
	
	// æ·»åŠ ä¸“ä¸šç‰ˆæ ‡è¯†
	addProBadge() {
		// ç§»é™¤å¯èƒ½å­˜åœ¨çš„æ—§æ ‡è¯†
		const oldBadge = document.getElementById('pro-badge');
		if (oldBadge) oldBadge.remove();
		
		const badge = document.createElement('div');
		badge.id = 'pro-badge';
		badge.style.cssText = `
			position: fixed;
			top: 70px;
			right: 10px;
			background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
			color: white;
			padding: 6px 15px;
			border-radius: 20px;
			font-size: 12px;
			font-weight: bold;
			z-index: 999;
			box-shadow: 0 2px 10px rgba(0,0,0,0.2);
			display: flex;
			align-items: center;
			gap: 5px;
			cursor: pointer;
		`;
		badge.innerHTML = `ğŸ–ï¸ ä¸“ä¸šç‰ˆ`;
		
		// æ·»åŠ ç‚¹å‡»æŸ¥çœ‹æ¿€æ´»ä¿¡æ¯
		badge.onclick = () => this.showActivationInfo();
		
		document.body.appendChild(badge);
	},
	
	// æ˜¾ç¤ºæ¿€æ´»ä¿¡æ¯
	showActivationInfo() {
		const proData = JSON.parse(localStorage.getItem('pro_version') || '{}');
		
		const modal = document.createElement('div');
		modal.style.cssText = `
			position: fixed;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			background: rgba(0,0,0,0.7);
			z-index: 10000;
			display: flex;
			justify-content: center;
			align-items: center;
		`;
		
		modal.innerHTML = `
			<div style="
				background: white;
				border-radius: 12px;
				padding: 30px;
				width: 90%;
				max-width: 400px;
			">
				<h3 style="margin: 0 0 20px 0; color: #333;">ğŸ–ï¸ ä¸“ä¸šç‰ˆä¿¡æ¯</h3>
				
				<div style="margin-bottom: 25px;">
					<div style="display: flex; align-items: center; margin-bottom: 15px;">
						<div style="width: 60px; color: #666;">çŠ¶æ€ï¼š</div>
						<div style="
							background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
							color: white;
							padding: 5px 15px;
							border-radius: 20px;
							font-size: 14px;
							font-weight: bold;
						">å·²æ¿€æ´»</div>
					</div>
					
					<div style="display: flex; align-items: center; margin-bottom: 15px;">
						<div style="width: 60px; color: #666;">ç±»å‹ï¼š</div>
						<div>æ°¸ä¹…æˆæƒ</div>
					</div>
					
					<div style="display: flex; align-items: center; margin-bottom: 15px;">
						<div style="width: 60px; color: #666;">æ¿€æ´»ï¼š</div>
						<div>${proData.activationDate ? new Date(proData.activationDate).toLocaleDateString() : 'æœªçŸ¥'}</div>
					</div>
					
					<div style="display: flex; align-items: center; margin-bottom: 20px;">
						<div style="width: 60px; color: #666;">åˆ°æœŸï¼š</div>
						<div style="color: #4CAF50; font-weight: bold;">æ°¸ä¹…æœ‰æ•ˆ</div>
					</div>
					
					<div style="display: flex; align-items: center;">
						<div style="width: 60px; color: #666;">æ¸ é“ï¼š</div>
						<div>å¾®ä¿¡æ”¯ä»˜</div>
					</div>
				</div>
				
				<div style="border-top: 1px solid #eee; padding-top: 15px;">
					<div style="font-size: 14px; color: #666; margin-bottom: 15px;">
						æ„Ÿè°¢æ‚¨è´­ä¹°æ•°å­¦å…¬å¼ç¼–è¾‘å™¨ä¸“ä¸šç‰ˆï¼
						å¦‚æœ‰é—®é¢˜è¯·è”ç³»å¾®ä¿¡ï¼š<strong>Ncj13450098946</strong>
					</div>
					
					<button onclick="this.parentNode.parentNode.parentNode.remove()" style="
						padding: 10px 20px;
						background: #f5f5f5;
						color: #666;
						border: none;
						border-radius: 6px;
						font-size: 14px;
						cursor: pointer;
						width: 100%;
					">å…³é—­</button>
				</div>
			</div>
		`;
		
		document.body.appendChild(modal);
		
		modal.onclick = (e) => {
			if (e.target === modal) {
				document.body.removeChild(modal);
			}
		};
	},
	
	// æ›´æ–°ä¸“ä¸šç‰ˆæ–‡ä»¶ä¿¡æ¯
	updateProFileInfo() {
		const fileInfo = document.getElementById('file-info-text');
		if (fileInfo) {
			let info = `å½“å‰æ–‡ä»¶: ${Config.currentFileName}`;
			
			if (Config.lastSaveTime) {
				info += ` | æœ€åä¿å­˜: ${formatDate(Config.lastSaveTime, 'HH:mm:ss')}`;
			}
			
			if (Config.hasUnsavedChanges) {
				info += ' â€¢ æœªä¿å­˜';
			}
			
			info += ' â€¢ ğŸ–ï¸ ä¸“ä¸šç‰ˆ';
			fileInfo.textContent = info;
		}
	},
	
	// å¤åˆ¶ç”¨æˆ·ID
	copyUserId() {
		let userId = localStorage.getItem('user_id');
		if (!userId) {
			userId = 'USER_' + Date.now() + '_' + Math.random().toString(36).substr(2, 6).toUpperCase();
			localStorage.setItem('user_id', userId);
		}
		
		// æ·»åŠ ä¸“ä¸šç‰ˆæ ‡è®°
		const isPro = this.isProVersion();
		const textToCopy = `${userId}${isPro ? ' (ä¸“ä¸šç‰ˆ)' : ''}`;
		
		navigator.clipboard.writeText(textToCopy).then(() => {
			const popup = document.getElementById('limit-popup');
			if (popup) {
				const button = popup.querySelector('button[onclick="UsageLimit.copyUserId()"]');
				if (button) {
					const originalText = button.textContent;
					button.textContent = isPro ? 'âœ… ä¸“ä¸šç‰ˆç”¨æˆ·' : 'âœ… å·²å¤åˆ¶ï¼';
					button.style.background = '#4CAF50';
					
					setTimeout(() => {
						button.textContent = originalText;
						button.style.background = '';
					}, 2000);
				}
			}
			
			showStatusTip(`ç”¨æˆ·IDå·²å¤åˆ¶: ${textToCopy}`);
		}).catch(err => {
			// é™çº§æ–¹æ¡ˆ
			const textArea = document.createElement('textarea');
			textArea.value = textToCopy;
			document.body.appendChild(textArea);
			textArea.select();
			document.execCommand('copy');
			document.body.removeChild(textArea);
			
			showStatusTip(`ç”¨æˆ·IDå·²å¤åˆ¶: ${textToCopy}`);
		});
	},
	
	// å…³é—­å¼¹çª—
	closePopup() {
		const popup = document.getElementById('limit-popup');
		if (popup) {
			document.body.removeChild(popup);
		}
	},
	
	// æµ‹è¯•å‡½æ•°ï¼šé‡ç½®ä½¿ç”¨è®°å½•ï¼ˆæ–¹ä¾¿æµ‹è¯•ï¼‰
	resetForTesting() {
		localStorage.removeItem('editor_usage');
		showStatusTip('ä½¿ç”¨è®°å½•å·²é‡ç½®ï¼Œå¯ä»¥é‡æ–°æµ‹è¯•');
	},
	
	// æµ‹è¯•å‡½æ•°ï¼šæ‰‹åŠ¨è§¦å‘é™åˆ¶ï¼ˆæ–¹ä¾¿æµ‹è¯•ï¼‰
	triggerLimitTest(type = 'save') {
		const record = this.getUsageRecord();
		
		switch(type) {
			case 'save':
				record.saveCount = this.MAX_SAVES;
				break;
			case 'export':
				record.exportCount = this.MAX_EXPORTS;
				break;
			case 'time':
				record.totalMinutes = this.MAX_MINUTES;
				break;
		}
		
		localStorage.setItem('editor_usage', JSON.stringify(record));
		this.showLimitPopup(type);
	},
	
	// æµ‹è¯•å‡½æ•°ï¼šæ‰‹åŠ¨æ¿€æ´»ä¸“ä¸šç‰ˆï¼ˆæ–¹ä¾¿æµ‹è¯•ï¼‰
	activateProForTesting() {
		// ç›´æ¥æ¿€æ´»ä¸“ä¸šç‰ˆï¼ˆç”¨äºæµ‹è¯•ï¼‰
		this.activateProVersion();
		showStatusTip('ä¸“ä¸šç‰ˆå·²æ¿€æ´»ï¼ˆæµ‹è¯•æ¨¡å¼ï¼‰');
	}
};

// åˆå§‹åŒ–ä½¿ç”¨æ—¶é—´ç›‘æ§
function initUsageMonitor() {
	// å¦‚æœæ˜¯ä¸“ä¸šç‰ˆï¼Œä¸éœ€è¦ç›‘æ§
	if (UsageLimit.isProVersion()) {
		console.log('ä¸“ä¸šç‰ˆç”¨æˆ·ï¼Œè·³è¿‡ä½¿ç”¨æ—¶é—´ç›‘æ§');
		return;
	}
	
	// æ¯åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡ä½¿ç”¨æ—¶é—´
	setInterval(() => {
		UsageLimit.checkTimeLimit();
	}, 60000); // 1åˆ†é’Ÿ
	
	// å¯åŠ¨æ—¶æ£€æŸ¥ä¸€æ¬¡
	setTimeout(() => {
		UsageLimit.checkTimeLimit();
	}, 5000);
}


// æ£€æŸ¥å…ƒç´ æ˜¯å¦åœ¨è§†å£ä¸­çš„è¾…åŠ©å‡½æ•°
function isElementInViewport(el) {
	if (!el) return false;
	
	const rect = el.getBoundingClientRect();
	return (
		rect.top >= 0 &&
		rect.left >= 0 &&
		rect.bottom <= (window.innerHeight || document.documentElement.clientHeight) &&
		rect.right <= (window.innerWidth || document.documentElement.clientWidth)
	);
}
		
		
		
		

		// ==================== é¢æ¿ç®¡ç† ====================
		function toggleFontPanel() {
			closeAllPanelsExcept('font');
			Config.fontPanelOpen = !Config.fontPanelOpen;
			
			if (Config.fontPanelOpen) {
				fontControls.classList.add('show');
				
				// æ›´æ–°æ»‘å—ä½ç½®
				const selected = getAllSelectedElements();
				if (selected.length > 0) {
					// ä½¿ç”¨é€‰ä¸­å…ƒç´ çš„å­—ä½“å¤§å°
					const fontSize = selected[0].fontSize;
					fontSlider.value = fontSize;
					fontSizeDisplay.textContent = fontSize + 'px';
				} else {
					// ä½¿ç”¨ä¸Šæ¬¡ä¿å­˜çš„å­—ä½“å¤§å°
					const lastFontSize = Config.lastFontSize || 24;
					fontSlider.value = lastFontSize;
					fontSizeDisplay.textContent = lastFontSize + 'px';
				}
				
				// æ›´æ–°é¢„è®¾æŒ‰é’®
				updateFontPresetButtons(parseInt(fontSlider.value));
			} else {
				fontControls.classList.remove('show');
			}
		}

		function toggleAlignPanel() {
			closeAllPanelsExcept('align');
			Config.alignPanelOpen = !Config.alignPanelOpen;
			
			if (Config.alignPanelOpen) {
				alignControls.classList.add('show');
				alignToggleBtn.classList.add('active');
			} else {
				alignControls.classList.remove('show');
				alignToggleBtn.classList.remove('active');
			}
		}

		function toggleNudgePanel() {
			closeAllPanelsExcept('nudge');
			Config.nudgePanelOpen = !Config.nudgePanelOpen;
			
			if (Config.nudgePanelOpen) {
				nudgePanel.classList.add('show');
			} else {
				nudgePanel.classList.remove('show');
			}
		}

		function closeAllPanels() {
			fontControls.classList.remove('show');
			alignControls.classList.remove('show');
			nudgePanel.classList.remove('show');
			alignToggleBtn.classList.remove('active');
			
			Config.fontPanelOpen = false;
			Config.alignPanelOpen = false;
			Config.nudgePanelOpen = false;
		}

		function closeAllPanelsExcept(except) {
			if (except !== 'font') {
				fontControls.classList.remove('show');
				Config.fontPanelOpen = false;
			}
			if (except !== 'align') {
				alignControls.classList.remove('show');
				Config.alignPanelOpen = false;
				alignToggleBtn.classList.remove('active');
			}
			if (except !== 'nudge') {
				nudgePanel.classList.remove('show');
				Config.nudgePanelOpen = false;
			}
		}

		// ==================== å¯¹é½åŠŸèƒ½æ”¹è¿› ====================
		function toggleAlignOption(option) {
			Config.alignOptions[option] = !Config.alignOptions[option];
			updateAlignCheckboxes();
			markUnsavedChanges();
		}

		function updateAlignCheckboxes() {
			document.getElementById('grid-align-checkbox').checked = Config.alignOptions.grid;
			document.getElementById('edge-align-checkbox').checked = Config.alignOptions.edge;
			document.getElementById('center-align-checkbox').checked = Config.alignOptions.center;
		}

		function updateAlignPrecision(value) {
			Config.alignOptions.precision = parseInt(value);
			alignPrecisionDisplay.textContent = value + 'px';
			updatePrecisionPresetButtons('align');
			markUnsavedChanges();
		}

		function setAlignPrecision(precision) {
			Config.alignOptions.precision = precision;
			alignSlider.value = precision;
			alignPrecisionDisplay.textContent = precision + 'px';
			updatePrecisionPresetButtons('align');
			markUnsavedChanges();
		}

		function updatePrecisionPresetButtons(type) {
			const container = type === 'align' ? 
				document.getElementById('precision-preset-container') : 
				document.getElementById('nudge-preset-container');
			const currentValue = type === 'align' ? Config.alignOptions.precision : Config.nudgePrecision;
			
			const buttons = container.querySelectorAll('button');
			buttons.forEach(btn => {
				const btnValue = parseInt(btn.textContent.replace('px', ''));
				if (btnValue === currentValue) {
					btn.classList.add('active');
				} else {
					btn.classList.remove('active');
				}
			});
		}

		// ==================== é«˜çº§å¯¹é½ç®—æ³• ====================
		function calculateSnapPosition(logicX, logicY, elementData) {
			let snapX = logicX;
			let snapY = logicY;
			const lines = [];
			const precision = Config.alignOptions.precision;
			
			// ç½‘æ ¼å¯¹é½ï¼ˆé€»è¾‘ç½‘æ ¼å¤§å°æ˜¯20ï¼‰
			if (Config.alignOptions.grid) {
				const gridSize = 20;  // é€»è¾‘ç½‘æ ¼å¤§å°
				const gridX = Math.round(logicX / gridSize) * gridSize;
				const gridY = Math.round(logicY / gridSize) * gridSize;
				
				if (Math.abs(logicX - gridX) <= precision) {
					snapX = gridX;
					lines.push({ type: 'vertical', position: gridX, isCenter: false });
				}
				if (Math.abs(logicY - gridY) <= precision) {
					snapY = gridY;
					lines.push({ type: 'horizontal', position: gridY, isCenter: false });
				}
			}
			
			// ä¸å…¶ä»–å…ƒç´ å¯¹é½
			State.elements.forEach(otherElement => {
				if (otherElement.id === elementData.id) return;
				
				// è¾¹ç¼˜å¯¹é½
				if (Config.alignOptions.edge) {
					// å·¦è¾¹ç¼˜å¯¹é½
					if (Math.abs(logicX - otherElement.x) <= precision) {
						snapX = otherElement.x;
						lines.push({ type: 'vertical', position: otherElement.x, isCenter: false });
					}
					
					// å³è¾¹ç¼˜å¯¹é½
					const rightX = otherElement.x + otherElement.width - elementData.width;
					if (Math.abs(logicX - rightX) <= precision) {
						snapX = rightX;
						lines.push({ type: 'vertical', position: otherElement.x + otherElement.width, isCenter: false });
					}
					
					// ä¸Šè¾¹ç¼˜å¯¹é½
					if (Math.abs(logicY - otherElement.y) <= precision) {
						snapY = otherElement.y;
						lines.push({ type: 'horizontal', position: otherElement.y, isCenter: false });
					}
					
					// ä¸‹è¾¹ç¼˜å¯¹é½
					const bottomY = otherElement.y + otherElement.height - elementData.height;
					if (Math.abs(logicY - bottomY) <= precision) {
						snapY = bottomY;
						lines.push({ type: 'horizontal', position: otherElement.y + otherElement.height, isCenter: false });
					}
				}
				
				// ä¸­å¿ƒçº¿å¯¹é½
				if (Config.alignOptions.center) {
					const elemCenterX = logicX + elementData.width / 2;
					const elemCenterY = logicY + elementData.height / 2;
					const otherCenterX = otherElement.x + otherElement.width / 2;
					const otherCenterY = otherElement.y + otherElement.height / 2;
					
					// å‚ç›´ä¸­å¿ƒçº¿å¯¹é½
					if (Math.abs(elemCenterX - otherCenterX) <= precision) {
						snapX = otherCenterX - elementData.width / 2;
						lines.push({ type: 'vertical', position: otherCenterX, isCenter: true });
					}
					
					// æ°´å¹³ä¸­å¿ƒçº¿å¯¹é½
					if (Math.abs(elemCenterY - otherCenterY) <= precision) {
						snapY = otherCenterY - elementData.height / 2;
						lines.push({ type: 'horizontal', position: otherCenterY, isCenter: true });
					}
				}
			});
			
			if (snapX !== logicX || snapY !== logicY) {
				return { x: snapX, y: snapY, lines };
			}
			
			return null;
		}

		function showGuides(lines) {
			hideGuides();
			
			lines.forEach(line => {
				if (line.type === 'vertical') {
					// ç›´æ¥è®¡ç®—å±å¹•ä½ç½®ï¼Œä¸å…ƒç´ ä½ç½®è®¡ç®—æ–¹å¼ä¸€è‡´
					const screenX = line.position * Config.zoom;
					
					if (line.isCenter) {
						guideVerticalCenter.style.left = screenX + 'px';
						guideVerticalCenter.style.display = 'block';
					} else {
						guideVertical.style.left = screenX + 'px';
						guideVertical.style.display = 'block';
					}
				} else if (line.type === 'horizontal') {
					// ç›´æ¥è®¡ç®—å±å¹•ä½ç½®ï¼Œä¸å…ƒç´ ä½ç½®è®¡ç®—æ–¹å¼ä¸€è‡´
					const screenY = line.position * Config.zoom;
					
					if (line.isCenter) {
						guideHorizontalCenter.style.top = screenY + 'px';
						guideHorizontalCenter.style.display = 'block';
					} else {
						guideHorizontal.style.top = screenY + 'px';
						guideHorizontal.style.display = 'block';
					}
				}
			});
		}

		function hideGuides() {
			guideVertical.style.display = 'none';
			guideHorizontal.style.display = 'none';
			guideVerticalCenter.style.display = 'none';
			guideHorizontalCenter.style.display = 'none';
		}

		// ==================== å¾®è°ƒåŠŸèƒ½æ”¹è¿› ====================
		function updateNudgePrecision(value) {
			Config.nudgePrecision = parseInt(value);
			nudgePrecisionDisplay.textContent = value + 'px';
			nudgeSlider.value = value;
			updatePrecisionPresetButtons('nudge');
			markUnsavedChanges();
		}

		function setNudgePrecision(precision) {
			Config.nudgePrecision = precision;
			nudgeSlider.value = precision;
			nudgePrecisionDisplay.textContent = precision + 'px';
			updatePrecisionPresetButtons('nudge');
			markUnsavedChanges();
		}

		function nudgeSelected(dx, dy) {
			const selected = getAllSelectedElements();
			
			if (selected.length === 0) {
				showStatusTip('è¯·å…ˆé€‰æ‹©è¦ç§»åŠ¨çš„å…ƒç´ ');
				return;
			}
			
			selected.forEach(el => {
				// dx, dy æ˜¯é€»è¾‘è·ç¦»çš„åç§»é‡
				el.x += dx;
				el.y += dy;
				
				// è¾¹ç•Œæ£€æŸ¥ï¼ˆé€»è¾‘åæ ‡ï¼‰
				el.x = Math.max(0, Math.min(el.x, 2000 - el.width));
				el.y = Math.max(0, Math.min(el.y, 2000 - el.height));
				
				// æ›´æ–°æ˜¾ç¤º
				updateElementDisplay(el);
			});
			
			showStatusTip(`å·²å¾®è°ƒ ${selected.length} ä¸ªå…ƒç´ `);
			markUnsavedChanges();
		}
		
		
		// ==================== å¾®è°ƒé¢æ¿æ‹–æ‹½åŠŸèƒ½ ====================
let nudgePanelDragging = false;
let nudgePanelDragStartX = 0;
let nudgePanelDragStartY = 0;
let nudgePanelStartLeft = 0;
let nudgePanelStartTop = 0;

// åˆå§‹åŒ–å¾®è°ƒé¢æ¿æ‹–æ‹½åŠŸèƒ½
function initNudgePanelDrag() {
	const panel = document.getElementById('nudge-panel');
	const header = document.getElementById('nudge-panel-header');
	
	if (!panel || !header) return;
	
	// é¼ æ ‡æŒ‰ä¸‹å¼€å§‹æ‹–æ‹½
	header.addEventListener('mousedown', startNudgePanelDrag);
	header.addEventListener('touchstart', startNudgePanelDragTouch);
	
	// é˜»æ­¢æ ‡é¢˜æ å†…çš„æŒ‰é’®è§¦å‘æ‹–æ‹½
	const closeBtn = header.querySelector('.panel-close');
	if (closeBtn) {
		closeBtn.addEventListener('mousedown', function(e) {
			e.stopPropagation();
		});
		closeBtn.addEventListener('touchstart', function(e) {
			e.stopPropagation();
		});
	}
}

// å¼€å§‹æ‹–æ‹½ï¼ˆé¼ æ ‡ï¼‰
function startNudgePanelDrag(e) {
	if (e.button !== 0) return; // åªå“åº”å·¦é”®
	
	const panel = document.getElementById('nudge-panel');
	const header = document.getElementById('nudge-panel-header');
	
	nudgePanelDragging = true;
	nudgePanelDragStartX = e.clientX;
	nudgePanelDragStartY = e.clientY;
	
	// è·å–é¢æ¿å½“å‰ä½ç½®
	const rect = panel.getBoundingClientRect();
	nudgePanelStartLeft = rect.left;
	nudgePanelStartTop = rect.top;
	
	// æ·»åŠ æ‹–æ‹½æ ·å¼
	header.classList.add('dragging');
	
	// ç»‘å®šç§»åŠ¨å’Œç»“æŸäº‹ä»¶
	document.addEventListener('mousemove', doNudgePanelDrag);
	document.addEventListener('mouseup', stopNudgePanelDrag);
	
	e.preventDefault();
}

// å¼€å§‹æ‹–æ‹½ï¼ˆè§¦æ‘¸ï¼‰
function startNudgePanelDragTouch(e) {
	if (e.touches.length !== 1) return;
	
	const panel = document.getElementById('nudge-panel');
	const header = document.getElementById('nudge-panel-header');
	
	nudgePanelDragging = true;
	const touch = e.touches[0];
	nudgePanelDragStartX = touch.clientX;
	nudgePanelDragStartY = touch.clientY;
	
	// è·å–é¢æ¿å½“å‰ä½ç½®
	const rect = panel.getBoundingClientRect();
	nudgePanelStartLeft = rect.left;
	nudgePanelStartTop = rect.top;
	
	// æ·»åŠ æ‹–æ‹½æ ·å¼
	header.classList.add('dragging');
	
	// ç»‘å®šç§»åŠ¨å’Œç»“æŸäº‹ä»¶
	document.addEventListener('touchmove', doNudgePanelDragTouch);
	document.addEventListener('touchend', stopNudgePanelDrag);
	document.addEventListener('touchcancel', stopNudgePanelDrag);
	
	e.preventDefault();
}

// æ‰§è¡Œæ‹–æ‹½ï¼ˆé¼ æ ‡ï¼‰
function doNudgePanelDrag(e) {
	if (!nudgePanelDragging) return;
	
	const panel = document.getElementById('nudge-panel');
	const deltaX = e.clientX - nudgePanelDragStartX;
	const deltaY = e.clientY - nudgePanelDragStartY;
	
	// è®¡ç®—æ–°ä½ç½®
	let newLeft = nudgePanelStartLeft + deltaX;
	let newTop = nudgePanelStartTop + deltaY;
	
	// è¾¹ç•Œæ£€æŸ¥ï¼Œç¡®ä¿é¢æ¿ä¸ä¼šç§»å‡ºå±å¹•
	const maxLeft = window.innerWidth - panel.offsetWidth;
	const maxTop = window.innerHeight - panel.offsetHeight;
	
	newLeft = Math.max(0, Math.min(newLeft, maxLeft));
	newTop = Math.max(0, Math.min(newTop, maxTop));
	
	// åº”ç”¨æ–°ä½ç½®
	panel.style.left = newLeft + 'px';
	panel.style.top = newTop + 'px';
	panel.style.right = 'auto'; // æ¸…é™¤åŸæœ‰çš„rightå®šä½
	panel.style.bottom = 'auto'; // æ¸…é™¤åŸæœ‰çš„bottomå®šä½
	
	e.preventDefault();
}

// æ‰§è¡Œæ‹–æ‹½ï¼ˆè§¦æ‘¸ï¼‰
function doNudgePanelDragTouch(e) {
	if (!nudgePanelDragging || e.touches.length !== 1) return;
	
	const panel = document.getElementById('nudge-panel');
	const touch = e.touches[0];
	const deltaX = touch.clientX - nudgePanelDragStartX;
	const deltaY = touch.clientY - nudgePanelDragStartY;
	
	// è®¡ç®—æ–°ä½ç½®
	let newLeft = nudgePanelStartLeft + deltaX;
	let newTop = nudgePanelStartTop + deltaY;
	
	// è¾¹ç•Œæ£€æŸ¥
	const maxLeft = window.innerWidth - panel.offsetWidth;
	const maxTop = window.innerHeight - panel.offsetHeight;
	
	newLeft = Math.max(0, Math.min(newLeft, maxLeft));
	newTop = Math.max(0, Math.min(newTop, maxTop));
	
	// åº”ç”¨æ–°ä½ç½®
	panel.style.left = newLeft + 'px';
	panel.style.top = newTop + 'px';
	panel.style.right = 'auto';
	panel.style.bottom = 'auto';
	
	e.preventDefault();
}

// åœæ­¢æ‹–æ‹½
function stopNudgePanelDrag() {
	if (!nudgePanelDragging) return;
	
	nudgePanelDragging = false;
	const header = document.getElementById('nudge-panel-header');
	header.classList.remove('dragging');
	
	// ç§»é™¤äº‹ä»¶ç›‘å¬å™¨
	document.removeEventListener('mousemove', doNudgePanelDrag);
	document.removeEventListener('mouseup', stopNudgePanelDrag);
	document.removeEventListener('touchmove', doNudgePanelDragTouch);
	document.removeEventListener('touchend', stopNudgePanelDrag);
	document.removeEventListener('touchcancel', stopNudgePanelDrag);
	
	// ä¿å­˜é¢æ¿ä½ç½®åˆ°æœ¬åœ°å­˜å‚¨ï¼ˆå¯é€‰ï¼‰
	savePanelPosition();
}

// ä¿å­˜é¢æ¿ä½ç½®ï¼ˆå¯é€‰åŠŸèƒ½ï¼‰
function savePanelPosition() {
	const panel = document.getElementById('nudge-panel');
	if (!panel) return;
	
	const position = {
		left: panel.style.left,
		top: panel.style.top,
		isPositioned: panel.style.left !== '' && panel.style.top !== ''
	};
	
	try {
		localStorage.setItem('nudgePanelPosition', JSON.stringify(position));
	} catch (e) {
		console.error('ä¿å­˜é¢æ¿ä½ç½®å¤±è´¥:', e);
	}
}

// åŠ è½½é¢æ¿ä½ç½®ï¼ˆå¯é€‰åŠŸèƒ½ï¼‰
function loadPanelPosition() {
	try {
		const saved = localStorage.getItem('nudgePanelPosition');
		if (saved) {
			const position = JSON.parse(saved);
			const panel = document.getElementById('nudge-panel');
			
			if (panel && position.isPositioned) {
				panel.style.left = position.left;
				panel.style.top = position.top;
				panel.style.right = 'auto';
				panel.style.bottom = 'auto';
			}
		}
	} catch (e) {
		console.error('åŠ è½½é¢æ¿ä½ç½®å¤±è´¥:', e);
	}
}

// é‡ç½®é¢æ¿ä½ç½®ï¼ˆç”¨äºè°ƒè¯•ï¼‰
function resetNudgePanelPosition() {
	const panel = document.getElementById('nudge-panel');
	if (panel) {
		panel.style.left = '10px';
		panel.style.top = '';
		panel.style.right = '';
		panel.style.bottom = '70px';
		
		try {
			localStorage.removeItem('nudgePanelPosition');
		} catch (e) {
			console.error('é‡ç½®é¢æ¿ä½ç½®å¤±è´¥:', e);
		}
	}
}
		
		
		
		

		// ==================== æ™ºèƒ½å­—ä½“é¢„è®¾ç³»ç»Ÿ ====================
		function recordFontSizeUsage(fontSize) {
			if (!State.fontUsageHistory[fontSize]) {
				State.fontUsageHistory[fontSize] = 0;
			}
			
			// å¢åŠ ä½¿ç”¨æ¬¡æ•°
			State.fontUsageHistory[fontSize]++;
			
			// æ·»åŠ åˆ°æœ€è¿‘ä½¿ç”¨è®°å½•ï¼ˆæŒ‰ä½¿ç”¨æ—¶é—´æ’åºï¼‰
			if (!Config.recentFontSizes) {
				Config.recentFontSizes = [];
			}
			
			// ç§»é™¤å·²å­˜åœ¨çš„ç›¸åŒå€¼
			Config.recentFontSizes = Config.recentFontSizes.filter(size => size !== fontSize);
			
			// æ·»åŠ åˆ°æ•°ç»„å¼€å¤´ï¼ˆæœ€æ–°ä½¿ç”¨ï¼‰
			Config.recentFontSizes.unshift(fontSize);
			
			// é™åˆ¶æœ€è¿‘ä½¿ç”¨è®°å½•æ•°é‡ï¼ˆä¿ç•™æœ€å¤š8ä¸ªï¼Œç”¨äºè®¡ç®—å¸¸ç”¨å€¼ï¼‰
			if (Config.recentFontSizes.length > 8) {
				Config.recentFontSizes = Config.recentFontSizes.slice(0, 8);
			}
			
			// æ ¹æ®ä½¿ç”¨é¢‘ç‡è®¡ç®—å¸¸ç”¨å­—ä½“å¤§å°ï¼ˆä¸åŒ…æ‹¬å½“å‰å€¼ï¼‰
			const allSizes = Object.keys(State.fontUsageHistory)
				.map(Number)
				.filter(size => size !== fontSize); // æ’é™¤å½“å‰å€¼
			
			const sortedByFrequency = allSizes.sort((a, b) => {
				if (State.fontUsageHistory[b] !== State.fontUsageHistory[a]) {
					return State.fontUsageHistory[b] - State.fontUsageHistory[a];
				}
				return Math.abs(b - fontSize) - Math.abs(a - fontSize); // ä¸å½“å‰å€¼æ¥è¿‘çš„ä¼˜å…ˆ
			});
			
			// è·å–æœ€å¸¸ç”¨çš„3ä¸ªå€¼
			const topFrequent = sortedByFrequency.slice(0, 3);
			
			// æ›´æ–°å­—ä½“å†å²ï¼šå½“å‰å€¼ + æœ€å¸¸ç”¨çš„3ä¸ªå€¼
			Config.fontSizeHistory = [fontSize, ...topFrequent].slice(0, 4);
			
			// ä¿å­˜è®¾ç½®
			saveSettings();
			
			// æ›´æ–°é¢„è®¾æŒ‰é’®
			updateFontPresetButtons(fontSize);
		}

		function updateFontPresetButtons(currentSize = null) {
			if (!fontPresetContainer) return;
			
			fontPresetContainer.innerHTML = '';
			
			// è·å–å½“å‰å­—ä½“å¤§å°
			const currentFontSize = currentSize || parseInt(fontSlider.value);
			
			// ç¡®ä¿å½“å‰å€¼åœ¨å†å²è®°å½•ä¸­
			if (!Config.fontSizeHistory.includes(currentFontSize)) {
				// å¦‚æœå†å²è®°å½•ä¸ºç©ºï¼Œä½¿ç”¨å½“å‰å€¼
				if (Config.fontSizeHistory.length === 0) {
					Config.fontSizeHistory = [currentFontSize];
				} else {
					// æ›¿æ¢æœ€åä¸€ä¸ªå€¼
					Config.fontSizeHistory[Config.fontSizeHistory.length - 1] = currentFontSize;
				}
			}
			
			// ç¡®ä¿æ˜¾ç¤º4ä¸ªä¸åŒçš„å€¼
			let displaySizes = [...new Set(Config.fontSizeHistory)]; // å»é‡
			if (displaySizes.length < 4) {
				// å¦‚æœä¸å¤Ÿ4ä¸ªï¼Œè¡¥å……ä¸€äº›å¸¸ç”¨å€¼
				const commonSizes = [16, 24, 32, 40];
				for (let size of commonSizes) {
					if (!displaySizes.includes(size) && displaySizes.length < 4) {
						displaySizes.push(size);
					}
				}
			}
			
			// ç¡®ä¿å½“å‰å€¼åœ¨æ˜¾ç¤ºåˆ—è¡¨ä¸­ï¼ˆå¦‚æœæ˜¯æ–°å€¼ï¼‰
			if (!displaySizes.includes(currentFontSize)) {
				// å¦‚æœå·²æœ‰4ä¸ªå€¼ï¼Œæ›¿æ¢æ‰ä½¿ç”¨æ¬¡æ•°æœ€å°‘çš„é‚£ä¸ª
				if (displaySizes.length >= 4) {
					// æ‰¾åˆ°ä½¿ç”¨æ¬¡æ•°æœ€å°‘çš„
					let minUsage = Infinity;
					let minIndex = 0;
					for (let i = 1; i < displaySizes.length; i++) { // ä»1å¼€å§‹ï¼Œè·³è¿‡å½“å‰å€¼
						const usage = State.fontUsageHistory[displaySizes[i]] || 0;
						if (usage < minUsage) {
							minUsage = usage;
							minIndex = i;
						}
					}
					// æ›¿æ¢ä½¿ç”¨æ¬¡æ•°æœ€å°‘çš„
					displaySizes[minIndex] = currentFontSize;
				} else {
					displaySizes.push(currentFontSize);
				}
			}
			
			// ç¡®ä¿æ˜¾ç¤º4ä¸ªä¸åŒçš„å€¼
			displaySizes = [...new Set(displaySizes)].slice(0, 4);
			
			// æŒ‰ä¸å½“å‰å€¼çš„æ¥è¿‘ç¨‹åº¦æ’åºï¼ˆå½“å‰å€¼æ’ç¬¬ä¸€ï¼‰
			displaySizes.sort((a, b) => {
				if (a === currentFontSize) return -1;
				if (b === currentFontSize) return 1;
				return Math.abs(a - currentFontSize) - Math.abs(b - currentFontSize);
			});
			
			// æ·»åŠ é¢„è®¾æŒ‰é’®
			displaySizes.forEach(size => {
				const presetBtn = document.createElement('button');
				presetBtn.className = 'font-preset-btn';
				
				// é«˜äº®æ˜¾ç¤ºå½“å‰å­—ä½“å¤§å°
				const isCurrent = size === currentFontSize;
				
				if (isCurrent) {
					presetBtn.classList.add('active');
				}
				
				const usageCount = State.fontUsageHistory[size] || 0;
				const usageText = usageCount > 0 ? `${usageCount}æ¬¡` : 'æ–°';
				
				presetBtn.innerHTML = `
					<span class="font-size-value">${size}px</span>
					<span class="font-preset-badge">${usageText}</span>
				`;
				
				presetBtn.onclick = () => {
					// æ›´æ–°æ»‘å—å€¼
					fontSlider.value = size;
					fontSizeDisplay.textContent = size + 'px';
					
					// ä¿å­˜å½“å‰å­—ä½“å¤§å°
					saveCurrentFontSize(size);
					
					// æ›´æ–°é¢„è®¾æŒ‰é’®é«˜äº®
					document.querySelectorAll('.font-preset-btn').forEach(btn => {
						btn.classList.remove('active');
					});
					presetBtn.classList.add('active');
				};
				
				fontPresetContainer.appendChild(presetBtn);
			});
		}

		function updateFontSize(value) {
			const fontSize = parseInt(value);
			fontSizeDisplay.textContent = fontSize + 'px';
			fontSlider.value = fontSize;
			
			// å®æ—¶æ›´æ–°é€‰ä¸­å…ƒç´ çš„å­—ä½“å¤§å°
			const selected = getAllSelectedElements();
			if (selected.length > 0) {
				// ä½¿ç”¨é˜²æŠ–æŠ€æœ¯é¿å…è¿‡äºé¢‘ç¹çš„æ›´æ–°
				clearTimeout(fontSlider.debounceTimer);
				fontSlider.debounceTimer = setTimeout(() => {
					selected.forEach(el => {
						// æ›´æ–°é€»è¾‘å­—ä½“å¤§å°
						el.fontSize = fontSize;
						
						// æ›´æ–°æ˜¾ç¤º
						updateElementDisplay(el);
					});
					
					// ç«‹å³æ›´æ–°å½“å‰é«˜äº®çš„é¢„è®¾æŒ‰é’®
					updateFontPresetButtons(fontSize);
					
					// æ˜¾ç¤ºå³æ—¶é¢„è§ˆæç¤º
					showStatusTip(`å®æ—¶é¢„è§ˆ: ${fontSize}px`, 800);
				}, 50); // 50msçš„é˜²æŠ–å»¶è¿Ÿ
			}
		}

		function applyFontToSelected() {
			const fontSize = parseInt(fontSlider.value);
			const selected = getAllSelectedElements();
			
			if (selected.length === 0) {
				showStatusTip('è¯·å…ˆé€‰æ‹©è¦ä¿®æ”¹çš„å…ƒç´ ');
				return;
			}
			
			selected.forEach(el => {
				// æ›´æ–°é€»è¾‘å­—ä½“å¤§å°
				el.fontSize = fontSize;
				
				// æ›´æ–°æ˜¾ç¤º
				updateElementDisplay(el);
			});
			
			// ä¿å­˜å½“å‰å­—ä½“å¤§å°
			saveCurrentFontSize(fontSize);
			
			// è®°å½•å­—ä½“ä½¿ç”¨
			recordFontSizeUsage(fontSize);
			
			showStatusTip(`å·²åº”ç”¨åˆ° ${selected.length} ä¸ªå…ƒç´  (${fontSize}px)`);
			markUnsavedChanges();
		}

		function showBriefStatusTip(message, duration = 1000) {
			const tempTip = document.createElement('div');
			tempTip.className = 'status-tip';
			tempTip.textContent = message;
			tempTip.style.bottom = '150px';
			tempTip.style.zIndex = '2000';
			document.body.appendChild(tempTip);
			
			setTimeout(() => {
				tempTip.remove();
			}, duration);
		}

		function saveCurrentFontSize(fontSize) {
			// ä¿å­˜åˆ°é…ç½®
			Config.lastFontSize = fontSize;
			
			// è®°å½•ä½¿ç”¨å†å²
			recordFontSizeUsage(fontSize);
			
			// ä¿å­˜è®¾ç½®
			saveSettings();
			
			// åº”ç”¨åˆ°é€‰ä¸­å…ƒç´ 
			const selected = getAllSelectedElements();
			if (selected.length > 0) {
				selected.forEach(el => {
					el.fontSize = fontSize;
					updateElementDisplay(el);
				});
				showStatusTip(`å·²åº”ç”¨å­—ä½“å¤§å°: ${fontSize}px`);
				markUnsavedChanges();
			} else {
				showStatusTip(`å·²è®¾ç½®å­—ä½“å¤§å°: ${fontSize}px`);
			}
		}

		function applyFontToAll() {
			const fontSize = parseInt(fontSlider.value);
			
			State.elements.forEach(el => {
				// æ›´æ–°é€»è¾‘å­—ä½“å¤§å°
				el.fontSize = fontSize;
				
				// æ›´æ–°æ˜¾ç¤º
				updateElementDisplay(el);
			});
			
			// ä¿å­˜å½“å‰å­—ä½“å¤§å°
			saveCurrentFontSize(fontSize);
			
			// è®°å½•å­—ä½“ä½¿ç”¨
			recordFontSizeUsage(fontSize);
			
			showStatusTip(`å·²åº”ç”¨åˆ°æ‰€æœ‰å…ƒç´  (${fontSize}px)`);
			markUnsavedChanges();
		}

		function updateSelectedFontSize(size) {
			const fontSize = parseInt(size);
			fontSizeDisplay.textContent = fontSize + 'px';
			fontSlider.value = fontSize;
			
			const selected = getAllSelectedElements();
			if (selected.length === 0) {
				showStatusTip('è¯·å…ˆé€‰æ‹©è¦ä¿®æ”¹çš„å…ƒç´ ');
				return;
			}
			
			selected.forEach(el => {
				el.fontSize = fontSize;
				updateElementDisplay(el);
			});
			
			recordFontSizeUsage(fontSize);
			showStatusTip(`å·²æ›´æ–° ${selected.length} ä¸ªå…ƒç´  (${fontSize}px)`);
			markUnsavedChanges();
		}

		function updateFontControlsForSelection() {
			const selected = getAllSelectedElements();
			if (selected.length > 0) {
				const avgFontSize = selected.reduce((sum, el) => sum + el.fontSize, 0) / selected.length;
				fontSlider.value = Math.round(avgFontSize);
				fontSizeDisplay.textContent = Math.round(avgFontSize) + 'px';
			}
		}

		// ==================== ç½‘æ ¼åŠŸèƒ½ ====================
		function toggleGrid() {
			Config.gridEnabled = !Config.gridEnabled;
			updateGrid();
			updateGridButton();
			showStatusTip(`ç½‘æ ¼: ${Config.gridEnabled ? 'å¼€' : 'å…³'}`);
			markUnsavedChanges();
		}
		
		function updateGridForZoom() {
			if (Config.gridEnabled) {
				// ç½‘æ ¼å¤§å°éšç¼©æ”¾å˜åŒ–ï¼Œä½†ä¿æŒè§†è§‰ä¸€è‡´æ€§
				// åŸºç¡€ç½‘æ ¼å¤§å°æ˜¯20pxï¼Œä¹˜ä»¥å½“å‰ç¼©æ”¾ç³»æ•°
				const baseGridSize = 20;
				const visualGridSize = baseGridSize * Config.zoom;
				editorArea.style.backgroundSize = `${visualGridSize}px ${visualGridSize}px`;
				
				// è°ƒæ•´ç½‘æ ¼çº¿é€æ˜åº¦ï¼Œä½¿å…¶åœ¨ç¼©æ”¾æ—¶ä¿æŒè§†è§‰ä¸€è‡´æ€§
				const opacity = Math.max(0.02, Math.min(0.1, 0.05 / Config.zoom));
				editorArea.style.backgroundImage = `
					linear-gradient(rgba(0,0,0,${opacity}) 1px, transparent 1px),
					linear-gradient(90deg, rgba(0,0,0,${opacity}) 1px, transparent 1px)`;
			}
		}

		function updateGrid() {
			if (Config.gridEnabled) {
				updateGridForZoom();
			} else {
				editorArea.style.backgroundImage = 'none';
			}
		}

		function updateGridButton() {
			if (Config.gridEnabled) {
				gridToggleBtn.classList.add('active-grid');
				gridIcon.textContent = 'âœ…';
			} else {
				gridToggleBtn.classList.remove('active-grid');
				gridIcon.textContent = 'â¬œ';
			}
		}
		
		// ==================== æ–‡ä»¶æ“ä½œåŠŸèƒ½ ====================
		// æ–°å»ºæ–‡ä»¶
		function newFile() {
			handleMenuItemClick(); // å…³é—­èœå•
			if (Config.hasUnsavedChanges) {
				showConfirmDialog(
					'æœªä¿å­˜çš„æ›´æ”¹',
					'å½“å‰æ–‡ä»¶æœ‰æœªä¿å­˜çš„æ›´æ”¹ï¼Œæ˜¯å¦è¦ä¿å­˜ï¼Ÿ',
					'newFileAfterConfirm',
					'ä¿å­˜',
					'ä¸ä¿å­˜',
					'å–æ¶ˆ'
				);
			} else {
				createNewFile();
			}
		}

		// ç¡®è®¤åæ–°å»ºæ–‡ä»¶
		function newFileAfterConfirm(action) {
			if (action === 'save') {
				saveFile().then(saved => {
					if (saved) {
						createNewFile();
					}
				});
			} else if (action === 'dontsave') {
				createNewFile();
			}
			hideConfirmDialog();
		}

		// åˆ›å»ºæ–°æ–‡ä»¶
		function createNewFile() {
			// æ¸…ç©ºæ‰€æœ‰å…ƒç´ 
			State.elements.forEach(el => {
				if (el.element && el.element.parentNode) {
					el.element.parentNode.removeChild(el.element);
				}
			});
			
			State.elements = [];
			State.selectedIds.clear();
			State.clickSelectedIds.clear();
			State.dragSelectedIds.clear();
			
			// é‡ç½®çŠ¶æ€
			Config.hasUnsavedChanges = false;
			Config.currentFileName = "æœªå‘½å";
			Config.lastSaveTime = null;
			
			// é‡ç½®ç¼©æ”¾
			Config.zoom = 1;
			
			// é‡ç½®æ»šåŠ¨ä½ç½®
			editorContainer.scrollLeft = 900;
			editorContainer.scrollTop = 900;
			
			// æ›´æ–°æ–‡ä»¶ä¿¡æ¯
			updateFileInfo();
			
			// æ›´æ–°UI
			updateZoomIndicator();
			updateAllElementsDisplay();  // ç¡®ä¿æ˜¾ç¤ºæ­£ç¡®
			
			showStatusTip('å·²åˆ›å»ºæ–°æ–‡ä»¶');
			
			// ä¿å­˜å½“å‰æ–‡ä»¶çŠ¶æ€åˆ°localStorage
			saveCurrentFileState();
		}

		// åˆ›å»ºæŒ‡å®šåç§°çš„æ–°æ–‡ä»¶
		function createNewNamedFile() {
			const fileName = newFilenameInput.value.trim();
			if (!fileName) {
				showStatusTip('è¯·è¾“å…¥æ–‡ä»¶å');
				return;
			}
			
			hideFileList();
			createNewFile();
			Config.currentFileName = fileName;
			updateFileInfo();
			
			// ç«‹å³ä¿å­˜æ–°æ–‡ä»¶
			saveFile().then(saved => {
				if (saved) {
					showStatusTip(`å·²åˆ›å»ºå¹¶ä¿å­˜æ–‡ä»¶: ${fileName}`);
				}
			});
		}

		// æ˜¾ç¤ºæ–‡ä»¶åˆ—è¡¨
		function showFileList() {
			handleMenuItemClick(); // å…³é—­èœå•
			
			// è·å–æ‰€æœ‰æ–‡ä»¶
			const files = StorageManager.getAllFiles();
			
			// æ¸…ç©ºæ–‡ä»¶åˆ—è¡¨
			fileList.innerHTML = '';
			
			// æ·»åŠ ä¸Šä¼ æŒ‰é’®
			const uploadItem = document.createElement('div');
			uploadItem.className = 'file-item';
			uploadItem.style.borderBottom = '2px solid #2196F3';
			uploadItem.innerHTML = `
				<div style="display: flex; align-items: center; gap: 10px; width: 100%;">
					<span style="font-size: 20px;">ğŸ“¤</span>
					<div style="flex: 1;">
						<div style="font-weight: bold; color: #2196F3;">ä»ç”µè„‘ä¸Šä¼ æ–‡ä»¶</div>
						<div style="font-size: 12px; color: #666;">ç‚¹å‡»æ­¤å¤„ä¸Šä¼ æœ¬åœ°ä¿å­˜çš„ .json æ–‡ä»¶</div>
					</div>
				</div>
			`;
			
			uploadItem.addEventListener('click', async function() {
				const uploadResult = await StorageManager.uploadFile();
				if (uploadResult) {
					const { fileName, data } = uploadResult;
					
					// ä¿å­˜ä¸Šä¼ çš„æ–‡ä»¶åˆ°æœ¬åœ°å­˜å‚¨
					const files = StorageManager.getAllFiles();
					files[fileName] = data;
					StorageManager.saveFileList(files);
					
					// é‡æ–°åŠ è½½æ–‡ä»¶åˆ—è¡¨
					showFileList();
					showStatusTip(`å·²ä¸Šä¼ æ–‡ä»¶: ${fileName}`);
				}
			});
			
			fileList.appendChild(uploadItem);
			
			// å¦‚æœæ²¡æœ‰æ–‡ä»¶ï¼Œæ˜¾ç¤ºæç¤º
			if (Object.keys(files).length === 0) {
				const emptyItem = document.createElement('div');
				emptyItem.innerHTML = '<div style="padding: 20px; text-align: center; color: #666;">æš‚æ— ä¿å­˜çš„æ–‡ä»¶ï¼Œè¯·å…ˆåˆ›å»ºæˆ–ä¸Šä¼ æ–‡ä»¶</div>';
				fileList.appendChild(emptyItem);
			} else {
				// æŒ‰ä¿®æ”¹æ—¶é—´æ’åºï¼ˆæœ€æ–°çš„åœ¨å‰é¢ï¼‰
				const sortedFiles = Object.entries(files).sort((a, b) => {
					return new Date(b[1].updated) - new Date(a[1].updated);
				});
				
				// æ·»åŠ æ–‡ä»¶åˆ—è¡¨é¡¹
				sortedFiles.forEach(([fileName, fileData]) => {
					const fileItem = document.createElement('div');
					fileItem.className = 'file-item';
					
					const fileDate = new Date(fileData.updated);
					const dateStr = formatDate(fileDate, 'YYYY-MM-DD HH:mm');
					
					fileItem.innerHTML = `
						<div class="file-info-container">
							<div class="file-name">${fileName}</div>
							<div class="file-date">æœ€åä¿®æ”¹: ${dateStr}</div>
						</div>
						<div class="file-actions">
							<button class="file-action-btn delete" 
									data-filename="${fileName}"
									onclick="handleDeleteFile('${fileName}', event)">
								åˆ é™¤
							</button>
						</div>
					`;
					
					// æ–‡ä»¶é¡¹ç‚¹å‡»äº‹ä»¶ - æ‰“å¼€æ–‡ä»¶
					fileItem.querySelector('.file-info-container').addEventListener('click', function() {
						openFile(fileName);
					});
					
					fileList.appendChild(fileItem);
				});
			}
			
			// æ˜¾ç¤ºæ–‡ä»¶åˆ—è¡¨å¯¹è¯æ¡†
			fileListDialog.style.display = 'flex';
			
			// æ¸…ç©ºæ–°æ–‡ä»¶åè¾“å…¥æ¡†
			newFilenameInput.value = '';
		}

		// å¤„ç†åˆ é™¤æ–‡ä»¶
		function handleDeleteFile(fileName, event) {
			if (event) {
				event.stopPropagation();
				event.preventDefault();
			}
			
			State.pendingAction = { type: 'delete', fileName };
			showConfirmDialog(
				'åˆ é™¤æ–‡ä»¶',
				`ç¡®å®šè¦åˆ é™¤æ–‡ä»¶ "${fileName}" å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚`,
				'deleteFileConfirm',
				'åˆ é™¤',
				'å–æ¶ˆ'
			);
		}

		// éšè—æ–‡ä»¶åˆ—è¡¨
		function hideFileList() {
			fileListDialog.style.display = 'none';
		}

		// æ‰“å¼€æ–‡ä»¶
		function openFile(fileName) {
			if (Config.hasUnsavedChanges) {
				State.pendingAction = { type: 'open', fileName };
				showConfirmDialog(
					'æœªä¿å­˜çš„æ›´æ”¹',
					'å½“å‰æ–‡ä»¶æœ‰æœªä¿å­˜çš„æ›´æ”¹ï¼Œæ˜¯å¦è¦ä¿å­˜ï¼Ÿ',
					'openFileAfterConfirm',
					'ä¿å­˜',
					'ä¸ä¿å­˜',
					'å–æ¶ˆ'
				);
			} else {
				loadFile(fileName);
			}
		}

		// ç¡®è®¤åæ‰“å¼€æ–‡ä»¶
		function openFileAfterConfirm(action) {
			if (action === 'save') {
				saveFile().then(saved => {
					if (saved && State.pendingAction && State.pendingAction.type === 'open') {
						loadFile(State.pendingAction.fileName);
					}
				});
			} else if (action === 'dontsave' && State.pendingAction && State.pendingAction.type === 'open') {
				loadFile(State.pendingAction.fileName);
			}
			
			State.pendingAction = null;
			hideConfirmDialog();
		}

		// åŠ è½½æ–‡ä»¶
		async function loadFile(fileName) {
			showLoading('æ­£åœ¨åŠ è½½æ–‡ä»¶...');
			
			try {
				const fileData = await StorageManager.loadFile(fileName);
				
				if (!fileData) {
					hideLoading();
					showStatusTip(`æ–‡ä»¶ä¸å­˜åœ¨: ${fileName}`);
					return;
				}
				
				loadFileData(fileName, fileData);
				
			} catch (error) {
				hideLoading();
				showStatusTip('åŠ è½½æ–‡ä»¶å¤±è´¥: ' + error.message);
				console.error('æ–‡ä»¶åŠ è½½é”™è¯¯:', error);
			}
		}

		// åŠ è½½æ–‡ä»¶æ•°æ®ï¼ˆé€šç”¨å‡½æ•°ï¼‰
		function loadFileData(fileName, fileData) {
			// æ¸…ç©ºç°æœ‰å…ƒç´ 
			State.elements.forEach(el => {
				if (el.element && el.element.parentNode) {
					el.element.parentNode.removeChild(el.element);
				}
			});
			
			State.elements = [];
			State.selectedIds.clear();
			State.clickSelectedIds.clear();
			State.dragSelectedIds.clear();
			
			// åŠ è½½å…ƒç´ 
			if (fileData.elements && Array.isArray(fileData.elements)) {
				fileData.elements.forEach(elementData => {
					createElement(
						elementData.content,
						elementData.x,    // é€»è¾‘Xåæ ‡
						elementData.y,    // é€»è¾‘Yåæ ‡
						{
							fontSize: elementData.fontSize || 24,
							color: elementData.color || '#000',
							type: elementData.type || 'normal'
						}
					);
				});
			}
			
			// åŠ è½½é…ç½®
			if (fileData.config) {
				if (fileData.config.zoom) {
					Config.zoom = Math.max(Config.minZoom, Math.min(Config.maxZoom, fileData.config.zoom));
				}
				
				if (fileData.config.gridEnabled !== undefined) {
					Config.gridEnabled = fileData.config.gridEnabled;
					updateGrid();
					updateGridButton();
				}
				
				// åŠ è½½å¯¹é½è®¾ç½®
				if (fileData.config.alignOptions) {
					Config.alignOptions = { ...Config.alignOptions, ...fileData.config.alignOptions };
					updateAlignCheckboxes();
					updateAlignPrecision(Config.alignOptions.precision);
				}
				
				// åŠ è½½å¾®è°ƒè®¾ç½®
				if (fileData.config.nudgePrecision) {
					Config.nudgePrecision = fileData.config.nudgePrecision;
					updateNudgePrecision(Config.nudgePrecision);
				}
				
				// åŠ è½½å­—ä½“å†å²
				if (fileData.config.fontSizeHistory) {
					Config.fontSizeHistory = fileData.config.fontSizeHistory;
				}
				
				if (fileData.config.fontUsageHistory) {
					State.fontUsageHistory = fileData.config.fontUsageHistory;
				}
				
				// åŠ è½½ä¸Šæ¬¡å­—ä½“å¤§å°
				if (fileData.config.lastFontSize) {
					Config.lastFontSize = fileData.config.lastFontSize;
				}
			}
			
			// æ›´æ–°æ»šåŠ¨ä½ç½®
			if (fileData.viewport) {
				editorContainer.scrollLeft = fileData.viewport.scrollLeft || 900;
				editorContainer.scrollTop = fileData.viewport.scrollTop || 900;
			}
			
			// æ›´æ–°çŠ¶æ€
			Config.hasUnsavedChanges = false;
			Config.currentFileName = fileName;
			Config.lastSaveTime = new Date();
			
			// æ›´æ–°UI
			updateFileInfo();
			updateFontPresetButtons();
			updateAllElementsDisplay();  // ç¡®ä¿æ˜¾ç¤ºæ­£ç¡®
			hideBatchActions();
			
			hideLoading();
			hideFileList();
			showStatusTip(`å·²æ‰“å¼€æ–‡ä»¶: ${fileName}`);
			
			saveCurrentFileState();
		}

// ä¿®æ”¹ä¿å­˜å‡½æ•°
async function saveFile() {
	// å¦‚æœæ˜¯ä¸“ä¸šç‰ˆï¼Œä¸æ£€æŸ¥é™åˆ¶
	if (!UsageLimit.isProVersion()) {
		if (!UsageLimit.recordSave()) {
			return false; // å·²è§¦å‘é™åˆ¶å¼¹çª—
		}
	}
	
	handleMenuItemClick();
	
	if (Config.currentFileName === "æœªå‘½å") {
		return showSaveAsDialog();
	} else {
		const saved = await performSave(Config.currentFileName);
		
		if (saved) {
			if (UsageLimit.isProVersion()) {
				showStatusTip('ä¿å­˜æˆåŠŸï¼ğŸ–ï¸ ä¸“ä¸šç‰ˆæ— é™åˆ¶');
			} else {
				const remaining = UsageLimit.getRemainingInfo();
				showStatusTip(`ä¿å­˜æˆåŠŸï¼ä»Šæ—¥è¿˜å¯ä¿å­˜ ${remaining.saves} æ¬¡`);
			}
		}
		return saved;
	}
}

		// æ˜¾ç¤ºå¦å­˜ä¸ºå¯¹è¯æ¡†
		function showSaveAsDialog() {
			return new Promise((resolve) => {
				State.pendingAction = { type: 'save', resolve };
				
				confirmExtraContent.innerHTML = `
					<div style="margin-bottom: 10px;">
						<label for="filename-input" style="display: block; margin-bottom: 5px; font-size: 13px;">æ–‡ä»¶å:</label>
						<input type="text" id="filename-input" class="filename-input" 
							   placeholder="è¯·è¾“å…¥æ–‡ä»¶å" value="æ•°å­¦å…¬å¼_${formatDate(new Date(), 'YYYYMMDD_HHmmss')}">
					</div>
				`;
				
				showConfirmDialog(
					'ä¿å­˜æ–‡ä»¶',
					'è¯·è¾“å…¥æ–‡ä»¶å:',
					'saveAsConfirm',
					'ä¿å­˜',
					'å–æ¶ˆ'
				);
				
				// èšç„¦åˆ°è¾“å…¥æ¡†
				setTimeout(() => {
					const filenameInput = document.getElementById('filename-input');
					if (filenameInput) {
						filenameInput.focus();
						filenameInput.select();
					}
				}, 100);
			});
		}

		// å¦å­˜ä¸ºç¡®è®¤
		function saveAsConfirm(action) {
			if (action === 'save') {
				const filenameInput = document.getElementById('filename-input');
				const fileName = filenameInput ? filenameInput.value.trim() : '';
				
				if (!fileName) {
					showStatusTip('è¯·è¾“å…¥æ–‡ä»¶å');
					return;
				}
				
				// ä¿å­˜æ–‡ä»¶
				const saved = performSave(fileName);
				
				if (State.pendingAction && State.pendingAction.resolve) {
					State.pendingAction.resolve(saved);
				}
				
				if (saved) {
					hideConfirmDialog();
				}
			} else {
				if (State.pendingAction && State.pendingAction.resolve) {
					State.pendingAction.resolve(false);
				}
				hideConfirmDialog();
			}
			
			State.pendingAction = null;
		}

		// æ‰§è¡Œä¿å­˜
		async function performSave(fileName) {
			try {
				const saveData = StorageManager.getCurrentFileData();
				const saved = await StorageManager.saveFile(fileName, saveData);
				
				if (saved) {
					Config.hasUnsavedChanges = false;
					Config.currentFileName = fileName;
					Config.lastSaveTime = new Date();
					
					updateFileInfo();
					
					const storageType = StorageManager.getStorageType();
					if (storageType === 'browser') {
						showAutosaveIndicator('å·²ä¿å­˜åˆ°æµè§ˆå™¨å­˜å‚¨ï¼Œæ–‡ä»¶å·²ä¸‹è½½');
					} else {
						showAutosaveIndicator('ä¿å­˜æˆåŠŸ');
					}
					showStatusTip(`æ–‡ä»¶å·²ä¿å­˜: ${fileName}`);
					
					saveCurrentFileState();
					
					return true;
				} else {
					showStatusTip('ä¿å­˜å¤±è´¥');
					return false;
				}
				
			} catch (error) {
				console.error('ä¿å­˜æ–‡ä»¶å¤±è´¥:', error);
				showStatusTip('ä¿å­˜å¤±è´¥: ' + error.message);
				return false;
			}
		}

		// åˆ é™¤æ–‡ä»¶ç¡®è®¤
		async function deleteFileConfirm(action) {
			if (action === 'save' && State.pendingAction && State.pendingAction.type === 'delete') {
				const fileName = State.pendingAction.fileName;
				
				try {
					const deleted = await StorageManager.deleteFile(fileName);
					
					if (deleted) {
						// å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰æ‰“å¼€çš„æ–‡ä»¶ï¼Œåˆ›å»ºæ–°æ–‡ä»¶
						if (Config.currentFileName === fileName) {
							createNewFile();
						}
						
						// åˆ·æ–°æ–‡ä»¶åˆ—è¡¨
						showFileList();
						
						showStatusTip(`å·²åˆ é™¤æ–‡ä»¶: ${fileName}`);
					} else {
						showStatusTip('åˆ é™¤æ–‡ä»¶å¤±è´¥');
					}
					
				} catch (error) {
					console.error('åˆ é™¤æ–‡ä»¶å¤±è´¥:', error);
					showStatusTip('åˆ é™¤å¤±è´¥: ' + error.message);
				}
			}
			
			State.pendingAction = null;
			hideConfirmDialog();
		}

		// ä¸‹è½½å½“å‰æ–‡ä»¶
		async function downloadCurrentFile() {
			try {
				const fileData = StorageManager.getCurrentFileData();
				StorageManager.downloadFile(Config.currentFileName || 'æ•°å­¦å…¬å¼', fileData);
				showStatusTip('æ–‡ä»¶å·²ä¸‹è½½');
			} catch (error) {
				showStatusTip('ä¸‹è½½å¤±è´¥: ' + error.message);
			}
		}

		// ä¸Šä¼ å¹¶æ‰“å¼€æ–‡ä»¶
		async function uploadAndOpenFile() {
			const uploadResult = await StorageManager.uploadFile();
			if (uploadResult) {
				const { fileName, data } = uploadResult;
				
				// æ£€æŸ¥æ˜¯å¦æœ‰æœªä¿å­˜çš„æ›´æ”¹
				if (Config.hasUnsavedChanges) {
					State.pendingAction = { type: 'uploadOpen', fileName, data };
					showConfirmDialog(
						'æœªä¿å­˜çš„æ›´æ”¹',
						'å½“å‰æ–‡ä»¶æœ‰æœªä¿å­˜çš„æ›´æ”¹ï¼Œæ˜¯å¦è¦ä¿å­˜ï¼Ÿ',
						'uploadOpenAfterConfirm',
						'ä¿å­˜',
						'ä¸ä¿å­˜',
						'å–æ¶ˆ'
					);
				} else {
					openUploadedFile(fileName, data);
				}
			}
		}

		// ä¸Šä¼ åæ‰“å¼€ç¡®è®¤
		async function uploadOpenAfterConfirm(action) {
			if (action === 'save') {
				const saved = await saveFile();
				if (saved && State.pendingAction) {
					openUploadedFile(State.pendingAction.fileName, State.pendingAction.data);
				}
			} else if (action === 'dontsave' && State.pendingAction) {
				openUploadedFile(State.pendingAction.fileName, State.pendingAction.data);
			}
			
			State.pendingAction = null;
			hideConfirmDialog();
		}

		// æ‰“å¼€ä¸Šä¼ çš„æ–‡ä»¶
		function openUploadedFile(fileName, data) {
			// ä¿å­˜ä¸Šä¼ çš„æ–‡ä»¶åˆ°æœ¬åœ°å­˜å‚¨
			const files = StorageManager.getAllFiles();
			files[fileName] = data;
			StorageManager.saveFileList(files);
			
			// åŠ è½½æ–‡ä»¶
			loadFileData(fileName, data);
		}

		// ==================== ç¼–è¾‘åŒºç§»åŠ¨åŠŸèƒ½ ====================
		// åˆ‡æ¢ç¼–è¾‘åŒºç§»åŠ¨æ¨¡å¼
		function toggleEditorPanMode() {
			Config.editorPanMode = !Config.editorPanMode;
			const menuIcon = document.getElementById('editor-pan-menu-icon');
			const menuItem = document.getElementById('editor-pan-menu-item');
			const bottomBtn = document.getElementById('editor-pan-bottom-btn');
			
			if (Config.editorPanMode) {
				// è¿›å…¥ç¼–è¾‘åŒºç§»åŠ¨æ¨¡å¼
				if (menuIcon) menuIcon.textContent = 'âœ‹âœ“';
				if (menuItem) menuItem.classList.add('active-pan');
				if (bottomBtn) bottomBtn.classList.add('active-editor-pan');
				document.body.classList.add('pan-mode');
				showStatusTip('ç¼–è¾‘åŒºç§»åŠ¨æ¨¡å¼ï¼šæ‹–åŠ¨ç©ºç™½å¤„ç§»åŠ¨ç¼–è¾‘åŒº');
				
				// é€€å‡ºå…¶ä»–å¯èƒ½å†²çªçš„æ¨¡å¼
				Config.clickSelectionMode = false;
				Config.batchMoveMode = false;
				Config.selectionMode = false;
				
				// æ›´æ–°UI
				if (Config.clickSelectionMode) {
					clickSelectBtn.textContent = 'âœ“';
					clickSelectBtn.classList.remove('danger');
					hideModeIndicator();
				}
				
				// éšè—æ‰¹é‡æ“ä½œæŒ‰é’®
				hideBatchActions();
				
				// æ¸…é™¤é€‰æ‹©
				clearClickSelection();
				clearDragSelection();
				
				// å¦‚æœé”®ç›˜æ¿€æ´»ï¼Œå…³é—­é”®ç›˜
				if (Config.keyboardActive) {
					toggleKeyboard();
				}
				
				// å…³é—­æ‰€æœ‰é¢æ¿
				closeAllPanels();
			} else {
				// é€€å‡ºç¼–è¾‘åŒºç§»åŠ¨æ¨¡å¼
				if (menuIcon) menuIcon.textContent = 'âœ‹';
				if (menuItem) menuItem.classList.remove('active-pan');
				if (bottomBtn) bottomBtn.classList.remove('active-editor-pan');
				document.body.classList.remove('pan-mode');
				showStatusTip('ç¼–è¾‘åŒºç§»åŠ¨æ¨¡å¼å·²å…³é—­');
				
				// å¦‚æœä¹‹å‰æ˜¯ç§»åŠ¨çŠ¶æ€ï¼Œç»“æŸå®ƒ
				if (Config.isPanning) {
					endEditorPan();
				}
			}
		}

		// å¼€å§‹ç¼–è¾‘åŒºç§»åŠ¨
		function startEditorPan(clientX, clientY) {
			if (!Config.editorPanMode) return;
			
			Config.isPanning = true;
			State.panStart.x = clientX;
			State.panStart.y = clientY;
			State.panScrollStart.x = editorContainer.scrollLeft;
			State.panScrollStart.y = editorContainer.scrollTop;
			
			// æ›´æ–°å…‰æ ‡
			document.body.classList.add('pan-mode');
			document.body.style.cursor = 'grabbing';
			
			// æ˜¾ç¤ºæ¨¡å¼æŒ‡ç¤ºå™¨
			showModeIndicator('ç¼–è¾‘åŒºç§»åŠ¨ä¸­');
		}

		// æ›´æ–°ç¼–è¾‘åŒºç§»åŠ¨
		function updateEditorPan(clientX, clientY) {
			if (!Config.isPanning) return;
			
			const deltaX = clientX - State.panStart.x;
			const deltaY = clientY - State.panStart.y;
			
			editorContainer.scrollLeft = State.panScrollStart.x - deltaX;
			editorContainer.scrollTop = State.panScrollStart.y - deltaY;
		}

		// ç»“æŸç¼–è¾‘åŒºç§»åŠ¨
		function endEditorPan() {
			if (Config.isPanning) {
				Config.isPanning = false;
				document.body.style.cursor = Config.editorPanMode ? 'grab' : '';
				hideModeIndicator();
				
				// æ ‡è®°æœ‰æœªä¿å­˜çš„æ›´æ”¹
				markUnsavedChanges();
			}
		}

		// ==================== è¾…åŠ©åŠŸèƒ½ ====================
		// è‡ªåŠ¨ä¿å­˜
		function setupAutosave() {
			if (Config.autosaveEnabled) {
				clearTimeout(State.autosaveTimer);
				
				State.autosaveTimer = setTimeout(() => {
					if (Config.hasUnsavedChanges && Config.currentFileName !== "æœªå‘½å") {
						// è‡ªåŠ¨ä¿å­˜
						performSave(Config.currentFileName);
						showAutosaveIndicator('è‡ªåŠ¨ä¿å­˜');
					}
					
					// ç»§ç»­ä¸‹ä¸€æ¬¡è‡ªåŠ¨ä¿å­˜
					setupAutosave();
				}, Config.autosaveInterval);
			}
		}

		// æ ‡è®°æœ‰æœªä¿å­˜çš„æ›´æ”¹
		function markUnsavedChanges() {
			if (!Config.hasUnsavedChanges) {
				Config.hasUnsavedChanges = true;
				updateFileInfo();
			}
			
			// ä¿å­˜è®¾ç½®
			saveSettings();
			
			// é‡æ–°è®¾ç½®è‡ªåŠ¨ä¿å­˜è®¡æ—¶å™¨
			if (Config.autosaveEnabled) {
				clearTimeout(State.autosaveTimer);
				State.autosaveTimer = setTimeout(() => {
					if (Config.hasUnsavedChanges && Config.currentFileName !== "æœªå‘½å") {
						performSave(Config.currentFileName);
						showAutosaveIndicator('è‡ªåŠ¨ä¿å­˜');
					}
				}, Config.autosaveInterval);
			}
		}

		// ä¿å­˜å½“å‰æ–‡ä»¶çŠ¶æ€åˆ°localStorage
		function saveCurrentFileState() {
			try {
				const state = {
					currentFileName: Config.currentFileName,
					viewport: {
						scrollLeft: editorContainer.scrollLeft,
						scrollTop: editorContainer.scrollTop
					}
				};
				localStorage.setItem(StorageManager.CURRENT_FILE_KEY, JSON.stringify(state));
			} catch (e) {
				console.error('ä¿å­˜å½“å‰æ–‡ä»¶çŠ¶æ€å¤±è´¥:', e);
			}
		}

		// åŠ è½½å½“å‰æ–‡ä»¶çŠ¶æ€
		function loadCurrentFileState() {
			try {
				const stateJson = localStorage.getItem(StorageManager.CURRENT_FILE_KEY);
				if (stateJson) {
					const state = JSON.parse(stateJson);
					if (state.currentFileName) {
						Config.currentFileName = state.currentFileName;
					}
					
					// æ¢å¤è§†å£ä½ç½®
					if (state.viewport) {
						setTimeout(() => {
							editorContainer.scrollLeft = state.viewport.scrollLeft || 900;
							editorContainer.scrollTop = state.viewport.scrollTop || 900;
						}, 100);
					}
					
					return state;
				}
			} catch (e) {
				console.error('åŠ è½½å½“å‰æ–‡ä»¶çŠ¶æ€å¤±è´¥:', e);
			}
			return null;
		}

// åœ¨æ–‡ä»¶ä¿¡æ¯ä¸­æ˜¾ç¤ºä½¿ç”¨æƒ…å†µ
function updateFileInfo() {
	let infoText = `å½“å‰æ–‡ä»¶: ${Config.currentFileName}`;
	
	if (Config.lastSaveTime) {
		infoText += ` | æœ€åä¿å­˜: ${formatDate(Config.lastSaveTime, 'HH:mm:ss')}`;
	}
	
	if (Config.hasUnsavedChanges) {
		infoText += ' â€¢ æœªä¿å­˜';
	}
	
	// æ·»åŠ ç‰ˆæœ¬ä¿¡æ¯
	if (UsageLimit.isProVersion()) {
		infoText += ' â€¢ ğŸ–ï¸ ä¸“ä¸šç‰ˆ';
	} else {
		const remaining = UsageLimit.getRemainingInfo();
		infoText += ` | å‰©ä½™: ${remaining.saves}å­˜/${remaining.exports}å‡º/${Math.round(remaining.minutes)}åˆ†`;
	}
	
	if (fileInfoText) {
		fileInfoText.textContent = infoText;
	}
}

		// åŠ è½½è®¾ç½®
		function loadSettings() {
			const settings = StorageManager.getSettings();
			
			// åŠ è½½ä¸Šæ¬¡ä½¿ç”¨çš„å­—ä½“å¤§å°
			if (settings.lastFontSize) {
				Config.lastFontSize = settings.lastFontSize;
			}
			
			// åŠ è½½æœ€è¿‘å­—ä½“è®°å½•
			if (settings.recentFontSizes) {
				Config.recentFontSizes = settings.recentFontSizes;
			}
			
			// åŠ è½½å­—ä½“å†å²è®°å½•
			if (settings.fontSizeHistory) {
				Config.fontSizeHistory = settings.fontSizeHistory;
			}
			
			if (settings.fontUsageHistory) {
				State.fontUsageHistory = settings.fontUsageHistory;
			}
			
			// åŠ è½½å…¶ä»–è®¾ç½®...
			if (settings.alignOptions) {
				Config.alignOptions = { ...Config.alignOptions, ...settings.alignOptions };
			}
			if (settings.nudgePrecision) {
				Config.nudgePrecision = settings.nudgePrecision;
			}
			
			updateAlignCheckboxes();
			updateAlignPrecision(Config.alignOptions.precision);
			updateNudgePrecision(Config.nudgePrecision);
			updateGridButton();
		}

		// ä¿å­˜è®¾ç½®
		function saveSettings() {
			const settings = {
				lastFontSize: Config.lastFontSize || 24,
				recentFontSizes: Config.recentFontSizes || [],
				fontSizeHistory: Config.fontSizeHistory,
				fontUsageHistory: State.fontUsageHistory,
				alignOptions: Config.alignOptions,
				nudgePrecision: Config.nudgePrecision
			};
			StorageManager.saveSettings(settings);
		}

		// æ˜¾ç¤ºè‡ªåŠ¨ä¿å­˜æŒ‡ç¤ºå™¨
		function showAutosaveIndicator(text) {
			autosaveIndicator.textContent = text;
			autosaveIndicator.style.display = 'block';
			
			setTimeout(() => {
				autosaveIndicator.style.display = 'none';
			}, 2000);
		}

		// æ˜¾ç¤ºåŠ è½½ä¸­
		function showLoading(message = 'åŠ è½½ä¸­...') {
			loadingOverlay.style.display = 'flex';
		}

		// éšè—åŠ è½½ä¸­
		function hideLoading() {
			loadingOverlay.style.display = 'none';
		}

		// æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†
		function showConfirmDialog(title, message, action, confirmText = 'ç¡®å®š', cancelText = 'å–æ¶ˆ', extraOption = null) {
			confirmTitle.textContent = title;
			confirmMessage.textContent = message;
			confirmActionBtn.textContent = confirmText;
			
			// æ¸…é™¤ä¹‹å‰çš„äº‹ä»¶ç›‘å¬å™¨
			confirmActionBtn.onclick = null;
			
			// è®¾ç½®ç¡®è®¤æŒ‰é’®çš„åŠ¨ä½œ
			confirmActionBtn.onclick = function() {
				if (window[action]) {
					window[action]('save');
				}
			};
			
			// è®¾ç½®å–æ¶ˆæŒ‰é’®
			const cancelBtn = document.querySelector('.confirm-dialog-btn.cancel');
			if (cancelBtn) {
				cancelBtn.textContent = cancelText;
				cancelBtn.onclick = function() {
					if (extraOption && window[action]) {
						window[action]('dontsave');
					}
					hideConfirmDialog();
				};
			}
			
			confirmDialog.style.display = 'flex';
			confirmExtraContent.style.display = extraOption ? 'block' : 'none';
		}

		// ç¡®è®¤å¯¹è¯æ¡†åŠ¨ä½œ
		function confirmDialogAction() {
			// è¿™ä¸ªå‡½æ•°ç°åœ¨ç”±å„ä¸ªæŒ‰é’®ç›´æ¥è°ƒç”¨
		}

		// éšè—ç¡®è®¤å¯¹è¯æ¡†
		function hideConfirmDialog() {
			confirmDialog.style.display = 'none';
		}

		// æ—¥æœŸæ ¼å¼åŒ–å‡½æ•°
		function formatDate(date, format = 'YYYY-MM-DD HH:mm:ss') {
			if (!date) return '';
			
			const d = new Date(date);
			const year = d.getFullYear();
			const month = String(d.getMonth() + 1).padStart(2, '0');
			const day = String(d.getDate()).padStart(2, '0');
			const hours = String(d.getHours()).padStart(2, '0');
			const minutes = String(d.getMinutes()).padStart(2, '0');
			const seconds = String(d.getSeconds()).padStart(2, '0');
			
			return format
				.replace('YYYY', year)
				.replace('MM', month)
				.replace('DD', day)
				.replace('HH', hours)
				.replace('mm', minutes)
				.replace('ss', seconds);
		}

		// ==================== é”®ç›˜è¾“å…¥åŠŸèƒ½ ====================
		function toggleKeyboard() {
			Config.keyboardActive = !Config.keyboardActive;
			
			if (Config.keyboardActive) {
				// æ¿€æ´»é”®ç›˜
				keyboardToggle.style.background = '#FF9800';
				keyboardToggle.textContent = 'âŒ¨ï¸âœ“';
				
				// æ˜¾ç¤ºé”®ç›˜è¾“å…¥æ˜¾ç¤ºæ¡†ï¼Œéšè—ç¬¦å·æ 
				keyboardInputDisplay.classList.add('show');
				symbolsScroll.classList.add('hidden');
				
				// æ¸…ç©ºå¹¶èšç„¦è¾“å…¥æ¡†
				inputTextbox.value = '';
				setTimeout(() => {
					inputTextbox.focus();
				}, 100);
				
				showStatusTip('é”®ç›˜å·²æ¿€æ´»ï¼Œè¯·è¾“å…¥å†…å®¹');
			} else {
				// å…³é—­é”®ç›˜
				keyboardToggle.style.background = '#4CAF50';
				keyboardToggle.textContent = 'âŒ¨ï¸';
				
				// éšè—é”®ç›˜è¾“å…¥æ˜¾ç¤ºæ¡†ï¼Œæ˜¾ç¤ºç¬¦å·æ 
				keyboardInputDisplay.classList.remove('show');
				symbolsScroll.classList.remove('hidden');
				
				// å¤±ç„¦è¾“å…¥æ¡†
				inputTextbox.blur();
				
				showStatusTip('é”®ç›˜å·²å…³é—­');
			}
		}

		function insertSymbol(symbol) {
			if (Config.keyboardActive) {
				// å¦‚æœé”®ç›˜æ¿€æ´»ï¼Œå°†ç¬¦å·æ’å…¥åˆ°textareaçš„å½“å‰å…‰æ ‡ä½ç½®
				const cursorPos = inputTextbox.selectionStart;
				const text = inputTextbox.value;
				inputTextbox.value = text.substring(0, cursorPos) + symbol + text.substring(inputTextbox.selectionEnd);
				
				// ç§»åŠ¨å…‰æ ‡åˆ°ç¬¦å·å
				setTimeout(() => {
					inputTextbox.selectionStart = cursorPos + symbol.length;
					inputTextbox.selectionEnd = cursorPos + symbol.length;
					inputTextbox.focus();
				}, 10);
			} else {
					// è·å–å½“å‰è§†å£ä¸­å¿ƒï¼ˆé€»è¾‘åæ ‡ï¼‰
					const logicPos = getViewportCenter();
					
					// åˆ›å»ºå…ƒç´ 
					const newElement = createElement(symbol, logicPos.x, logicPos.y);
					
					// ç¡®ä¿æ–°å…ƒç´ åœ¨è§†å£ä¸­å¯è§
					ensureElementVisible(newElement);
					
					markUnsavedChanges();
			}
		}
		
// æ–°å¢è¾…åŠ©å‡½æ•°
function getViewportCenter() {
	// è·å–å®¹å™¨å°ºå¯¸å’Œæ»šåŠ¨ä½ç½®
	const containerWidth = editorContainer.clientWidth;
	const containerHeight = editorContainer.clientHeight;
	const scrollLeft = editorContainer.scrollLeft;
	const scrollTop = editorContainer.scrollTop;
	
	// è®¡ç®—è§†å£ä¸­å¿ƒçš„å±å¹•åæ ‡
	const screenCenterX = containerWidth / 2;
	const screenCenterY = containerHeight / 2;
	
	// è½¬æ¢ä¸ºé€»è¾‘åæ ‡
	const logicX = (screenCenterX + scrollLeft) / Config.zoom;
	const logicY = (screenCenterY + scrollTop) / Config.zoom;
	
	return { x: logicX, y: logicY };
}

function ensureElementVisible(elementData) {
	// æ£€æŸ¥å…ƒç´ æ˜¯å¦åœ¨è§†å£å†…
	const elementScreenX = elementData.x * Config.zoom;
	const elementScreenY = elementData.y * Config.zoom;
	const elementScreenWidth = elementData.width * Config.zoom;
	const elementScreenHeight = elementData.height * Config.zoom;
	
	const containerWidth = editorContainer.clientWidth;
	const containerHeight = editorContainer.clientHeight;
	const scrollLeft = editorContainer.scrollLeft;
	const scrollTop = editorContainer.scrollTop;
	
	// æ£€æŸ¥å…ƒç´ æ˜¯å¦åœ¨è§†å£å†…
	const isVisible = (
		elementScreenX >= scrollLeft &&
		elementScreenX + elementScreenWidth <= scrollLeft + containerWidth &&
		elementScreenY >= scrollTop &&
		elementScreenY + elementScreenHeight <= scrollTop + containerHeight
	);
	
	if (!isVisible) {
		// å¦‚æœä¸å¯è§ï¼Œå°†å…ƒç´ æ»šåŠ¨åˆ°è§†å£ä¸­å¿ƒ
		const targetScrollLeft = elementScreenX - containerWidth / 2 + elementScreenWidth / 2;
		const targetScrollTop = elementScreenY - containerHeight / 2 + elementScreenHeight / 2;
		
		// ç¡®ä¿ä¸è¶…å‡ºè¾¹ç•Œ
		editorContainer.scrollLeft = Math.max(0, Math.min(targetScrollLeft, editorArea.scrollWidth - containerWidth));
		editorContainer.scrollTop = Math.max(0, Math.min(targetScrollTop, editorArea.scrollHeight - containerHeight));
	}
}		
		
		
		

function confirmInput() {
	if (Config.keyboardActive) {
		const inputValue = inputTextbox.value.trim();
		
		if (inputValue) {
			if (State.editingElement) {
				// ç¼–è¾‘ç°æœ‰å…ƒç´  - ç¡®è®¤æœ€ç»ˆå†…å®¹
				State.editingElement.content = inputValue;
				State.editingElement.element.textContent = inputValue;
				updateElementDisplay(State.editingElement);
				showStatusTip('å…ƒç´ å·²æ›´æ–°');
				
				// æ ‡è®°æœ‰æœªä¿å­˜çš„æ›´æ”¹
				markUnsavedChanges();
			} else {
				// åˆ›å»ºæ–°å…ƒç´ ï¼ˆä½¿ç”¨è§†å£ä¸­å¿ƒï¼‰
				const logicPos = getViewportCenter();
				const newElement = createElement(inputValue, logicPos.x, logicPos.y);
				
				// ç¡®ä¿å¯è§
				ensureElementVisible(newElement);
				
				showStatusTip('æ–°å…ƒç´ å·²åˆ›å»º');
				markUnsavedChanges();
			}
		} else {
			// å¦‚æœå†…å®¹ä¸ºç©ºä¸”æ­£åœ¨ç¼–è¾‘å…ƒç´ ï¼Œåˆ é™¤è¯¥å…ƒç´ 
			if (State.editingElement && inputValue === '') {
				deleteElement(State.editingElement);
				showStatusTip('å…ƒç´ å·²åˆ é™¤ï¼ˆå†…å®¹ä¸ºç©ºï¼‰');
				markUnsavedChanges();
			}
		}
		
		// æ¸…é™¤è¾“å…¥äº‹ä»¶ç›‘å¬
		inputTextbox.oninput = null;
		
		toggleKeyboard();
		clearEditState();
	}
}

		// ä¿®æ”¹ cancelInput å‡½æ•°ï¼Œæ¢å¤åŸå†…å®¹
		function cancelInput() {
			if (Config.keyboardActive) {
				// æ¸…é™¤è¾“å…¥äº‹ä»¶ç›‘å¬
				inputTextbox.oninput = null;
				
				// å¦‚æœæ­£åœ¨ç¼–è¾‘å…ƒç´ ï¼Œæ¢å¤åŸå†…å®¹
				if (State.editingElement) {
					State.editingElement.element.textContent = State.editingElement.content;
					updateElementDisplay(State.editingElement);
					showStatusTip('å·²å–æ¶ˆç¼–è¾‘ï¼Œæ¢å¤åŸå†…å®¹');
				}
				
				// å…³é—­é”®ç›˜
				toggleKeyboard();
				
				// å–æ¶ˆç¼–è¾‘çŠ¶æ€
				clearEditState();
			}
		}

		// ==================== æ•°å­¦å…ƒç´ ç®¡ç† ====================
		function createElement(content, logicX, logicY, options = {}) {
			// ç¡®ä¿ä½ç½®åœ¨ç¼–è¾‘åŒºåŸŸå†…
			logicX = Math.max(0, Math.min(logicX, 1950));
			logicY = Math.max(0, Math.min(logicY, 1950));
			
			const element = document.createElement('div');
			element.className = `math-element ${options.type || ''}`;
			element.textContent = content;
			
			// æ·»åŠ å”¯ä¸€ID
			const id = 'elem_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
			element.dataset.id = id;
			
			// æµ‹é‡é€»è¾‘å¤§å°
			const logicWidth = measureTextWidth(content, options.fontSize || 24);
			const logicHeight = (options.fontSize || 24) * 1.2;
			
			// è®¡ç®—å±å¹•æ˜¾ç¤ºå¤§å°å’Œä½ç½®
			const screenX = logicX * Config.zoom;
			const screenY = logicY * Config.zoom;
			const screenFontSize = (options.fontSize || 24) * Config.zoom;
			const screenWidth = logicWidth * Config.zoom;
			const screenHeight = logicHeight * Config.zoom;
			
			// è®¾ç½®æ ·å¼
			element.style.left = screenX + 'px';
			element.style.top = screenY + 'px';
			element.style.fontSize = screenFontSize + 'px';
			element.style.width = screenWidth + 'px';
			element.style.height = screenHeight + 'px';
			element.style.color = options.color || '#000';
			element.style.transform = 'none'; // ç§»é™¤transformç¼©æ”¾
			
			// ä¿å­˜å…ƒç´ æ•°æ®
			const elementData = {
				id,
				element,
				x: logicX,           // é€»è¾‘Xåæ ‡
				y: logicY,           // é€»è¾‘Yåæ ‡
				width: logicWidth,   // é€»è¾‘å®½åº¦
				height: logicHeight, // é€»è¾‘é«˜åº¦
				fontSize: options.fontSize || 24,
				color: options.color || '#000',
				content,
				type: options.type || 'normal',
				selected: false,
				clickSelected: false,
				dragSelected: false
			};
			
			// æ·»åŠ åˆ°ç¼–è¾‘åŒºåŸŸ
			editorArea.appendChild(element);
			
			// ä¿å­˜åˆ°çŠ¶æ€
			State.elements.push(elementData);
			
			// ç»‘å®šäº‹ä»¶
			bindElementEvents(elementData);
			
			return elementData;
		}

		// æ–°çš„å…ƒç´ äº‹ä»¶ç»‘å®šå‡½æ•°
		function bindElementEvents(elementData) {
			const element = elementData.element;
			
			element.addEventListener('mousedown', (e) => handleElementMouseDown(e, elementData));
			element.addEventListener('touchstart', (e) => handleElementTouchStart(e, elementData));
			element.addEventListener('dblclick', (e) => handleElementDoubleClick(e, elementData));
			
			// é•¿æŒ‰ç¼–è¾‘ï¼ˆç§»åŠ¨ç«¯ï¼‰
			let pressTimer;
			element.addEventListener('touchstart', (e) => {
				pressTimer = setTimeout(() => {
					if (!Config.isDragging && !Config.selectionMode && 
						!Config.clickSelectionMode && !Config.batchMoveMode && !Config.editorPanMode) {
						editElement(elementData);
					}
				}, 500);
			});
			
			element.addEventListener('touchend', () => {
				clearTimeout(pressTimer);
			});
		}

		function measureTextWidth(text, fontSize) {
			const tempSpan = document.createElement('span');
			tempSpan.style.visibility = 'hidden';
			tempSpan.style.position = 'absolute';
			tempSpan.style.whiteSpace = 'nowrap';
			tempSpan.style.fontSize = fontSize + 'px';
			tempSpan.style.fontFamily = "Cambria Math, Times New Roman, serif";
			tempSpan.textContent = text || 'M';
			document.body.appendChild(tempSpan);
			
			const width = tempSpan.offsetWidth + 8;
			document.body.removeChild(tempSpan);
			
			return width;
		}

		function updateElementDisplay(elementData) {
			const element = elementData.element;
			
			// é‡æ–°æµ‹é‡é€»è¾‘å¤§å°
			const logicWidth = measureTextWidth(elementData.content, elementData.fontSize);
			const logicHeight = elementData.fontSize * 1.2;
			
			// æ›´æ–°é€»è¾‘å°ºå¯¸
			elementData.width = logicWidth;
			elementData.height = logicHeight;
			
			// è®¡ç®—å±å¹•æ˜¾ç¤ºå°ºå¯¸
			const screenX = elementData.x * Config.zoom;
			const screenY = elementData.y * Config.zoom;
			const screenFontSize = elementData.fontSize * Config.zoom;
			const screenWidth = logicWidth * Config.zoom;
			const screenHeight = logicHeight * Config.zoom;
			
			// æ›´æ–°æ˜¾ç¤º
			element.style.left = screenX + 'px';
			element.style.top = screenY + 'px';
			element.style.fontSize = screenFontSize + 'px';
			element.style.width = screenWidth + 'px';
			element.style.height = screenHeight + 'px';
			element.textContent = elementData.content;
			element.style.color = elementData.color;
		}

		// æ‰¹é‡æ›´æ–°æ‰€æœ‰å…ƒç´ çš„æ˜¾ç¤º
		function updateAllElementsDisplay() {
			State.elements.forEach(elementData => {
				updateElementDisplay(elementData);
			});
		}

		function getElementById(id) {
			return State.elements.find(el => el.id === id);
		}

		function getSelectedElements() {
			return State.elements.filter(el => State.selectedIds.has(el.id));
		}

		function getBatchSelectedElements() {
			return State.elements.filter(el => 
				State.clickSelectedIds.has(el.id) || State.dragSelectedIds.has(el.id)
			);
		}

		function getAllSelectedElements() {
			const allSelected = new Set();
			getSelectedElements().forEach(el => allSelected.add(el));
			getBatchSelectedElements().forEach(el => allSelected.add(el));
			return Array.from(allSelected);
		}

		function clearSelection() {
			State.elements.forEach(el => {
				el.selected = false;
				el.element.classList.remove('selected');
			});
			State.selectedIds.clear();
			
			hideSelectionCount();
			hideBatchActions();
		}

		function selectElement(elementData) {
			if (!elementData.selected) {
				elementData.selected = true;
				elementData.element.classList.add('selected');
				State.selectedIds.add(elementData.id);
				
				// æ›´æ–°å­—ä½“æ§åˆ¶é¢æ¿
				updateFontControlsForSelection();
			}
		}

		function deselectElement(elementData) {
			elementData.selected = false;
			elementData.element.classList.remove('selected');
			State.selectedIds.delete(elementData.id);
		}

		// ==================== ç¼–è¾‘å™¨äº¤äº’ ====================
		function handleAreaMouseDown(e) {
			if (e.button !== 0) return;
			
			// ç‚¹å‡»ç¼–è¾‘åŒºæ—¶å…ˆå…³é—­æ‰€æœ‰é¢æ¿
			closeAllPanels();
			
			// è·å–ç‚¹å‡»ä½ç½®çš„é€»è¾‘åæ ‡
			const logicPos = CoordinateSystem.screenToLogic(e.clientX, e.clientY);
			const logicX = logicPos.x;
			const logicY = logicPos.y;
			
			// æ£€æŸ¥æ˜¯å¦ç‚¹å‡»äº†å…ƒç´ 
			const clickedElement = getElementAtPoint(logicX, logicY);
			
			if (clickedElement) {
				// ç‚¹å‡»å…ƒç´  - äº‹ä»¶å¤„ç†ä¼šåœ¨handleElementMouseDownä¸­å¤„ç†
				return;
			} else {
				// ç‚¹å‡»ç©ºç™½å¤„
				
				// ç‚¹å‡»ç©ºç™½å¤„æ—¶ï¼Œå–æ¶ˆç¼–è¾‘çŠ¶æ€
				if (State.editingElement) {
					State.editingElement.element.classList.remove('editing');
					State.editingElement = null;
				}
				
				// é¦–å…ˆæ£€æŸ¥ç¼–è¾‘åŒºç§»åŠ¨æ¨¡å¼
				if (Config.editorPanMode) {
					startEditorPan(e.clientX, e.clientY);
					e.preventDefault();
					return;
				}
				
				// å¦‚æœæ˜¯åœ¨æ‰¹é‡ç§»åŠ¨æ¨¡å¼ï¼Œç‚¹å‡»ç©ºç™½å¤„å¼€å§‹æ‰¹é‡ç§»åŠ¨
				if (Config.batchMoveMode) {
					// å¦‚æœå·²ç»æœ‰é€‰ä¸­å…ƒç´ ï¼Œå¼€å§‹æ‰¹é‡ç§»åŠ¨
					const batchSelected = getBatchSelectedElements();
					if (batchSelected.length > 0) {
						startElementDrag(batchSelected[0], e.clientX, e.clientY, true);
					}
					e.preventDefault();
					return;
				}
				
				// å¦‚æœæ˜¯åœ¨ç‚¹å‡»é€‰æ‹©æ¨¡å¼ï¼Œç‚¹å‡»ç©ºç™½å¤„æ¸…é™¤æ‰¹é‡é€‰æ‹©
				if (Config.clickSelectionMode) {
					clearClickSelection();
					e.preventDefault();
					return;
				}
				
				// å¦‚æœé”®ç›˜æ¿€æ´»ï¼Œç‚¹å‡»ç©ºç™½å¤„åˆ›å»ºæ–°å…ƒç´ å¹¶å¼€å§‹ç¼–è¾‘
				if (Config.keyboardActive) {
					createElementAtPoint(logicX, logicY);
					e.preventDefault();
					return;
				}
				
				// æ™®é€šæ¨¡å¼ï¼šå¼€å§‹é€‰æ‹©æˆ–åˆ›å»ºå…ƒç´ 
				if (Config.selectionMode) {
					startSelection(e.clientX, e.clientY);
					clearSelection();
				} else {
					// æ™®é€šæ¨¡å¼ä¸‹ç‚¹å‡»ç©ºç™½å¤„ï¼Œæ¸…é™¤æ‰€æœ‰é€‰æ‹©
					clearSelection();
					clearClickSelection();
					clearDragSelection();
					startDragSelection(e.clientX, e.clientY);
				}
			}
			
			e.preventDefault();
		}

		function handleAreaTouchStart(e) {
			if (e.touches.length === 1) {
				e.preventDefault();
				
				// ç‚¹å‡»ç¼–è¾‘åŒºæ—¶å…ˆå…³é—­æ‰€æœ‰é¢æ¿
				closeAllPanels();
				
				const touch = e.touches[0];
				
				// è·å–ç‚¹å‡»ä½ç½®çš„é€»è¾‘åæ ‡
				const logicPos = CoordinateSystem.screenToLogic(touch.clientX, touch.clientY);
				const logicX = logicPos.x;
				const logicY = logicPos.y;
				
				const clickedElement = getElementAtPoint(logicX, logicY);
				
				if (clickedElement) {
					// ç‚¹å‡»å…ƒç´  - äº‹ä»¶å¤„ç†ä¼šåœ¨handleElementTouchStartä¸­å¤„ç†
					return;
				} else {
					// ç‚¹å‡»ç©ºç™½å¤„
					// ç‚¹å‡»ç©ºç™½å¤„æ—¶ï¼Œå–æ¶ˆç¼–è¾‘çŠ¶æ€
					if (State.editingElement) {
						State.editingElement.element.classList.remove('editing');
						State.editingElement = null;
					}
					
					// æ£€æŸ¥ç¼–è¾‘åŒºç§»åŠ¨æ¨¡å¼
					if (Config.editorPanMode) {
						startEditorPan(touch.clientX, touch.clientY);
						return;
					}
					
					if (Config.batchMoveMode) {
						// å¦‚æœå·²ç»æœ‰é€‰ä¸­å…ƒç´ ï¼Œå¼€å§‹æ‰¹é‡ç§»åŠ¨
						const batchSelected = getBatchSelectedElements();
						if (batchSelected.length > 0) {
							startElementDrag(batchSelected[0], touch.clientX, touch.clientY, true);
						}
						return;
					}
					
					if (Config.clickSelectionMode) {
						clearClickSelection();
						return;
					}
					
					// å¦‚æœé”®ç›˜æ¿€æ´»ï¼Œç‚¹å‡»ç©ºç™½å¤„åˆ›å»ºæ–°å…ƒç´ å¹¶å¼€å§‹ç¼–è¾‘
					if (Config.keyboardActive) {
						createElementAtPoint(logicX, logicY);
						return;
					}
					
					if (Config.selectionMode) {
						startSelection(touch.clientX, touch.clientY);
						clearSelection();
					} else {
						// æ™®é€šæ¨¡å¼ä¸‹ç‚¹å‡»ç©ºç™½å¤„ï¼Œæ¸…é™¤æ‰€æœ‰é€‰æ‹©
						clearSelection();
						clearClickSelection();
						clearDragSelection();
						startDragSelection(touch.clientX, touch.clientY);
					}
				}
			} else if (e.touches.length === 2) {
				// åŒæŒ‡ç¼©æ”¾å¼€å§‹
				e.preventDefault();
				startPinchZoom(e);
			}
		}
		
		// åœ¨åˆå§‹åŒ–å‡½æ•°ä¸­æ·»åŠ é¢æ¿å…³é—­ç›‘å¬
		function initPanelCloseListeners() {
			// ç‚¹å‡»ç¼–è¾‘åŒºåŸŸæ—¶å…³é—­é¢æ¿
			editorArea.addEventListener('mousedown', function(e) {
				// æ£€æŸ¥æ˜¯å¦ç‚¹å‡»äº†å…ƒç´ ï¼Œå¦‚æœæ˜¯å…ƒç´ åˆ™ä¸å…³é—­é¢æ¿
				const logicPos = CoordinateSystem.screenToLogic(e.clientX, e.clientY);
				const clickedElement = getElementAtPoint(logicPos.x, logicPos.y);
				
				// åªæœ‰ç‚¹å‡»ç©ºç™½å¤„æ—¶æ‰å…³é—­é¢æ¿
				if (!clickedElement) {
					closeAllPanels();
				}
			});
			
			// è§¦æ‘¸äº‹ä»¶
			editorArea.addEventListener('touchstart', function(e) {
				if (e.touches.length === 1) {
					const touch = e.touches[0];
					const logicPos = CoordinateSystem.screenToLogic(touch.clientX, touch.clientY);
					const clickedElement = getElementAtPoint(logicPos.x, logicPos.y);
					
					// åªæœ‰ç‚¹å‡»ç©ºç™½å¤„æ—¶æ‰å…³é—­é¢æ¿
					if (!clickedElement) {
						closeAllPanels();
					}
				}
			}, { passive: false });
			
			// æ»šåŠ¨æ—¶å…³é—­é¢æ¿
			editorContainer.addEventListener('scroll', function() {
				closeAllPanels();
			});
		}
		

		function handleElementMouseDown(e, elementData) {
			e.stopPropagation();
			
			// å¦‚æœæ­£åœ¨ç¼–è¾‘åŒºç§»åŠ¨æ¨¡å¼ï¼Œä¸å¤„ç†å…ƒç´ ç‚¹å‡»
			if (Config.editorPanMode) {
				return;
			}
			
			// ç‚¹å‡»å…¶ä»–å…ƒç´ æ—¶ï¼Œæ¸…é™¤å½“å‰ç¼–è¾‘çŠ¶æ€
			if (State.editingElement && State.editingElement.id !== elementData.id) {
				State.editingElement.element.classList.remove('editing');
				State.editingElement = null;
				
				// å¦‚æœé”®ç›˜è¿˜æ¿€æ´»ç€ï¼Œä¹Ÿå…³é—­å®ƒ
				if (Config.keyboardActive) {
					toggleKeyboard();
				}
			}
			
			// å¦‚æœæ­£åœ¨æ‰¹é‡ç§»åŠ¨ï¼Œé€‰æ‹©å…ƒç´ ä½†ä¸å¯åŠ¨æ‹–æ‹½
			if (Config.batchMoveMode) {
				if (!elementData.clickSelected && !elementData.dragSelected) {
					toggleClickSelectElement(elementData);
				}
				return;
			}
			
			// å¦‚æœåœ¨ç‚¹å‡»é€‰æ‹©æ¨¡å¼ï¼Œåªåˆ‡æ¢é€‰æ‹©çŠ¶æ€
			if (Config.clickSelectionMode) {
				toggleClickSelectElement(elementData);
				return;
			}
			
			// æ™®é€šæ¨¡å¼ï¼šå¯åŠ¨å…ƒç´ æ‹–æ‹½
			if (!e.shiftKey && !e.ctrlKey) {
				clearSelection();
				clearClickSelection();
				clearDragSelection();
			}
			
			selectElement(elementData);
			startElementDrag(elementData, e.clientX, e.clientY);
		}

		function handleElementTouchStart(e, elementData) {
			e.stopPropagation();
			e.preventDefault();
			
			// å¦‚æœæ­£åœ¨ç¼–è¾‘åŒºç§»åŠ¨æ¨¡å¼ï¼Œä¸å¤„ç†å…ƒç´ ç‚¹å‡»
			if (Config.editorPanMode) {
				return;
			}
			
			// ç‚¹å‡»å…¶ä»–å…ƒç´ æ—¶ï¼Œæ¸…é™¤å½“å‰ç¼–è¾‘çŠ¶æ€
			if (State.editingElement && State.editingElement.id !== elementData.id) {
				State.editingElement.element.classList.remove('editing');
				State.editingElement = null;
			}
			
			// å¦‚æœæ­£åœ¨æ‰¹é‡ç§»åŠ¨ï¼Œé€‰æ‹©å…ƒç´ ä½†ä¸å¯åŠ¨æ‹–æ‹½
			if (Config.batchMoveMode) {
				if (!elementData.clickSelected && !elementData.dragSelected) {
					toggleClickSelectElement(elementData);
				}
				return;
			}
			
			// å¦‚æœåœ¨ç‚¹å‡»é€‰æ‹©æ¨¡å¼ï¼Œåªåˆ‡æ¢é€‰æ‹©çŠ¶æ€
			if (Config.clickSelectionMode) {
				toggleClickSelectElement(elementData);
				return;
			}
			
			// æ™®é€šæ¨¡å¼ï¼šå¯åŠ¨å…ƒç´ æ‹–æ‹½
			if (e.touches.length === 1) {
				clearSelection();
				clearClickSelection();
				clearDragSelection();
				selectElement(elementData);
				startElementDrag(elementData, e.touches[0].clientX, e.touches[0].clientY);
			}
		}

		function handleElementDoubleClick(e, elementData) {
			// å¦‚æœæ­£åœ¨ç¼–è¾‘åŒºç§»åŠ¨æ¨¡å¼ï¼Œä¸å¤„ç†åŒå‡»
			if (Config.editorPanMode) {
				return;
			}
			
			e.stopPropagation();
			editElement(elementData);
		}

		// ==================== ç¼–è¾‘åŠŸèƒ½ ====================
function createElementAtPoint(logicX, logicY) {
	if (!Config.keyboardActive) return;
	
	// åˆ›å»ºä¸´æ—¶å…ƒç´ 
	const elementData = createElement('', logicX, logicY);
	selectElement(elementData);
	
	// ç›´æ¥è®¾ç½®ç¼–è¾‘çŠ¶æ€ï¼Œä¸è¦è°ƒç”¨ editElement
	State.editingElement = elementData;
	elementData.element.classList.add('editing');
	
	// è®¾ç½®è¾“å…¥æ¡†å†…å®¹
	inputTextbox.value = elementData.content;
	
	// ç»‘å®šè¾“å…¥äº‹ä»¶
	inputTextbox.oninput = function() {
		if (State.editingElement) {
			State.editingElement.content = inputTextbox.value;
			State.editingElement.element.textContent = inputTextbox.value;
			updateElementDisplay(State.editingElement);
		}
	};
	
	// ç¡®ä¿é”®ç›˜ä¿æŒæ¿€æ´»çŠ¶æ€
	if (!Config.keyboardActive) {
		toggleKeyboard();
	}
	
	// èšç„¦è¾“å…¥æ¡†ï¼ˆä¿æŒé”®ç›˜å¼¹å‡ºï¼‰
	setTimeout(() => {
		inputTextbox.focus();
		inputTextbox.select();
	}, 100);
	
	showStatusTip('æ­£åœ¨ç¼–è¾‘æ–°å…ƒç´ ');
}

		function editSelectedElement() {
			const selected = getAllSelectedElements();
			if (selected.length === 0) {
				showStatusTip('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªå…ƒç´ ');
				return;
			}
			
			if (selected.length > 1) {
				showStatusTip('åªèƒ½ç¼–è¾‘å•ä¸ªå…ƒç´ ï¼Œè¯·åªé€‰æ‹©ä¸€ä¸ªå…ƒç´ ');
				return;
			}
			
			editElement(selected[0]);
		}

function editElement(elementData) {
	// å…ˆæ¸…é™¤æ‰€æœ‰å…ƒç´ çš„ç¼–è¾‘çŠ¶æ€ï¼ˆä¿ç•™åŸé€»è¾‘ï¼‰
	State.elements.forEach(el => {
		if (el.element) {
			el.element.classList.remove('editing');
			el.element.classList.remove('selected');
			el.element.classList.remove('click-selected');
		}
	});
	
	// æ¸…é™¤æ‰€æœ‰é€‰æ‹©çŠ¶æ€ï¼ˆä¿ç•™åŸé€»è¾‘ï¼‰
	State.selectedIds.clear();
	State.clickSelectedIds.clear();
	State.dragSelectedIds.clear();
	
	// æ¿€æ´»é”®ç›˜ï¼ˆå¦‚æœéœ€è¦ï¼‰ï¼ˆä¿ç•™åŸé€»è¾‘ï¼‰
	if (!Config.keyboardActive) {
		toggleKeyboard();
	}
	
	State.editingElement = elementData;
	
	// è®¾ç½®è¾“å…¥æ¡†å†…å®¹ï¼ˆä¿ç•™åŸé€»è¾‘ï¼‰
	inputTextbox.value = elementData.content;
	
	// æ ‡è®°ç¼–è¾‘çŠ¶æ€ï¼ˆåªæ ‡è®°å½“å‰å…ƒç´ ï¼‰ï¼ˆä¿ç•™åŸé€»è¾‘ï¼‰
	elementData.element.classList.add('editing');
	
	// ç»‘å®šè¾“å…¥äº‹ä»¶ï¼Œå³æ—¶æ›´æ–°å…ƒç´ å†…å®¹ï¼ˆä¿ç•™åŸé€»è¾‘ï¼‰
	inputTextbox.oninput = function() {
		if (State.editingElement) {
			State.editingElement.content = inputTextbox.value;
			State.editingElement.element.textContent = inputTextbox.value;
			
			// å³æ—¶æ›´æ–°æ˜¾ç¤ºï¼Œä½†å…ˆä¸ä¿å­˜æ›´æ”¹æ ‡è®°ï¼ˆç­‰å¾…ç¡®è®¤ï¼‰
			updateElementDisplay(State.editingElement);
			
			// å¯é€‰ï¼šæ˜¾ç¤ºå³æ—¶æ›´æ–°æç¤º
			if (inputTextbox.value.length > 0) {
				showBriefStatusTip('å³æ—¶æ›´æ–°ä¸­...', 300);
			}
		}
	};
	
	// ============ å…³é”®ä¿®æ”¹å¼€å§‹ ============
	// åˆ é™¤è‡ªåŠ¨æ»šåŠ¨åˆ°ä¸­å¿ƒçš„ä»£ç ï¼Œä¿æŒå½“å‰è§†å›¾ä½ç½®
	
	// åŸä»£ç ï¼ˆå¯¼è‡´è‡ªåŠ¨è·³è½¬ï¼‰ï¼š
	// const elementScreenPos = CoordinateSystem.logicToScreen(elementData.x, elementData.y);
	// const editorRect = editorContainer.getBoundingClientRect();
	// 
	// // å¦‚æœå…ƒç´ ä¸åœ¨è§†å£ä¸­å¿ƒé™„è¿‘ï¼Œè°ƒæ•´æ»šåŠ¨ä½ç½®
	// const targetScrollLeft = elementData.x * Config.zoom - editorRect.width / 2 + elementData.width * Config.zoom / 2;
	// const targetScrollTop = elementData.y * Config.zoom - editorRect.height / 2 + elementData.height * Config.zoom / 2;
	// 
	// editorContainer.scrollLeft = Math.max(0, targetScrollLeft);
	// editorContainer.scrollTop = Math.max(0, targetScrollTop);
	
	// æ–°é€»è¾‘ï¼šæ£€æŸ¥æ˜¯å¦éœ€è¦é¿å…é”®ç›˜é®æŒ¡
	checkAndAdjustForKeyboard(elementData);
	// ============ å…³é”®ä¿®æ”¹ç»“æŸ ============
	
	// èšç„¦åˆ°è¾“å…¥æ¡†ï¼ˆä¿ç•™åŸé€»è¾‘ï¼‰
	setTimeout(() => {
		inputTextbox.focus();
		inputTextbox.selectionStart = inputTextbox.value.length;
		inputTextbox.selectionEnd = inputTextbox.value.length;
	}, 100);
	
	showStatusTip('æ­£åœ¨ç¼–è¾‘å…ƒç´ ï¼Œè¾“å…¥å†…å®¹å³æ—¶æ›´æ–°');
}

// æ–°å¢è¾…åŠ©å‡½æ•°ï¼šæ£€æŸ¥å¹¶è°ƒæ•´é”®ç›˜é®æŒ¡
function checkAndAdjustForKeyboard(elementData) {
	// æ£€æŸ¥é”®ç›˜æ˜¯å¦å¯èƒ½å¼¹å‡ºï¼ˆç§»åŠ¨ç«¯ï¼‰
	const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
	
	if (!isMobile) {
		return; // æ¡Œé¢ç«¯ä¸éœ€è¦å¤„ç†é”®ç›˜é®æŒ¡
	}
	
	// è®¡ç®—å…ƒç´ åœ¨å±å¹•ä¸­çš„ä½ç½®
	const elementScreenY = elementData.y * Config.zoom;
	const elementHeight = elementData.height * Config.zoom;
	const viewportHeight = editorContainer.clientHeight;
	
	// é¢„ä¼°é”®ç›˜é«˜åº¦ï¼ˆç§»åŠ¨ç«¯é”®ç›˜é€šå¸¸å å±å¹•40-50%ï¼‰
	const estimatedKeyboardHeight = viewportHeight * 0.5;
	
	// å¦‚æœå…ƒç´ åœ¨é”®ç›˜å¯èƒ½é®æŒ¡çš„åŒºåŸŸï¼ˆå±å¹•ä¸‹åŠéƒ¨åˆ†ï¼‰
	const elementBottomPosition = (elementScreenY + elementHeight) - editorContainer.scrollTop;
	
	if (elementBottomPosition > (viewportHeight - estimatedKeyboardHeight)) {
		// è½»å¾®è°ƒæ•´ï¼Œè®©å…ƒç´ å¯è§ï¼ˆä¸æ˜¯è·³åˆ°ä¸­å¿ƒï¼‰
		const adjustment = elementBottomPosition - (viewportHeight - estimatedKeyboardHeight) + 20;
		
		// å¹³æ»‘æ»šåŠ¨è°ƒæ•´
		editorContainer.scrollTo({
			top: editorContainer.scrollTop + adjustment,
			behavior: 'smooth'
		});
		
		// æç¤ºç”¨æˆ·
		showBriefStatusTip("å·²è°ƒæ•´ä½ç½®é¿å…é”®ç›˜é®æŒ¡", 1500);
	}
}

// æ–°å¢è¾…åŠ©å‡½æ•°ï¼šæ˜¾ç¤ºçŸ­æš‚æç¤º
function showBriefStatusTip(message, duration = 1000) {
	const tempTip = document.createElement('div');
	tempTip.className = 'status-tip';
	tempTip.textContent = message;
	tempTip.style.bottom = '120px';
	tempTip.style.zIndex = '2000';
	tempTip.style.fontSize = '12px';
	tempTip.style.opacity = '0.8';
	document.body.appendChild(tempTip);
	
	setTimeout(() => {
		tempTip.remove();
	}, duration);
}

// æ·»åŠ æ–°çš„çŸ­æš‚çŠ¶æ€æç¤ºå‡½æ•°
function showBriefStatusTip(message, duration = 1000) {
	const tempTip = document.createElement('div');
	tempTip.className = 'status-tip';
	tempTip.textContent = message;
	tempTip.style.bottom = '120px';
	tempTip.style.zIndex = '2000';
	tempTip.style.fontSize = '12px';
	tempTip.style.opacity = '0.8';
	document.body.appendChild(tempTip);
	
	setTimeout(() => {
		tempTip.remove();
	}, duration);
}

		function clearEditState() {
			if (State.editingElement) {
				State.editingElement.element.classList.remove('editing');
				State.editingElement = null;
			}
		}

		// ==================== ç‚¹å‡»é€‰æ‹©æ¨¡å¼ ====================
		function toggleClickSelectionMode() {
			Config.clickSelectionMode = !Config.clickSelectionMode;
			Config.batchMoveMode = false;
			Config.selectionMode = false;
			Config.keyboardActive = false;
			Config.editorPanMode = false; // é€€å‡ºç¼–è¾‘åŒºç§»åŠ¨æ¨¡å¼
			
			if (Config.editorPanMode) {
				toggleEditorPanMode();
			}
			
			if (Config.clickSelectionMode) {
				clickSelectBtn.textContent = 'é€€å‡ºæ¡†é€‰';
				clickSelectBtn.classList.add('danger');
				showModeIndicator('ç‚¹å‡»é€‰æ‹©æ¨¡å¼ï¼šç‚¹å‡»å…ƒç´ è¿›è¡Œå¤šé€‰');
				showStatusTip('ç‚¹å‡»é€‰æ‹©æ¨¡å¼å·²å¼€å¯ï¼Œç‚¹å‡»å…ƒç´ è¿›è¡Œå¤šé€‰');
			} else {
				clickSelectBtn.textContent = 'ç‚¹å‡»æ¡†é€‰';
				clickSelectBtn.classList.remove('danger');
				clearClickSelection();
				hideModeIndicator();
				showStatusTip('ç‚¹å‡»é€‰æ‹©æ¨¡å¼å·²å…³é—­');
			}
		}

		function toggleClickSelectElement(elementData) {
			const isSelected = State.clickSelectedIds.has(elementData.id);
			
			if (isSelected) {
				// å–æ¶ˆé€‰æ‹©
				State.clickSelectedIds.delete(elementData.id);
				elementData.clickSelected = false;
				elementData.element.classList.remove('click-selected');
			} else {
				// é€‰æ‹©å…ƒç´ 
				State.clickSelectedIds.add(elementData.id);
				elementData.clickSelected = true;
				elementData.element.classList.add('click-selected');
			}
			
			// æ›´æ–°é€‰æ‹©è®¡æ•°
			updateSelectionCount();
			
			// å¦‚æœæœ‰é€‰ä¸­çš„å…ƒç´ ï¼Œæ˜¾ç¤ºæ‰¹é‡æ“ä½œæŒ‰é’®
			const selectedCount = State.clickSelectedIds.size + State.dragSelectedIds.size;
			if (selectedCount > 0) {
				showBatchActions();
			} else {
				hideBatchActions();
			}
		}

		function clearClickSelection() {
			State.elements.forEach(el => {
				if (el.clickSelected) {
					el.clickSelected = false;
					el.element.classList.remove('click-selected');
				}
			});
			State.clickSelectedIds.clear();
			updateSelectionCount();
			hideBatchActions();
		}

		// ==================== æ‹–æ‹½é€‰æ‹©æ¨¡å¼ ====================
function startDragSelection(clientX, clientY) {
	// å¦‚æœæ­£åœ¨ç¼–è¾‘åŒºç§»åŠ¨æ¨¡å¼ï¼Œä¸å¯åŠ¨æ‹–æ‹½é€‰æ‹©
	if (Config.editorPanMode) {
		return;
	}
	
	Config.dragSelectionMode = true;
	
	// ä¿å­˜èµ·å§‹ç‚¹çš„å±å¹•åæ ‡ï¼ˆç›¸å¯¹äº editorAreaï¼‰
	const rect = editorArea.getBoundingClientRect();
	State.dragSelectionStart.x = clientX - rect.left;
	State.dragSelectionStart.y = clientY - rect.top;
	
	// æ˜¾ç¤ºé€‰æ‹©æ¡†
	dragSelectionBox.style.left = State.dragSelectionStart.x + 'px';
	dragSelectionBox.style.top = State.dragSelectionStart.y + 'px';
	dragSelectionBox.style.width = '0';
	dragSelectionBox.style.height = '0';
	dragSelectionBox.style.display = 'block';
}

// ä¿®æ”¹ updateDragSelection å‡½æ•° - åªä¿®æ”¹åæ ‡å¤„ç†éƒ¨åˆ†
function updateDragSelection(clientX, clientY) {
	if (!Config.dragSelectionMode) return;
	
	// è·å–å½“å‰ç›¸å¯¹äº editorArea çš„å±å¹•åæ ‡
	const rect = editorArea.getBoundingClientRect();
	const currentX = clientX - rect.left;
	const currentY = clientY - rect.top;
	
	// è®¡ç®—æ¡†é€‰æ¡†çš„ä½ç½®å’Œå¤§å°ï¼ˆå±å¹•åæ ‡ï¼‰
	const left = Math.min(State.dragSelectionStart.x, currentX);
	const top = Math.min(State.dragSelectionStart.y, currentY);
	const width = Math.abs(currentX - State.dragSelectionStart.x);
	const height = Math.abs(currentY - State.dragSelectionStart.y);
	
	// æ›´æ–°æ¡†é€‰æ¡†æ˜¾ç¤º
	dragSelectionBox.style.left = left + 'px';
	dragSelectionBox.style.top = top + 'px';
	dragSelectionBox.style.width = width + 'px';
	dragSelectionBox.style.height = height + 'px';
	
	// ç›´æ¥ä½¿ç”¨å±å¹•åæ ‡è¿›è¡Œå…ƒç´ é€‰ä¸­æ£€æµ‹
	updateDragSelectionFromScreenBox(left, top, width, height);
}


// æ–°å¢å‡½æ•°ï¼šä½¿ç”¨å±å¹•åæ ‡è¿›è¡Œå…ƒç´ é€‰ä¸­æ£€æµ‹
function updateDragSelectionFromScreenBox(screenLeft, screenTop, screenWidth, screenHeight) {
	const screenRight = screenLeft + screenWidth;
	const screenBottom = screenTop + screenHeight;
	
	// å…ˆæ¸…é™¤ä¹‹å‰çš„æ‹–æ‹½é€‰æ‹©
	State.elements.forEach(elementData => {
		if (elementData.dragSelected) {
			elementData.dragSelected = false;
			elementData.element.classList.remove('drag-selected');
		}
	});
	State.dragSelectedIds.clear();
	
	// é‡æ–°é€‰æ‹©åœ¨æ¡†å†…çš„å…ƒç´ ï¼ˆä½¿ç”¨å±å¹•åæ ‡ï¼‰
	State.elements.forEach(elementData => {
		// å°†å…ƒç´ çš„é€»è¾‘åæ ‡è½¬æ¢ä¸ºå±å¹•åæ ‡
		const elementScreenLeft = elementData.x * Config.zoom;
		const elementScreenTop = elementData.y * Config.zoom;
		const elementScreenRight = (elementData.x + elementData.width) * Config.zoom;
		const elementScreenBottom = (elementData.y + elementData.height) * Config.zoom;
		
		// å±å¹•åæ ‡ç¢°æ’æ£€æµ‹ - ç¡®ä¿å…ƒç´ åœ¨æ¡†é€‰æ¡†å†…
		const isInside = (
			elementScreenLeft <= screenRight &&
			elementScreenRight >= screenLeft &&
			elementScreenTop <= screenBottom &&
			elementScreenBottom >= screenTop
		);
		
		if (isInside) {
			// é€‰ä¸­å…ƒç´ 
			elementData.dragSelected = true;
			State.dragSelectedIds.add(elementData.id);
			
			// æ·»åŠ è§†è§‰åé¦ˆ
			elementData.element.classList.add('drag-selected');
			
			// è°ƒè¯•ä¿¡æ¯ï¼ˆå¯é€‰ï¼‰
			console.log(`é€‰ä¸­å…ƒç´ : ${elementData.content}`, {
				elementScreen: [elementScreenLeft, elementScreenTop, elementScreenRight, elementScreenBottom],
				selectionBox: [screenLeft, screenTop, screenRight, screenBottom],
				zoom: Config.zoom
			});
		}
	});
	
	// å¼ºåˆ¶æ›´æ–°UIçŠ¶æ€
	updateSelectionCount();
}





// ä¿®æ”¹ updateDragSelectionFromBox å‡½æ•° - æ·»åŠ å®¹å·®æœºåˆ¶
// 5. ä¿®æ”¹ updateDragSelectionFromBox å‡½æ•°ï¼Œç¡®ä¿æ­£ç¡®è®¾ç½® dragSelected çŠ¶æ€
function updateDragSelectionFromBox(logicLeft, logicTop, logicWidth, logicHeight) {
	const right = logicLeft + logicWidth;
	const bottom = logicTop + logicHeight;
	
	// å…ˆæ¸…é™¤ä¹‹å‰çš„æ‹–æ‹½é€‰æ‹©
	State.elements.forEach(elementData => {
		if (elementData.dragSelected) {
			elementData.dragSelected = false;
			elementData.element.classList.remove('drag-selected');
		}
	});
	State.dragSelectedIds.clear();
	
	// é‡æ–°é€‰æ‹©åœ¨æ¡†å†…çš„å…ƒç´ 
	State.elements.forEach(elementData => {
		const elementLeft = elementData.x;
		const elementTop = elementData.y;
		const elementRight = elementData.x + elementData.width;
		const elementBottom = elementData.y + elementData.height;
		
		// ç¢°æ’æ£€æµ‹ - ç¡®ä¿åœ¨ç¼©æ”¾æ—¶ä¹Ÿèƒ½å‡†ç¡®æ£€æµ‹
		const isInside = (
			elementLeft <= right &&
			elementRight >= logicLeft &&
			elementTop <= bottom &&
			elementBottom >= logicTop
		);
		
		if (isInside) {
			elementData.dragSelected = true;
			State.dragSelectedIds.add(elementData.id);
			
			// ç¡®ä¿è§†è§‰åé¦ˆ
			elementData.element.classList.add('drag-selected');
			
			// ç¡®ä¿å…ƒç´ è¢«æ­£ç¡®é€‰ä¸­
			elementData.selected = true;
			elementData.element.classList.add('selected');
		}
	});
	
	// å¼ºåˆ¶æ›´æ–°UIçŠ¶æ€
	updateSelectionCount();
}

		function clearDragSelection() {
			State.elements.forEach(elementData => {
				if (elementData.dragSelected) {
					elementData.dragSelected = false;
					elementData.element.classList.remove('drag-selected');
				}
			});
			State.dragSelectedIds.clear();
			updateSelectionCount();
		}

// ä¿®æ”¹ endDragSelection å‡½æ•° - ç¡®ä¿æ˜¾ç¤ºæ‰¹é‡æ“ä½œæŒ‰é’®
// 3. ä¿®æ”¹ endDragSelection å‡½æ•°ï¼Œç¡®ä¿è°ƒç”¨æ­£ç¡®çš„å‡½æ•°
		function endDragSelection() {
			if (Config.dragSelectionMode) {
				Config.dragSelectionMode = false;
				dragSelectionBox.style.display = 'none';
				
				// æ£€æŸ¥æ˜¯å¦æœ‰æ‹–æ‹½é€‰ä¸­çš„å…ƒç´ 
				const dragSelectedElements = State.elements.filter(el => el.dragSelected);
				
				if (dragSelectedElements.length > 0) {
					// æ˜¾ç¤ºæ‰¹é‡æ“ä½œæŒ‰é’®
					showBatchActions();
					
					// è¾“å‡ºè°ƒè¯•ä¿¡æ¯
					console.log(`æ¡†é€‰ç»“æŸï¼Œé€‰ä¸­ ${dragSelectedElements.length} ä¸ªå…ƒç´ `);
					console.log('é€‰ä¸­å…ƒç´ ID:', Array.from(State.dragSelectedIds));
				} else {
					// å¦‚æœæ²¡æœ‰é€‰ä¸­å…ƒç´ ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰å…¶ä»–é€‰ä¸­æ–¹å¼
					const totalSelected = State.clickSelectedIds.size + State.dragSelectedIds.size;
					if (totalSelected === 0) {
						hideBatchActions();
					}
				}
			}
		}
 	

		// ==================== æ‹–åŠ¨å¤„ç† ====================
		function startElementDrag(elementData, clientX, clientY, isBatchMove = false) {
			// å¦‚æœæ­£åœ¨ç¼–è¾‘åŒºç§»åŠ¨æ¨¡å¼ï¼Œä¸å¯åŠ¨å…ƒç´ æ‹–æ‹½
			if (Config.editorPanMode) {
				return;
			}
			
			Config.isDragging = true;
			
			// ä¿å­˜èµ·å§‹å±å¹•åæ ‡
			State.dragStart.x = clientX;
			State.dragStart.y = clientY;
			
			// æ ¹æ®æ¨¡å¼å†³å®šè¦ç§»åŠ¨å“ªäº›å…ƒç´ 
			let elementsToMove;
			if (isBatchMove || Config.batchMoveMode) {
				// æ‰¹é‡ç§»åŠ¨æ¨¡å¼ä¸‹ç§»åŠ¨æ‰€æœ‰æ‰¹é‡é€‰æ‹©çš„å…ƒç´ 
				elementsToMove = getBatchSelectedElements();
				if (elementsToMove.length === 0) {
					elementsToMove = [elementData];
				}
			} else {
				// æ™®é€šæ¨¡å¼ä¸‹ç§»åŠ¨æ‰€æœ‰æ™®é€šé€‰æ‹©çš„å…ƒç´ 
				elementsToMove = getSelectedElements();
				if (elementsToMove.length === 0) {
					elementsToMove = [elementData];
				}
			}
			
			// ä¿å­˜åŸå§‹é€»è¾‘ä½ç½®
			State.originalPositions = elementsToMove.map(el => ({
				element: el,
				originalX: el.x,
				originalY: el.y
			}));
			
			// è®¾ç½®æ‹–åŠ¨çŠ¶æ€
			elementData.element.classList.add('dragging');
			
			// æ ‡è®°æœ‰æœªä¿å­˜çš„æ›´æ”¹
			markUnsavedChanges();
		}

		function handleContainerTouchMove(e) {
			if (e.touches.length === 1) {
				if (Config.isPanning) {
					// å¤„ç†ç¼–è¾‘åŒºç§»åŠ¨
					e.preventDefault();
					updateEditorPan(e.touches[0].clientX, e.touches[0].clientY);
				} else if (Config.isDragging) {
					e.preventDefault();
					updateElementDrag(e.touches[0].clientX, e.touches[0].clientY);
				} else if (Config.isSelecting) {
					e.preventDefault();
					updateSelection(e.touches[0].clientX, e.touches[0].clientY);
				} else if (Config.dragSelectionMode) {
					e.preventDefault();
					updateDragSelection(e.touches[0].clientX, e.touches[0].clientY);
				}
			} else if (e.touches.length === 2) {
				e.preventDefault();
				updatePinchZoom(e);
			}
		}

		function updateElementDrag(clientX, clientY) {
			if (!Config.isDragging) return;
			
			// å°†å±å¹•ç§»åŠ¨è·ç¦»è½¬æ¢ä¸ºé€»è¾‘è·ç¦»
			const deltaScreenX = clientX - State.dragStart.x;
			const deltaScreenY = clientY - State.dragStart.y;
			
			const deltaLogicX = deltaScreenX / Config.zoom;
			const deltaLogicY = deltaScreenY / Config.zoom;
			
			State.originalPositions.forEach(pos => {
				const elementData = pos.element;
				let newLogicX = pos.originalX + deltaLogicX;
				let newLogicY = pos.originalY + deltaLogicY;
				
				// å¯¹é½å¸é™„ï¼ˆä½¿ç”¨é€»è¾‘åæ ‡ï¼‰
				if (Config.alignOptions.grid || Config.alignOptions.edge || Config.alignOptions.center) {
					if (State.originalPositions.length === 1) {
						const snapResult = calculateSnapPosition(newLogicX, newLogicY, elementData);
						if (snapResult) {
							newLogicX = snapResult.x;
							newLogicY = snapResult.y;
							showGuides(snapResult.lines);
						} else {
							hideGuides();
						}
					}
				}
				
				// è¾¹ç•Œæ£€æŸ¥ï¼ˆä½¿ç”¨é€»è¾‘åæ ‡ï¼‰
				newLogicX = Math.max(0, Math.min(newLogicX, 2000 - elementData.width));
				newLogicY = Math.max(0, Math.min(newLogicY, 2000 - elementData.height));
				
				// æ›´æ–°é€»è¾‘åæ ‡
				elementData.x = newLogicX;
				elementData.y = newLogicY;
				
				// æ›´æ–°å±å¹•æ˜¾ç¤º
				updateElementDisplay(elementData);
			});
		}

		function handleWheel(e) {
			if (e.ctrlKey) {
				e.preventDefault();
				
				const scaleChange = e.deltaY > 0 ? 0.9 : 1.1;
				const newZoom = Config.zoom * scaleChange;
				
				// ä»¥é¼ æ ‡ä½ç½®ä¸ºä¸­å¿ƒç¼©æ”¾
				updateZoom(newZoom, e.clientX, e.clientY);
			}
		}

		// é‡æ„ç¼©æ”¾ç³»ç»Ÿ
		function applyZoomAroundPoint(newZoom, centerScreenX, centerScreenY) {
			// é™åˆ¶ç¼©æ”¾èŒƒå›´
			newZoom = Math.max(Config.minZoom, Math.min(Config.maxZoom, newZoom));
			
			if (Math.abs(newZoom - Config.zoom) < 0.001) {
				return false;
			}
			
			const oldZoom = Config.zoom;
			const scaleRatio = newZoom / oldZoom;
			
			// è®¡ç®—ä¸­å¿ƒç‚¹çš„é€»è¾‘åæ ‡
			const centerLogic = CoordinateSystem.screenToLogic(centerScreenX, centerScreenY);
			const centerLogicX = centerLogic.x;
			const centerLogicY = centerLogic.y;
			
			// æ›´æ–°æ‰€æœ‰å…ƒç´ çš„å±å¹•æ˜¾ç¤º
			updateAllElementsDisplay();
			
			// è°ƒæ•´æ»šåŠ¨ä½ç½®ï¼Œä¿æŒä¸­å¿ƒç‚¹åœ¨å±å¹•çš„åŒä¸€ä½ç½®
			const newScrollLeft = centerLogicX * newZoom - (centerScreenX - editorArea.getBoundingClientRect().left);
			const newScrollTop = centerLogicY * newZoom - (centerScreenY - editorArea.getBoundingClientRect().top);
			
			// åº”ç”¨æ–°çš„æ»šåŠ¨ä½ç½®ï¼ˆç¡®ä¿ä¸è¶…å‡ºè¾¹ç•Œï¼‰
			const maxScrollX = Math.max(0, editorArea.scrollWidth - editorContainer.clientWidth);
			const maxScrollY = Math.max(0, editorArea.scrollHeight - editorContainer.clientHeight);
			
			editorContainer.scrollLeft = Math.max(0, Math.min(newScrollLeft, maxScrollX));
			editorContainer.scrollTop = Math.max(0, Math.min(newScrollTop, maxScrollY));
			
			// æ›´æ–°ç¼©æ”¾é…ç½®
			Config.zoom = newZoom;
			
			// æ›´æ–°UI
			updateZoomIndicator();
			updateGridForZoom();
			
			return true;
		}

		// ä¿®æ”¹åŸæ¥çš„ç¼©æ”¾å‡½æ•°
		function updateZoom(newZoom, centerX = null, centerY = null) {
			if (centerX === null || centerY === null) {
				// ä½¿ç”¨è§†å£ä¸­å¿ƒ
				const rect = editorArea.getBoundingClientRect();
				centerX = editorContainer.clientWidth / 2;
				centerY = editorContainer.clientHeight / 2;
			}
			
			const changed = applyZoomAroundPoint(newZoom, centerX, centerY);
			
			if (changed) {
				showStatusTip(`${Math.round(Config.zoom * 100)}%`, 800);
				markUnsavedChanges();
			}
		}

		// æåˆç¼©æ”¾ç›¸å…³å˜é‡
		let isPinching = false;
		let pinchStartDistance = 0;
		let pinchStartZoom = 1;
		let pinchCenterX = 0;
		let pinchCenterY = 0;

		function handlePinchStart(e) {
			if (e.touches.length !== 2) return;
			
			e.preventDefault();
			e.stopPropagation();
			
			isPinching = true;
			
			const touch1 = e.touches[0];
			const touch2 = e.touches[1];
			
			// è®¡ç®—åˆå§‹è·ç¦»
			pinchStartDistance = Math.sqrt(
				Math.pow(touch2.clientX - touch1.clientX, 2) + 
				Math.pow(touch2.clientY - touch1.clientY, 2)
			);
			
			// ä¿å­˜å½“å‰ç¼©æ”¾çº§åˆ«
			pinchStartZoom = Config.zoom;
			
			// è®¡ç®—æåˆä¸­å¿ƒç‚¹
			pinchCenterX = (touch1.clientX + touch2.clientX) / 2;
			pinchCenterY = (touch1.clientY + touch2.clientY) / 2;
			
			// åœæ­¢å…¶ä»–äº¤äº’
			if (Config.isDragging) {
				endDrag();
			}
			
			// æ˜¾ç¤ºç¼©æ”¾æç¤º
			showStatusTip('åŒæŒ‡ç¼©æ”¾ä¸­...', 1000);
		}

		function handlePinchMove(e) {
			if (!isPinching || e.touches.length !== 2) return;
			
			e.preventDefault();
			e.stopPropagation();
			
			const touch1 = e.touches[0];
			const touch2 = e.touches[1];
			
			// è®¡ç®—å½“å‰è·ç¦»
			const currentDistance = Math.sqrt(
				Math.pow(touch2.clientX - touch1.clientX, 2) + 
				Math.pow(touch2.clientY - touch1.clientY, 2)
			);
			
			// è®¡ç®—ç¼©æ”¾æ¯”ä¾‹
			if (pinchStartDistance > 0) {
				const scaleChange = currentDistance / pinchStartDistance;
				const newZoom = pinchStartZoom * scaleChange;
				
				// æ›´æ–°å½“å‰æåˆä¸­å¿ƒç‚¹
				const currentCenterX = (touch1.clientX + touch2.clientX) / 2;
				const currentCenterY = (touch1.clientY + touch2.clientY) / 2;
				
				// åº”ç”¨ç¼©æ”¾ï¼Œä»¥æåˆç‚¹ä¸ºä¸­å¿ƒ
				updateZoom(newZoom, currentCenterX, currentCenterY);
			}
		}

		function handlePinchEnd() {
			isPinching = false;
			pinchStartDistance = 0;
			pinchStartZoom = 1;
			
			// æ˜¾ç¤ºæœ€ç»ˆç¼©æ”¾æ¯”ä¾‹
			showStatusTip(`ç¼©æ”¾: ${Math.round(Config.zoom * 100)}%`, 1000);
		}

// 9. ç¡®ä¿åœ¨ç¼©æ”¾æ—¶ï¼Œæ‰¹é‡æ“ä½œæŒ‰é’®çš„çŠ¶æ€æ­£ç¡®
// ä¿®æ”¹ç¼©æ”¾ç›¸å…³çš„å‡½æ•°ï¼Œç¡®ä¿ç¼©æ”¾åæ‰¹é‡æ“ä½œæŒ‰é’®çŠ¶æ€æ­£ç¡®
function updateZoomIndicator() {
	const percentage = Math.round(Config.zoom * 100);
	zoomIndicator.textContent = `${percentage}%`;
	zoomIndicator.style.display = 'block';
	
	// ç¼©æ”¾åæ£€æŸ¥æ˜¯å¦æœ‰é€‰ä¸­å…ƒç´ ï¼Œå¦‚æœæœ‰åˆ™ç¡®ä¿æ‰¹é‡æ“ä½œæŒ‰é’®æ˜¾ç¤º
	const selectedCount = getBatchSelectedElements().length;
	if (selectedCount > 0) {
		batchActionBar.style.display = 'flex';
	}
	
	clearTimeout(zoomIndicator.hideTimer);
	zoomIndicator.hideTimer = setTimeout(() => {
		zoomIndicator.style.display = 'none';
	}, 3000);
}

		// ==================== æ¡†é€‰å¤„ç† ====================
		function startSelectionMode() {
			Config.selectionMode = !Config.selectionMode;
			Config.keyboardActive = false;
			
			if (Config.selectionMode) {
				showStatusTip('é€‰æ‹©æ¨¡å¼å·²å¼€å¯ï¼šæ‹–åŠ¨å¯æ¡†é€‰å¤šä¸ªå…ƒç´ ');
			} else {
				showStatusTip('é€‰æ‹©æ¨¡å¼å·²å…³é—­');
			}
		}

		function startSelection(clientX, clientY) {
			if (!Config.selectionMode) return;
			
			Config.isSelecting = true;
			
			// è½¬æ¢ä¸ºé€»è¾‘åæ ‡
			const logicStart = CoordinateSystem.screenToLogic(clientX, clientY);
			State.selectionStart.x = logicStart.x;
			State.selectionStart.y = logicStart.y;
			
			// é€‰æ‹©æ¡†çš„æ˜¾ç¤ºä½¿ç”¨å±å¹•åæ ‡
			const screenStart = CoordinateSystem.logicToScreen(logicStart.x, logicStart.y);
			selectionBox.style.left = screenStart.x + 'px';
			selectionBox.style.top = screenStart.y + 'px';
			selectionBox.style.width = '0';
			selectionBox.style.height = '0';
			selectionBox.style.display = 'block';
		}

		function updateSelection(clientX, clientY) {
			if (!Config.isSelecting) return;
			
			// è½¬æ¢ä¸ºé€»è¾‘åæ ‡
			const currentLogic = CoordinateSystem.screenToLogic(clientX, clientY);
			const startLogic = State.selectionStart;
			
			const left = Math.min(startLogic.x, currentLogic.x);
			const top = Math.min(startLogic.y, currentLogic.y);
			const width = Math.abs(currentLogic.x - startLogic.x);
			const height = Math.abs(currentLogic.y - startLogic.y);
			
			// æ›´æ–°é€‰æ‹©æ¡†çš„æ˜¾ç¤ºï¼ˆä½¿ç”¨å±å¹•åæ ‡ï¼‰
			const screenLeftTop = CoordinateSystem.logicToScreen(left, top);
			const screenWidth = width * Config.zoom;
			const screenHeight = height * Config.zoom;
			
			selectionBox.style.left = screenLeftTop.x + 'px';
			selectionBox.style.top = screenLeftTop.y + 'px';
			selectionBox.style.width = screenWidth + 'px';
			selectionBox.style.height = screenHeight + 'px';
			
			// æ›´æ–°é€‰ä¸­å…ƒç´ ï¼ˆä½¿ç”¨é€»è¾‘åæ ‡ï¼‰
			updateSelectionFromBox(left, top, width, height);
		}

		function updateSelectionFromBox(left, top, width, height) {
			const right = left + width;
			const bottom = top + height;
			
			// æ¸…é™¤ä¹‹å‰çš„é€‰ä¸­çŠ¶æ€
			State.elements.forEach(elementData => {
				if (elementData.selected) {
					deselectElement(elementData);
				}
			});
			
			// é€‰æ‹©åœ¨æ¡†å†…çš„å…ƒç´ 
			State.elements.forEach(elementData => {
				const elementLeft = elementData.x;
				const elementTop = elementData.y;
				const elementRight = elementData.x + elementData.width;
				const elementBottom = elementData.y + elementData.height;
				
				const isInside = !(
					elementLeft > right ||
					elementRight < left ||
					elementTop > bottom ||
					elementBottom < top
				);
				
				if (isInside) {
					selectElement(elementData);
				}
			});
		}

		function endSelection() {
			if (Config.isSelecting) {
				Config.isSelecting = false;
				selectionBox.style.display = 'none';
			}
		}

		// ==================== æ‰¹é‡ç§»åŠ¨åŠŸèƒ½ ====================function startBatchMove() {
		function startBatchMove() {
			const selectedCount = getBatchSelectedElements().length;
			console.log(`å¼€å§‹æ‰¹é‡ç§»åŠ¨: ${selectedCount} ä¸ªå…ƒç´ è¢«é€‰ä¸­`);
			
			if (selectedCount === 0) {
				showStatusTip('è¯·å…ˆé€‰æ‹©è¦ç§»åŠ¨çš„å…ƒç´ ');
				return;
			}
			
			Config.batchMoveMode = true;
			Config.clickSelectionMode = false;
			Config.editorPanMode = false;
			
			showModeIndicator('æ‰¹é‡ç§»åŠ¨æ¨¡å¼ï¼šæ‹–åŠ¨ä»»æ„é€‰ä¸­å…ƒç´ ç§»åŠ¨æ•´ä¸ªé€‰æ‹©ç»„');
			showStatusTip(`æ‰¹é‡ç§»åŠ¨æ¨¡å¼å·²å¼€å¯ï¼Œå·²é€‰æ‹© ${selectedCount} ä¸ªå…ƒç´ `);
		}

		function exitBatchMoveMode() {
			Config.batchMoveMode = false;
			hideBatchActions();
			clearClickSelection();
			clearDragSelection();
			hideModeIndicator();
			showStatusTip('å·²é€€å‡ºæ‰¹é‡ç§»åŠ¨æ¨¡å¼');
		}

			// ==================== æ‰¹é‡æ“ä½œåŠŸèƒ½ ====================
	
		function showBatchActions() {
			const selectedElements = getBatchSelectedElements();
			const selectedCount = selectedElements.length;
			
			if (selectedCount > 0) {
				// æ˜¾ç¤ºæ‰¹é‡æ“ä½œæŒ‰é’®æ 
				batchActionBar.style.display = 'flex';
				
				// æ›´æ–°é€‰æ‹©è®¡æ•°
				updateSelectionCount();
				
				// æ˜¾ç¤ºæç¤º
				showStatusTip(`å·²é€‰æ‹© ${selectedCount} ä¸ªå…ƒç´ `);
				
				// è°ƒè¯•ä¿¡æ¯
				console.log(`æ˜¾ç¤ºæ‰¹é‡æ“ä½œæŒ‰é’®: ${selectedCount} ä¸ªå…ƒç´ è¢«é€‰ä¸­, ç¼©æ”¾æ¯”ä¾‹: ${Config.zoom * 100}%`);
			} else {
				hideBatchActions();
			}
		}
		
		// 2. æ·»åŠ éšè—æ‰¹é‡æ“ä½œæŒ‰é’®çš„å‡½æ•°
		function hideBatchActions() {
			batchActionBar.style.display = 'none';
		}



		function hideBatchActions() {
			batchActionBar.style.display = 'none';
		}

		function batchCopy() {
			const selected = getBatchSelectedElements();
			console.log(`æ‰¹é‡å¤åˆ¶: ${selected.length} ä¸ªå…ƒç´ `);
			if (selected.length === 0) {
				showStatusTip('è¯·å…ˆé€‰æ‹©è¦å¤åˆ¶çš„å…ƒç´ ');
				return;
			}
			
			// è®¡ç®—é€‰æ‹©åŒºåŸŸçš„ä¸­å¿ƒ
			let minX = Infinity, minY = Infinity, maxX = -Infinity, maxY = -Infinity;
			selected.forEach(el => {
				minX = Math.min(minX, el.x);
				minY = Math.min(minY, el.y);
				maxX = Math.max(maxX, el.x + el.width);
				maxY = Math.max(maxY, el.y + el.height);
			});
			
			const centerX = (minX + maxX) / 2;
			const centerY = (minY + maxY) / 2;
			
			// å¤åˆ¶æ¯ä¸ªå…ƒç´ 
			selected.forEach(el => {
				const offsetX = el.x - centerX;
				const offsetY = el.y - centerY;
				const newX = centerX + offsetX + 30;
				const newY = centerY + offsetY + 30;
				
				createElement(el.content, newX, newY, {
					fontSize: el.fontSize,
					color: el.color,
					type: el.type
				});
			});
			
			showStatusTip(`å·²å¤åˆ¶ ${selected.length} ä¸ªå…ƒç´ `);
			markUnsavedChanges();
		}

		function batchDelete() {
			const selected = getBatchSelectedElements();
			console.log(`æ‰¹é‡åˆ é™¤: ${selected.length} ä¸ªå…ƒç´ `);
			if (selected.length === 0) {
				showStatusTip('è¯·å…ˆé€‰æ‹©è¦åˆ é™¤çš„å…ƒç´ ');
				return;
			}
			
			// ç›´æ¥åˆ é™¤ï¼Œä¸æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†
			selected.forEach(deleteElement);
			clearSelection();
			clearClickSelection();
			clearDragSelection();
			showStatusTip(`å·²åˆ é™¤ ${selected.length} ä¸ªå…ƒç´ `);
			markUnsavedChanges();
		}

		// ==================== å·¥å…·æ åŠŸèƒ½ ====================
		function addNewElement() {
			// è®¡ç®—å±å¹•ä¸­å¿ƒç‚¹çš„é€»è¾‘åæ ‡
			const screenCenterX = editorContainer.clientWidth / 2;
			const screenCenterY = editorContainer.clientHeight / 2;
			const rect = editorArea.getBoundingClientRect();
			
			const logicX = (screenCenterX + editorContainer.scrollLeft - rect.left) / Config.zoom - 25;
			const logicY = (screenCenterY + editorContainer.scrollTop - rect.top) / Config.zoom - 12.5;
			
			createElement('x', logicX, logicY);
			markUnsavedChanges();
		}

		function deleteSelected() {
			let elementsToDelete = getAllSelectedElements();
			
			if (elementsToDelete.length === 0) {
				showStatusTip('è¯·å…ˆé€‰æ‹©è¦åˆ é™¤çš„å…ƒç´ ');
				return;
			}
			
			// ç›´æ¥åˆ é™¤ï¼Œä¸æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†
			elementsToDelete.forEach(deleteElement);
			clearSelection();
			clearClickSelection();
			clearDragSelection();
			showStatusTip(`å·²åˆ é™¤ ${elementsToDelete.length} ä¸ªå…ƒç´ `);
			markUnsavedChanges();
		}

		function deleteElement(elementData) {
			if (elementData.element && elementData.element.parentNode) {
				elementData.element.parentNode.removeChild(elementData.element);
			}
			const index = State.elements.indexOf(elementData);
			if (index > -1) {
				State.elements.splice(index, 1);
			}
			State.selectedIds.delete(elementData.id);
			State.clickSelectedIds.delete(elementData.id);
			State.dragSelectedIds.delete(elementData.id);
		}

		function clearAll() {
			if (State.elements.length === 0) {
				return;
			}
			
			showConfirmDialog(
				'æ¸…ç©ºæ‰€æœ‰å†…å®¹',
				'ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å†…å®¹å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚',
				'clearAllConfirm',
				'æ¸…ç©º',
				'å–æ¶ˆ'
			);
		}

		// ç¡®è®¤æ¸…ç©ºæ‰€æœ‰å†…å®¹
		function clearAllConfirm(action) {
			if (action === 'save') {
				State.elements.forEach(el => {
					if (el.element && el.element.parentNode) {
						el.element.parentNode.removeChild(el.element);
					}
				});
				State.elements = [];
				State.selectedIds.clear();
				State.clickSelectedIds.clear();
				State.dragSelectedIds.clear();
				
				// æ¸…é™¤è¾…åŠ©å…ƒç´ 
				document.querySelectorAll('[data-type]').forEach(el => el.remove());
				
				showStatusTip('å·²æ¸…ç©ºæ‰€æœ‰å†…å®¹');
				hideBatchActions();
				hideSelectionCount();
				
				// æ ‡è®°æœ‰æœªä¿å­˜çš„æ›´æ”¹
				markUnsavedChanges();
			}
			
			hideConfirmDialog();
		}

		function copySelected() {
			const selected = getAllSelectedElements();
			if (selected.length > 0) {
				// ä¿å­˜é€»è¾‘åæ ‡
				State.clipboard = selected.map(el => ({
					content: el.content,
					x: el.x,              // é€»è¾‘åæ ‡
					y: el.y,
					width: el.width,
					height: el.height,
					fontSize: el.fontSize,
					color: el.color,
					type: el.type
				}));
				showStatusTip(`å·²å¤åˆ¶ ${selected.length} ä¸ªå…ƒç´ `);
			} else {
				showStatusTip('è¯·å…ˆé€‰æ‹©è¦å¤åˆ¶çš„å…ƒç´ ');
			}
		}

		function pasteElements() {
			if (!State.clipboard || State.clipboard.length === 0) {
				showStatusTip('å‰ªè´´æ¿ä¸ºç©º');
				return;
			}
			
			// è®¡ç®—å½“å‰è§†å£ä¸­å¿ƒçš„é€»è¾‘åæ ‡
			const screenCenterX = editorContainer.clientWidth / 2;
			const screenCenterY = editorContainer.clientHeight / 2;
			const logicCenter = CoordinateSystem.screenToLogic(screenCenterX, screenCenterY);
			
			// è®¡ç®—æ‰€æœ‰å¤åˆ¶å…ƒç´ çš„å¹³å‡ä½ç½®
			let avgX = 0, avgY = 0;
			State.clipboard.forEach(item => {
				avgX += item.x;
				avgY += item.y;
			});
			avgX /= State.clipboard.length;
			avgY /= State.clipboard.length;
			
			// è®¡ç®—åç§»é‡ï¼Œä½¿ç²˜è´´çš„å…ƒç´ ç»„ä¸­å¿ƒåœ¨è§†å£ä¸­å¿ƒ
			const offsetX = logicCenter.x - avgX;
			const offsetY = logicCenter.y - avgY;
			
			State.clipboard.forEach((item, index) => {
				const newX = item.x + offsetX + (index % 3) * 10;  // ç¨å¾®é”™å¼€ä¸€ç‚¹
				const newY = item.y + offsetY + Math.floor(index / 3) * 10;
				
				createElement(item.content, newX, newY, {
					fontSize: item.fontSize,
					color: item.color,
					type: item.type
				});
			});
			
			showStatusTip(`å·²ç²˜è´´ ${State.clipboard.length} ä¸ªå…ƒç´ `);
			markUnsavedChanges();
		}

		// ==================== è¾…åŠ©åŠŸèƒ½ ====================
		function showStatusTip(message) {
			statusTip.textContent = message;
			statusTip.style.display = 'block';
			
			setTimeout(() => {
				statusTip.style.display = 'none';
			}, 1500);
		}

		function showModeIndicator(message) {
			modeIndicator.textContent = message;
			modeIndicator.style.display = 'block';
		}

		function hideModeIndicator() {
			modeIndicator.style.display = 'none';
		}

// 4. ä¿®æ”¹ updateSelectionCount å‡½æ•°ï¼Œç¡®ä¿æ­£ç¡®æ›´æ–°
		function updateSelectionCount() {
			// è®¡ç®—æ‹–æ‹½é€‰ä¸­çš„å…ƒç´ æ•°é‡
			const dragSelectedCount = State.elements.filter(el => el.dragSelected).length;
			const clickSelectedCount = State.clickSelectedIds.size;
			const totalSelected = dragSelectedCount + clickSelectedCount;
			
			if (totalSelected > 0) {
				selectionCount.textContent = `å·²é€‰æ‹© ${totalSelected} ä¸ªå…ƒç´ `;
				selectionCount.style.display = 'block';
				
				// æ€»æ˜¯æ˜¾ç¤ºæ‰¹é‡æ“ä½œæŒ‰é’®ï¼Œå½“æœ‰é€‰ä¸­å…ƒç´ æ—¶
				batchActionBar.style.display = 'flex';
				
				// è°ƒè¯•ä¿¡æ¯
				console.log(`é€‰æ‹©è®¡æ•°: æ‹–æ‹½é€‰ä¸­=${dragSelectedCount}, ç‚¹å‡»é€‰ä¸­=${clickSelectedCount}, æ€»è®¡=${totalSelected}`);
			} else {
				selectionCount.style.display = 'none';
				
				// åªæœ‰åœ¨æ²¡æœ‰ä»»ä½•é€‰ä¸­å…ƒç´ æ—¶æ‰éšè—æ‰¹é‡æ“ä½œæŒ‰é’®
				hideBatchActions();
			}
		}
		
		// è°ƒè¯•å‡½æ•°ï¼šæ˜¾ç¤ºæ¡†é€‰æ¡†å’Œå…ƒç´ çš„åæ ‡å¯¹æ¯”
		function debugSelectionCoordinates(screenLeft, screenTop, screenRight, screenBottom) {
			console.log('=== æ¡†é€‰åæ ‡è°ƒè¯• ===');
			console.log('æ¡†é€‰æ¡†å±å¹•åæ ‡:', {
				left: screenLeft,
				top: screenTop,
				right: screenRight,
				bottom: screenBottom,
				width: screenRight - screenLeft,
				height: screenBottom - screenTop
			});
			
			console.log('å½“å‰ç¼©æ”¾æ¯”ä¾‹:', Config.zoom * 100 + '%');
			
			// è¾“å‡ºæ‰€æœ‰å…ƒç´ çš„ä½ç½®ä¿¡æ¯
			State.elements.forEach((el, index) => {
				const screenX = el.x * Config.zoom;
				const screenY = el.y * Config.zoom;
				const screenWidth = el.width * Config.zoom;
				const screenHeight = el.height * Config.zoom;
				
				console.log(`å…ƒç´  ${index} (${el.content}):`, {
					é€»è¾‘åæ ‡: `(${el.x}, ${el.y})`,
					å±å¹•åæ ‡: `(${screenX.toFixed(1)}, ${screenY.toFixed(1)})`,
					å±å¹•å°ºå¯¸: `${screenWidth.toFixed(1)}x${screenHeight.toFixed(1)}`,
					æ˜¯å¦åœ¨æ¡†å†…: (
						screenX <= screenRight &&
						screenX + screenWidth >= screenLeft &&
						screenY <= screenBottom &&
						screenY + screenHeight >= screenTop
					)
				});
			});
		}
		
		
		

		function hideSelectionCount() {
			selectionCount.style.display = 'none';
		}

		function getElementAtPoint(logicX, logicY) {
			for (let i = State.elements.length - 1; i >= 0; i--) {
				const el = State.elements[i];
				
				// ä½¿ç”¨é€»è¾‘åæ ‡è¿›è¡Œç¢°æ’æ£€æµ‹
				if (logicX >= el.x && logicX <= el.x + el.width &&
					logicY >= el.y && logicY <= el.y + el.height) {
					return el;
				}
			}
			return null;
		}

		// ==================== äº‹ä»¶ç»“æŸå¤„ç† ====================
		function handleMouseUp() {
			// ç»“æŸç¼–è¾‘åŒºç§»åŠ¨
			if (Config.isPanning) {
				endEditorPan();
			}
			
			endDrag();
			endSelection();
			endDragSelection();
		}

		function handleTouchEnd() {
			// ç»“æŸç¼–è¾‘åŒºç§»åŠ¨
			if (Config.isPanning) {
				endEditorPan();
				Config.isPanning = false;
			}
			
			endDrag();
			endSelection();
			endDragSelection();
			State.pinchStartDistance = 0;
		}

		function endDrag() {
			if (Config.isDragging) {
				Config.isDragging = false;
				
				// æ¸…é™¤æ‰€æœ‰å…ƒç´ çš„æ‹–åŠ¨çŠ¶æ€
				State.elements.forEach(el => {
					el.element.classList.remove('dragging');
				});
				
				hideGuides();
			}
		}

		// ==================== å…¨å±€ç‚¹å‡»å¤„ç† ====================
function handleGlobalClick(e) {
	// ç‚¹å‡»å…¶ä»–åœ°æ–¹å…³é—­é¢æ¿
	const fontBtn = document.querySelector('.tool-btn[onclick="toggleFontPanel()"]');
	const alignBtn = document.querySelector('.tool-btn[onclick="toggleAlignPanel()"]');
	const nudgeBtn = document.querySelector('.tool-btn[onclick="toggleNudgePanel()"]');
	
	if (!fontControls.contains(e.target) && 
		!alignControls.contains(e.target) && 
		!nudgePanel.contains(e.target) &&
		e.target !== fontBtn && 
		!fontBtn?.contains(e.target) &&
		e.target !== alignBtn && 
		!alignBtn?.contains(e.target) &&
		e.target !== nudgeBtn && 
		!nudgeBtn?.contains(e.target)) {
		
		// ç‚¹å‡»ç¼–è¾‘åŒºç©ºç™½å¤„ï¼ˆeditorAreaï¼‰æ—¶å…³é—­æ‰€æœ‰é¢æ¿
		if (editorArea.contains(e.target) || e.target === editorArea) {
			closeAllPanels();
		}
	}
	
	// ç‚¹å‡»å…¶ä»–åœ°æ–¹å–æ¶ˆæ‰¹é‡æ“ä½œæ¨¡å¼
	if (Config.batchMoveMode && !editorArea.contains(e.target)) {
		exitBatchMoveMode();
	}
	
	// ç‚¹å‡»å…¶ä»–åœ°æ–¹éšè—ç¡®è®¤å¯¹è¯æ¡†
	if (!confirmDialog.contains(e.target) && confirmDialog.style.display === 'flex') {
		hideConfirmDialog();
	}
	
	// ç‚¹å‡»å…¶ä»–åœ°æ–¹éšè—æ–‡ä»¶åˆ—è¡¨å¯¹è¯æ¡†
	if (!fileListDialog.contains(e.target) && fileListDialog.style.display === 'flex') {
		hideFileList();
	}
	
	// ç‚¹å‡»å…¶ä»–åœ°æ–¹å…³é—­èœå•
	const menu = document.getElementById('dropdown-menu');
	const menuButton = document.querySelector('.dropdown-menu .tool-btn');
	
	if (menu && menu.classList.contains('show') && 
		!menu.contains(e.target) && 
		(!menuButton || !menuButton.contains(e.target))) {
		menu.classList.remove('show');
		Config.menuOpen = false;
		document.removeEventListener('click', closeMenuOnClickOutside);
	}
}

		// ==================== é”®ç›˜äº‹ä»¶ ====================
		function handleKeyDown(e) {
			// é˜²æ­¢é¡µé¢æ»šåŠ¨
			if (['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight', 'Delete', ' '].includes(e.key)) {
				e.preventDefault();
			}
			
			// æ£€æŸ¥æ˜¯å¦æŒ‰ä¸‹äº†Ctrlé”®
			const ctrlPressed = e.ctrlKey || e.metaKey;
			
			// å¤„ç†å¿«æ·é”®
			if (ctrlPressed) {
				switch (e.key.toLowerCase()) {
					case 'n':
						e.preventDefault();
						newFile();
						break;
					case 'o':
						e.preventDefault();
						showFileList();
						break;
					case 's':
						e.preventDefault();
						saveFile();
						break;
					case 'c':
						e.preventDefault();
						copySelected();
						break;
					case 'v':
						e.preventDefault();
						pasteElements();
						break;
					case 'z':
						e.preventDefault();
						// æ’¤é”€åŠŸèƒ½ï¼ˆæœªæ¥å¯ä»¥æ·»åŠ ï¼‰
						showStatusTip('æ’¤é”€åŠŸèƒ½å°†åœ¨åç»­ç‰ˆæœ¬ä¸­æ·»åŠ ');
						break;
					case 'y':
						e.preventDefault();
						// é‡åšåŠŸèƒ½ï¼ˆæœªæ¥å¯ä»¥æ·»åŠ ï¼‰
						showStatusTip('é‡åšåŠŸèƒ½å°†åœ¨åç»­ç‰ˆæœ¬ä¸­æ·»åŠ ');
						break;
					case 'g':
						e.preventDefault();
						toggleGrid();
						break;
					case 'a':
						e.preventDefault();
						toggleAlignPanel();
						break;
				}
			}
			
			switch (e.key) {
				case 'Delete':
					deleteSelected();
					break;
				case 'ArrowUp':
					nudgeSelected(0, -Config.nudgePrecision);
					break;
				case 'ArrowDown':
					nudgeSelected(0, Config.nudgePrecision);
					break;
				case 'ArrowLeft':
					nudgeSelected(-Config.nudgePrecision, 0);
					break;
				case 'ArrowRight':
					nudgeSelected(Config.nudgePrecision, 0);
					break;
				case ' ':
					// ç©ºæ ¼é”®åˆ‡æ¢ç¼–è¾‘åŒºç§»åŠ¨æ¨¡å¼
					if (!Config.keyboardActive) {
						toggleEditorPanMode();
					}
					break;
				case 'Escape':
					if (Config.clickSelectionMode) {
						toggleClickSelectionMode();
					} else if (Config.batchMoveMode) {
						exitBatchMoveMode();
					} else if (Config.keyboardActive) {
						cancelInput();
					} else if (Config.editorPanMode) {
						// ESCé”®é€€å‡ºç¼–è¾‘åŒºç§»åŠ¨æ¨¡å¼
						toggleEditorPanMode();
					} else {
						clearSelection();
						clearClickSelection();
						clearDragSelection();
					}
					closeAllPanels();
					if (confirmDialog.style.display === 'flex') {
						hideConfirmDialog();
					}
					if (fileListDialog.style.display === 'flex') {
						hideFileList();
					}
					// å¦‚æœèœå•æ‰“å¼€ï¼Œå…³é—­èœå•
					if (Config.menuOpen) {
						const menu = document.getElementById('dropdown-menu');
						if (menu) {
							menu.classList.remove('show');
							Config.menuOpen = false;
							document.removeEventListener('click', closeMenuOnClickOutside);
						}
					}
					break;
			}
		}
		
// ==================== PNGå›¾ç‰‡å¯¼å‡ºåŠŸèƒ½ ====================

// ä¿®æ”¹å¯¼å‡ºPNGå‡½æ•°
async function exportToPNG() {
	// æ£€æŸ¥å¯¼å‡ºæ¬¡æ•°é™åˆ¶ï¼ˆä¸“ä¸šç‰ˆä¸é™åˆ¶ï¼‰
	if (!UsageLimit.isProVersion()) {
		if (!UsageLimit.recordExport()) {
			return false;
		}
	}
	
	try {
		showLoading('æ­£åœ¨ç”ŸæˆPNGå›¾ç‰‡...');
		const canvas = await captureEditorToCanvas();
		downloadCanvasAsPNG(canvas);
		hideLoading();
		
		if (UsageLimit.isProVersion()) {
			showStatusTip('å¯¼å‡ºæˆåŠŸï¼ğŸ–ï¸ ä¸“ä¸šç‰ˆæ— é™åˆ¶');
		} else {
			const remaining = UsageLimit.getRemainingInfo();
			showStatusTip(`å¯¼å‡ºæˆåŠŸï¼ä»Šæ—¥è¿˜å¯å¯¼å‡º ${remaining.exports} æ¬¡`);
		}
		
	} catch (error) {
		hideLoading();
		showStatusTip('å¯¼å‡ºå¤±è´¥: ' + error.message);
	}
}


// æ•è·ç¼–è¾‘åŒºåŸŸä¸ºcanvas
async function captureEditorToCanvas() {
	const editorElement = document.getElementById('editor-area');
	
	// è®¾ç½®å¯¼å‡ºæ—¶çš„ä¸´æ—¶æ ·å¼
	const originalBackground = editorElement.style.background;
	editorElement.style.background = 'white';
	
	const canvas = await html2canvas(editorElement, {
		scale: 2, // 2å€åˆ†è¾¨ç‡ï¼Œä¿è¯æ¸…æ™°åº¦
		backgroundColor: '#ffffff',
		useCORS: true,
		logging: false,
		allowTaint: true,
		onclone: function(clonedDoc) {
			// åœ¨å…‹éš†çš„æ–‡æ¡£ä¸­éšè—ä¸éœ€è¦çš„å…ƒç´ 
			const clonedEditor = clonedDoc.getElementById('editor-area');
			if (clonedEditor) {
				clonedEditor.style.background = 'white';
				
				// éšè—ç½‘æ ¼çº¿ï¼ˆå¦‚æœéœ€è¦çš„è¯ï¼‰
				clonedEditor.style.backgroundImage = 'none';
			}
		}
	});
	
	// æ¢å¤åŸå§‹èƒŒæ™¯
	editorElement.style.background = originalBackground;
	
	return canvas;
}

// éšè—UIå…ƒç´ ä»¥ä¾¿æˆªå›¾
function hideUIElementsForExport() {
	const elementsToHide = [
		'.header-toolbar',
		'.symbols-scroll',
		'.keyboard-input-display',
		'.bottom-controls',
		'.keyboard-toggle',
		'.batch-action-bar',
		'.selection-count',
		'.mode-indicator',
		'.zoom-indicator',
		'.status-tip',
		'.autosave-indicator',
		'.guide-line',
		'.selection-box',
		'.drag-selection-box'
	];
	
	const originalStyles = {};
	
	elementsToHide.forEach(selector => {
		const elements = document.querySelectorAll(selector);
		elements.forEach(el => {
			originalStyles[selector] = {
				display: el.style.display,
				visibility: el.style.visibility
			};
			el.style.display = 'none';
			el.style.visibility = 'hidden';
		});
	});
	
	// éšè—é€‰ä¸­çŠ¶æ€
	const selectedElements = document.querySelectorAll('.math-element.selected, .math-element.editing');
	selectedElements.forEach(el => {
		el.dataset.originalOutline = el.style.outline;
		el.dataset.originalBackground = el.style.background;
		el.style.outline = 'none';
		el.style.background = 'transparent';
	});
	
	// éšè—ç½‘æ ¼ï¼ˆå¦‚æœå¼€å¯ï¼‰
	const gridEnabled = Config.gridEnabled;
	if (gridEnabled) {
		Config.gridEnabled = false;
		updateGrid();
	}
	
	return {
		originalStyles,
		selectedElements: selectedElements.length,
		gridWasEnabled: gridEnabled
	};
}

// æ¢å¤UIå…ƒç´ 
function restoreUIElements(originalState) {
	// æ¢å¤éšè—çš„å…ƒç´ 
	Object.keys(originalState.originalStyles).forEach(selector => {
		const elements = document.querySelectorAll(selector);
		elements.forEach(el => {
			const original = originalState.originalStyles[selector];
			el.style.display = original.display;
			el.style.visibility = original.visibility;
		});
	});
	
	// æ¢å¤é€‰ä¸­çŠ¶æ€
	document.querySelectorAll('.math-element.selected, .math-element.editing').forEach(el => {
		if (el.dataset.originalOutline) {
			el.style.outline = el.dataset.originalOutline;
			delete el.dataset.originalOutline;
		}
		if (el.dataset.originalBackground) {
			el.style.background = el.dataset.originalBackground;
			delete el.dataset.originalBackground;
		}
	});
	
	// æ¢å¤ç½‘æ ¼
	if (originalState.gridWasEnabled) {
		Config.gridEnabled = true;
		updateGrid();
	}
}

// ä¸‹è½½canvasä¸ºPNG
function downloadCanvasAsPNG(canvas) {
	// è½¬æ¢ä¸ºdata URL
	const dataUrl = canvas.toDataURL('image/png');
	
	// åˆ›å»ºä¸‹è½½é“¾æ¥
	const link = document.createElement('a');
	const fileName = Config.currentFileName || 'æ•°å­¦å…¬å¼';
	link.download = `${fileName}_${formatDate(new Date(), 'YYYYMMDD_HHmmss')}.png`;
	link.href = dataUrl;
	
	// æ·»åŠ åˆ°é¡µé¢å¹¶è§¦å‘ç‚¹å‡»
	document.body.appendChild(link);
	link.click();
	
	// æ¸…ç†
	setTimeout(() => {
		document.body.removeChild(link);
	}, 100);
}

// è¾…åŠ©å‡½æ•°ï¼šæ ¼å¼åŒ–æ—¥æœŸ
function formatDate(date, format = 'YYYY-MM-DD HH:mm:ss') {
	const d = new Date(date);
	const year = d.getFullYear();
	const month = String(d.getMonth() + 1).padStart(2, '0');
	const day = String(d.getDate()).padStart(2, '0');
	const hours = String(d.getHours()).padStart(2, '0');
	const minutes = String(d.getMinutes()).padStart(2, '0');
	const seconds = String(d.getSeconds()).padStart(2, '0');
	
	return format
		.replace('YYYY', year)
		.replace('MM', month)
		.replace('DD', day)
		.replace('HH', hours)
		.replace('mm', minutes)
		.replace('ss', seconds);
}		
		
		
		

		// ==================== åˆå§‹åŒ– ====================
		function init() {
			// è®¾ç½®ç¼–è¾‘åŒºåŸŸå°ºå¯¸
			editorArea.style.width = '2000px';
			editorArea.style.height = '2000px';
			
			// åˆå§‹æ»šåŠ¨ä½ç½®ï¼ˆå±…ä¸­ï¼‰
			editorContainer.scrollLeft = 900;
			editorContainer.scrollTop = 900;
			
			// åˆå§‹åŒ–å¾®è°ƒé¢æ¿æ‹–æ‹½åŠŸèƒ½
			setTimeout(() => {
				initNudgePanelDrag();
				loadPanelPosition(); // åŠ è½½ä¿å­˜çš„ä½ç½®
			}, 100);
			
			// åˆå§‹åŒ–å­—ä½“ç›¸å…³é…ç½®
			if (!Config.recentFontSizes) {
				Config.recentFontSizes = [];
			}
			
			if (!Config.fontSizeHistory) {
				Config.fontSizeHistory = [];
			}
			
			// åˆå§‹åŒ–é¢æ¿å…³é—­ç›‘å¬
			initPanelCloseListeners();
			
			// åŠ è½½è®¾ç½®ï¼ˆåŒ…æ‹¬ä¸Šæ¬¡å­—ä½“å¤§å°ï¼‰
			loadSettings();
			
			// åˆå§‹åŒ–å­—ä½“æ»‘å—äº‹ä»¶
			initFontSliderEvents();
			
			// åˆ›å»ºç¤ºä¾‹å…¬å¼
			setTimeout(() => createExampleFormula(), 100);
			
			// è®¾ç½®è‡ªåŠ¨ä¿å­˜
			setupAutosave();
			
			// æ›´æ–°UI
			updateGrid();
			updateGridButton();
			updateZoomIndicator();
			updateFileInfo();
			updateFontPresetButtons();
			updateAllElementsDisplay();  // ç¡®ä¿æ˜¾ç¤ºæ­£ç¡®
			
			// ç»‘å®šäº‹ä»¶
			bindEvents();
			
			// æ£€æµ‹å­˜å‚¨ç±»å‹
			const storageType = StorageManager.getStorageType();
			console.log('å­˜å‚¨ç±»å‹:', storageType);
			
			if (storageType === 'browser') {
				showStatusTip('ä½¿ç”¨æµè§ˆå™¨å­˜å‚¨ï¼Œæ–‡ä»¶å°†ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨å¹¶æä¾›ä¸‹è½½');
			};
			// å¯åŠ¨ä½¿ç”¨ç›‘æ§ï¼ˆä¸“ä¸šç‰ˆä¸ç›‘æ§ï¼‰
			initUsageMonitor();
	
			// åº”ç”¨ä¸“ä¸šç‰ˆåŠŸèƒ½
			UsageLimit.applyProFeatures();
	
			// æ¯30ç§’æ›´æ–°ä¸€æ¬¡æ–‡ä»¶ä¿¡æ¯
			setInterval(updateFileInfo, 30000);
			
			// å¯åŠ¨å¹¿å‘Šç³»ç»Ÿï¼ˆä¸“ä¸šç‰ˆä¸æ˜¾ç¤ºå¹¿å‘Šï¼‰
			//if (!UsageLimit.isProVersion() && typeof SimpleAdSystem !== 'undefined') {
			//SimpleAdSystem.init();
			
// åœ¨ init() å‡½æ•°ä¸­æ‰¾åˆ°å¹¿å‘Šç³»ç»Ÿåˆå§‹åŒ–éƒ¨åˆ†ï¼Œæ›¿æ¢ä¸ºï¼š
						// å¯åŠ¨å¹¿å‘Šç³»ç»Ÿï¼ˆä»…åœ¨å…è´¹ç‰ˆï¼‰
			if (!UsageLimit.isProVersion()) {
				// åˆå§‹åŒ–å¹¿å‘Šç³»ç»Ÿ
				AdSystem.init();
				
				// å°†å¹¿å‘Šæ§åˆ¶æ·»åŠ åˆ°æµ‹è¯•é¢æ¿
				setTimeout(() => {
					AdSystem.addAdControlsToTestPanel();
				}, 1000);
			};

			
			
			
	

			
	}	

		// åˆå§‹åŒ–å­—ä½“æ»‘å—äº‹ä»¶å‡½æ•°
		function initFontSliderEvents() {
			// ç¡®ä¿å­—ä½“æ»‘å—æœ‰åˆå§‹å€¼
			if (fontSlider) {
				// ä»è®¾ç½®ä¸­è·å–ä¸Šæ¬¡ä½¿ç”¨çš„å­—ä½“å¤§å°ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨24ï¼ˆä»…ä½œä¸ºåˆå§‹å€¼ï¼‰
				const lastFontSize = Config.lastFontSize || 24;
				fontSlider.value = lastFontSize;
				fontSizeDisplay.textContent = lastFontSize + 'px';
				
				// åˆå§‹åŒ–å­—ä½“å†å²è®°å½•
				if (Config.fontSizeHistory.length === 0) {
					// åˆå§‹æ—¶åªæ˜¾ç¤ºå½“å‰å€¼
					Config.fontSizeHistory = [lastFontSize];
				}
				
				// åˆå§‹åŒ–é¢„è®¾æŒ‰é’®
				updateFontPresetButtons(lastFontSize);
				
				// ä¿®æ”¹å­—ä½“æ»‘å—äº‹ä»¶ç›‘å¬ï¼Œç¡®ä¿å®æ—¶æ›´æ–°
				fontSlider.addEventListener('input', function(e) {
					updateFontSize(this.value);
				});
				
				// ä¿®æ”¹å­—ä½“æ»‘å—é¼ æ ‡äº‹ä»¶ï¼Œç¡®ä¿å®æ—¶æ›´æ–°
				fontSlider.addEventListener('mousedown', function() {
					this.isDragging = true;
				});
				
				fontSlider.addEventListener('mouseup', function() {
					if (this.isDragging) {
						this.isDragging = false;
						// æ‹–åŠ¨ç»“æŸæ—¶ä¿å­˜å½“å‰å­—ä½“å¤§å°
						const fontSize = parseInt(this.value);
						saveCurrentFontSize(fontSize);
					}
				});
				
				// æ·»åŠ è§¦æ‘¸äº‹ä»¶æ”¯æŒ
				fontSlider.addEventListener('touchstart', function() {
					this.isDragging = true;
				});
				
				fontSlider.addEventListener('touchend', function() {
					if (this.isDragging) {
						this.isDragging = false;
						const fontSize = parseInt(this.value);
						saveCurrentFontSize(fontSize);
					}
				});
			}
		}

		function bindEvents() {
			// é¼ æ ‡äº‹ä»¶
			editorArea.addEventListener('mousedown', handleAreaMouseDown);
			editorContainer.addEventListener('wheel', handleWheel, { passive: false });
			
			// è§¦æ‘¸äº‹ä»¶
			editorArea.addEventListener('touchstart', handleAreaTouchStart, { passive: false });
			editorContainer.addEventListener('touchmove', handleContainerTouchMove, { passive: false });
			editorContainer.addEventListener('touchend', handleTouchEnd);
			
			// æ–°å¢æåˆç¼©æ”¾äº‹ä»¶
			editorArea.addEventListener('touchstart', function(e) {
				if (e.touches.length === 2) {
					handlePinchStart(e);
				}
			}, { passive: false });
			
			editorContainer.addEventListener('touchmove', function(e) {
				if (isPinching && e.touches.length === 2) {
					handlePinchMove(e);
				}
			}, { passive: false });
			
			document.addEventListener('touchend', function(e) {
				if (isPinching) {
					handlePinchEnd();
				}
			});
			
			// å…¨å±€äº‹ä»¶
			document.addEventListener('mousemove', handleMouseMove);
			document.addEventListener('mouseup', handleMouseUp);
			document.addEventListener('keydown', handleKeyDown);
			
			// é˜»æ­¢æ–‡æœ¬é€‰æ‹©
			document.addEventListener('selectstart', e => e.preventDefault());
			
			// ç‚¹å‡»å…¶ä»–åœ°æ–¹å…³é—­é¢æ¿
			document.addEventListener('mousedown', handleGlobalClick);
			document.addEventListener('touchstart', handleGlobalClick);
			
			// ç›‘å¬textareaçš„é”®ç›˜äº‹ä»¶
			inputTextbox.addEventListener('keydown', function(e) {
				// å¤„ç†å›è½¦ç¡®è®¤ï¼ŒESCå–æ¶ˆ
				if (e.key === 'Enter' && !e.shiftKey) {
					e.preventDefault();
					confirmInput();
				} else if (e.key === 'Escape') {
					e.preventDefault();
					cancelInput();
				}
			});
			
			// å®æ—¶æ›´æ–°æ­£åœ¨ç¼–è¾‘çš„å…ƒç´ 
			inputTextbox.addEventListener('input', function() {
				if (State.editingElement) {
					State.editingElement.content = inputTextbox.value;
					State.editingElement.element.textContent = inputTextbox.value;
					updateElementDisplay(State.editingElement);
				}
			});
		}

		// ==================== ç¤ºä¾‹å…¬å¼ ====================
		function createExampleFormula() {
			// è®°å½•å­—ä½“ä½¿ç”¨
			recordFontSizeUsage(32);
			recordFontSizeUsage(28);
			recordFontSizeUsage(24);
			recordFontSizeUsage(20);
			recordFontSizeUsage(36);
			
			// E = mcÂ²
			createElement('E', 100, 100, { fontSize: 32 });
			createElement('=', 150, 100, { fontSize: 28 });
			createElement('m', 200, 100, { fontSize: 28 });
			createElement('c', 240, 100, { fontSize: 28 });
			createElement('Â²', 265, 85, { fontSize: 20 });
			
			// æ·»åŠ æ›´å¤šç¤ºä¾‹å…ƒç´ ç”¨äºæµ‹è¯•æ¡†é€‰
			createElement('âˆ«', 100, 200, { fontSize: 36 });
			createElement('xÂ²', 150, 200, { fontSize: 28 });
			createElement('dx', 210, 200, { fontSize: 24 });
			createElement('âˆ‘', 100, 300, { fontSize: 36 });
			createElement('n', 150, 300, { fontSize: 28 });
			createElement('i=1', 180, 285, { fontSize: 20 });
			
			// æ›´æ–°å­—ä½“é¢„è®¾æŒ‰é’®
			updateFontPresetButtons();
		}

		// ==================== å¯¼å‡ºåŠŸèƒ½ï¼ˆç¤ºä¾‹ï¼‰ ====================
		function exportAsImage() {
			handleMenuItemClick(); // å…³é—­èœå•
			showStatusTip('å¯¼å‡ºå›¾ç‰‡åŠŸèƒ½å°†åœ¨åç»­ç‰ˆæœ¬ä¸­æ·»åŠ ');
		}

		// é¡µé¢å¸è½½å‰æç¤ºä¿å­˜
		window.addEventListener('beforeunload', function(e) {
			if (Config.hasUnsavedChanges) {
				const message = 'æ‚¨æœ‰æœªä¿å­˜çš„æ›´æ”¹ã€‚ç¡®å®šè¦ç¦»å¼€å—ï¼Ÿ';
				e.returnValue = message;
				return message;
			}
		});
		
		// è°ƒè¯•å‡½æ•°ï¼šæ£€æŸ¥åæ ‡è½¬æ¢ï¼ˆå¯é€‰ï¼‰
function debugCoordinateConversion(clientX, clientY) {
	const rect = editorArea.getBoundingClientRect();
	const relativeX = clientX - rect.left;
	const relativeY = clientY - rect.top;
	
	const logicPos = CoordinateSystem.screenToLogic(clientX, clientY);
	const screenPos = CoordinateSystem.logicToScreen(logicPos.x, logicPos.y);
	
	console.log(`è°ƒè¯•åæ ‡è½¬æ¢:
	åŸå§‹åæ ‡: (${clientX}, ${clientY})
	ç›¸å¯¹äºeditorArea: (${relativeX.toFixed(2)}, ${relativeY.toFixed(2)})
	é€»è¾‘åæ ‡: (${logicPos.x.toFixed(2)}, ${logicPos.y.toFixed(2)})
	è½¬å›å±å¹•: (${screenPos.x.toFixed(2)}, ${screenPos.y.toFixed(2)})
	ç¼©æ”¾æ¯”ä¾‹: ${Config.zoom * 100}%
	æ»šåŠ¨ä½ç½®: (${editorContainer.scrollLeft}, ${editorContainer.scrollTop})`);
}
		
function debugSelectionStatus() {
	const dragSelected = State.elements.filter(el => el.dragSelected).length;
	const clickSelected = State.clickSelectedIds.size;
	const totalSelected = dragSelected + clickSelected;
	
	console.log(`é€‰æ‹©çŠ¶æ€è°ƒè¯•:
	- Dragé€‰ä¸­: ${dragSelected} ä¸ªå…ƒç´ 
	- Clické€‰ä¸­: ${clickSelected} ä¸ªå…ƒç´ 
	- æ€»è®¡é€‰ä¸­: ${totalSelected} ä¸ªå…ƒç´ 
	- ç¼©æ”¾æ¯”ä¾‹: ${Config.zoom * 100}%
	- æ‰¹é‡æ“ä½œæŒ‰é’®æ˜¾ç¤º: ${batchActionBar.style.display}`);
}	

// ==================== å¹¿å‘Šç³»ç»Ÿ ====================
// ==================== å®Œæ•´å¹¿å‘Šç³»ç»Ÿ ====================
// ==================== å®Œæ•´å¹¿å‘Šç³»ç»Ÿ ====================
// ==================== æœ€ç®€å•çš„å¹¿å‘Šç³»ç»Ÿ ====================
// ==================== å¸¦é“¾æ¥è·³è½¬çš„å¹¿å‘Šç³»ç»Ÿ ====================
const AdSystem = {
	// åŸºç¡€é…ç½®
	adConfig: {
		enabled: true,
		refreshInterval: 10000, // 10ç§’ä¸€æ¬¡
		adPlacements: ['top-left', 'top-right']
	},
	
	// å¸¦é“¾æ¥çš„å¹¿å‘Šå†…å®¹
	adContents: [
		{ 
			id: 1, 
			title: "å‡çº§ä¸“ä¸šç‰ˆ", 
			content: "è§£é”æ‰€æœ‰åŠŸèƒ½", 
			icon: "ğŸ”§",
			link: "https://ningchaojie.github.io"
		},
		{ 
			id: 2, 
			title: "æ•°å­¦è¯¾ç¨‹", 
			content: "åå¸ˆåœ¨çº¿æŒ‡å¯¼", 
			icon: "ğŸ“",
			link: "https://ningchaojie.github.io"
		},
		{ 
			id: 3, 
			title: "æ•°å­¦å·¥å…·", 
			content: "æå‡å­¦ä¹ æ•ˆç‡", 
			icon: "ğŸ§®",
			link: "https://e.tb.cn/h.7OBJNA3SnYFXa2z?tk=nZzBU4cYSs4 CZ225"
		}
	],
	
	adCount: 0,
	adTimer: null,
	
	// åˆå§‹åŒ–
	init() {
		if (UsageLimit && UsageLimit.isProVersion && UsageLimit.isProVersion()) {
			console.log('ä¸“ä¸šç‰ˆï¼Œä¸æ˜¾ç¤ºå¹¿å‘Š');
			return;
		}
		
		console.log('å¹¿å‘Šç³»ç»Ÿåˆå§‹åŒ–');
		
		setTimeout(() => this.showRandomAd(), 3000);
		
		this.adTimer = setInterval(() => {
			this.showRandomAd();
		}, this.adConfig.refreshInterval);
	},
	
	// æ˜¾ç¤ºéšæœºå¹¿å‘Š
	showRandomAd() {
		const ad = this.adContents[Math.floor(Math.random() * this.adContents.length)];
		const position = this.adConfig.adPlacements[Math.floor(Math.random() * this.adConfig.adPlacements.length)];
		
		if (position === 'top-left') {
			this.showTopLeftAd(ad);
		} else {
			this.showTopRightAd(ad);
		}
		
		this.adCount++;
	},
	
	// å·¦ä¸Šè§’å¹¿å‘Š
	showTopLeftAd(ad) {
		const adDiv = document.createElement('div');
		adDiv.id = 'ad-top-left';
		adDiv.style.cssText = `
			position: fixed;
			top: 70px;
			left: 10px;
			background: #FF9800;
			color: white;
			padding: 10px;
			border-radius: 8px;
			z-index: 999;
			font-size: 14px;
			cursor: pointer;
			max-width: 200px;
			box-shadow: 0 2px 10px rgba(0,0,0,0.2);
			transition: transform 0.2s;
		`;
		
		adDiv.innerHTML = `
			<div style="display: flex; align-items: center; gap: 8px;">
				<div style="font-size: 20px;">${ad.icon}</div>
				<div>
					<div style="font-weight: bold;">${ad.title}</div>
					<div style="font-size: 12px;">${ad.content}</div>
				</div>
			</div>
		`;
		
		// æ‚¬åœæ•ˆæœ
		adDiv.onmouseover = () => adDiv.style.transform = 'scale(1.05)';
		adDiv.onmouseout = () => adDiv.style.transform = 'scale(1)';
		
		// ç‚¹å‡»äº‹ä»¶ - ç›´æ¥è·³è½¬
		adDiv.onclick = () => {
			// è®°å½•ç‚¹å‡»
			this.recordClick(ad.id);
			
			// æ–°çª—å£æ‰“å¼€é“¾æ¥
			window.open(ad.link, '_blank');
			
			// ç§»é™¤å¹¿å‘Š
			document.body.removeChild(adDiv);
		};
		
		// ç§»é™¤æ—§å¹¿å‘Š
		const oldAd = document.getElementById('ad-top-left');
		if (oldAd) document.body.removeChild(oldAd);
		
		document.body.appendChild(adDiv);
		
		setTimeout(() => {
			if (adDiv.parentNode) {
				document.body.removeChild(adDiv);
			}
		}, 10000);
	},
	
	// å³ä¸Šè§’å¹¿å‘Š
	showTopRightAd(ad) {
		const adDiv = document.createElement('div');
		adDiv.id = 'ad-top-right';
		adDiv.style.cssText = `
			position: fixed;
			top: 70px;
			right: 10px;
			background: #2196F3;
			color: white;
			padding: 10px;
			border-radius: 8px;
			z-index: 999;
			font-size: 14px;
			cursor: pointer;
			max-width: 200px;
			box-shadow: 0 2px 10px rgba(0,0,0,0.2);
			transition: transform 0.2s;
		`;
		
		adDiv.innerHTML = `
			<div style="display: flex; align-items: center; gap: 8px;">
				<div style="font-size: 20px;">${ad.icon}</div>
				<div>
					<div style="font-weight: bold;">${ad.title}</div>
					<div style="font-size: 12px;">${ad.content}</div>
				</div>
			</div>
		`;
		
		// æ‚¬åœæ•ˆæœ
		adDiv.onmouseover = () => adDiv.style.transform = 'scale(1.05)';
		adDiv.onmouseout = () => adDiv.style.transform = 'scale(1)';
		
		// ç‚¹å‡»äº‹ä»¶ - ç›´æ¥è·³è½¬
		adDiv.onclick = () => {
			// è®°å½•ç‚¹å‡»
			this.recordClick(ad.id);
			
			// æ–°çª—å£æ‰“å¼€é“¾æ¥
			window.open(ad.link, '_blank');
			
			// ç§»é™¤å¹¿å‘Š
			document.body.removeChild(adDiv);
		};
		
		// ç§»é™¤æ—§å¹¿å‘Š
		const oldAd = document.getElementById('ad-top-right');
		if (oldAd) document.body.removeChild(oldAd);
		
		document.body.appendChild(adDiv);
		
		setTimeout(() => {
			if (adDiv.parentNode) {
				document.body.removeChild(adDiv);
			}
		}, 10000);
	},
	
	// è®°å½•ç‚¹å‡»ç»Ÿè®¡
	recordClick(adId) {
		console.log(`å¹¿å‘Šç‚¹å‡»è®°å½•: ID=${adId}`);
		try {
			const clicks = JSON.parse(localStorage.getItem('ad_clicks') || '{}');
			clicks[adId] = (clicks[adId] || 0) + 1;
			localStorage.setItem('ad_clicks', JSON.stringify(clicks));
		} catch (e) {
			console.log('ç‚¹å‡»è®°å½•å¤±è´¥:', e);
		}
	},
	
	// ç§»é™¤æ‰€æœ‰å¹¿å‘Š
	removeAllAds() {
		const ads = document.querySelectorAll('[id^="ad-"]');
		ads.forEach(ad => {
			if (ad.parentNode) {
				document.body.removeChild(ad);
			}
		});
	}
};

// é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
window.addEventListener('load', () => {
	setTimeout(() => {
		AdSystem.init();
	}, 1000);
});
	

		// ==================== å¯åŠ¨åº”ç”¨ ====================
		window.onload = init;
	</script>
</body>
</html>		
		
		